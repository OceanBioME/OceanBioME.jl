var documenterSearchIndex = {"docs":
[{"location":"appendix/library/#library_api","page":"Library","title":"Library","text":"","category":"section"},{"location":"appendix/library/","page":"Library","title":"Library","text":"Documenting the user interface.","category":"page"},{"location":"appendix/library/#OceanBioME.jl","page":"Library","title":"OceanBioME.jl","text":"","category":"section"},{"location":"appendix/library/","page":"Library","title":"Library","text":"Modules = [OceanBioME]\nprivate = false","category":"page"},{"location":"appendix/library/#OceanBioME.OceanBioME","page":"Library","title":"OceanBioME.OceanBioME","text":"A fast and flexible modelling environment for modelling the coupled interactions between ocean biogeochemistry, carbonate chemistry, and physics.\n\n\n\n\n\n","category":"module"},{"location":"appendix/library/#OceanBioME.ScaleNegativeTracers-Tuple{}","page":"Library","title":"OceanBioME.ScaleNegativeTracers","text":"ScaleNegativeTracers(; tracers, scalefactors = ones(length(tracers)), warn = false)\n\nReturns a callback that scales tracers so that none are negative. Use like:\n\nnegativity_protection! = ScaleNegativeTracers(; model, tracers = (:P, :Z, :N))\nsimulation.callbacks[:neg] = Callback(negativity_protection!; callsite = UpdateStateCallsite())\n\nThis method is better, though still imperfect, method to prevent numerical errors that lead to negative tracer values compared to zero_negative_tracers!. Please see discussion in github.\n\nFuture plans include implement a positivity-preserving timestepping scheme as the ideal alternative.\n\n\n\n\n\n","category":"method"},{"location":"appendix/library/#OceanBioME.error_on_neg!-Tuple{Any}","page":"Library","title":"OceanBioME.error_on_neg!","text":"error_on_neg(sim; params = (exclude=(), ))\n\nThrows an error if any tracers in sim.model are negative. Use like:\n\nsimulation.callbacks[:neg] = Callback(error_on_neg!)\n\nTracers to exclude can be set in the parameters.\n\n\n\n\n\n","category":"method"},{"location":"appendix/library/#OceanBioME.remove_NaN_tendencies!-Tuple{Any}","page":"Library","title":"OceanBioME.remove_NaN_tendencies!","text":"remove_NaN_tendencies!(model)\n\nZeros any NaN value tendencies as a final protection against negative tracer run away.\n\n\n\n\n\n","category":"method"},{"location":"appendix/library/#OceanBioME.warn_on_neg!-Tuple{Any}","page":"Library","title":"OceanBioME.warn_on_neg!","text":"warn_on_neg(sim; params = (exclude=(), ))\n\nRaises a warning if any tracers in sim.model are negative. Use like:\n\nsimulation.callbacks[:neg] = Callback(warn_on_neg!)\n\nTracers to exclude can be set in the parameters.\n\n\n\n\n\n","category":"method"},{"location":"appendix/library/#OceanBioME.zero_negative_tracers!-Tuple{Any}","page":"Library","title":"OceanBioME.zero_negative_tracers!","text":"zero_negative_tracers!(sim; params = (exclude=(), ))\n\nSets any tracers in sim.model which are negative to zero. Use like:\n\nsimulation.callbacks[:neg] = Callback(zero_negative_tracers!)\n\nTracers to exclude can be set in the parameters.\n\ndanger: Tracer conservation\nThis method is not recommended as a way to preserve positivity of tracers since it does not conserve the total tracer.\n\n\n\n\n\n","category":"method"},{"location":"appendix/library/#Biogeochemical-Models","page":"Library","title":"Biogeochemical Models","text":"","category":"section"},{"location":"appendix/library/#Nutrient-Phytoplankton-Zooplankton-Detritus","page":"Library","title":"Nutrient Phytoplankton Zooplankton Detritus","text":"","category":"section"},{"location":"appendix/library/","page":"Library","title":"Library","text":"Modules = [OceanBioME.NPZDModel]\nprivate = false","category":"page"},{"location":"appendix/library/#OceanBioME.NPZDModel","page":"Library","title":"OceanBioME.NPZDModel","text":"Nutrient-Phytoplankton-Zooplankton-Detritus model of Kuhn et al. (2015).\n\nTracers\n\nNutrients: N (mmol N/m³)\nPhytoplankton: P (mmol N/m³)\nZooplankton: Z (mmol N/m³)\nDetritus: D (mmol N/m³)\n\nRequired submodels\n\nPhotosynthetically available radiation: PAR (W/m²)\n\n\n\n\n\n","category":"module"},{"location":"appendix/library/#OceanBioME.NPZDModel.NutrientPhytoplanktonZooplanktonDetritus-Union{Tuple{}, Tuple{P}, Tuple{S}, Tuple{LA}, Tuple{FT}} where {FT, LA, S, P}","page":"Library","title":"OceanBioME.NPZDModel.NutrientPhytoplanktonZooplanktonDetritus","text":"NutrientPhytoplanktonZooplanktonDetritus(; grid,\n                                           initial_photosynthetic_slope::FT = 0.1953 / day, # 1/(W/m²)/s\n                                           base_maximum_growth::FT = 0.6989 / day, # 1/s\n                                           nutrient_half_saturation::FT = 2.3868, # mmol N/m³\n                                           base_respiration_rate::FT = 0.066 / day, # 1/s/(mmol N / m³)\n                                           phyto_base_mortality_rate::FT = 0.0101 / day, # 1/s/(mmol N / m³)\n                                           maximum_grazing_rate::FT = 2.1522 / day, # 1/s\n                                           grazing_half_saturation::FT = 0.5573, # mmol N/m³\n                                           assimulation_efficiency::FT = 0.9116,\n                                           base_excretion_rate::FT = 0.0102 / day, # 1/s/(mmol N / m³)\n                                           zoo_base_mortality_rate::FT = 0.3395 / day, # 1/s/(mmol N / m³)²\n                                           remineralization_rate::FT = 0.1213 / day, # 1/s\n\n                                           surface_phytosynthetically_active_radiation = (x, y, t) -> 100 * max(0.0, cos(t * π / 12hours)),\n                                           light_attenuation_model::LA =\n                                               TwoBandPhotosyntheticallyActiveRadiation(; grid,\n                                                                                          surface_PAR = surface_phytosynthetically_active_radiation),\n                                          sediment_model::S = nothing,\n\n                                           sinking_speeds = (P = 0.2551/day, D = 2.7489/day),\n                                           open_bottom::Bool = true,\n\n                                           particles::P = nothing)\n\nConstruct a Nutrient-Phytoplankton-Zooplankton-Detritus (NPZD) biogeochemical model.\n\nKeyword Arguments\n\ngrid: (required) the geometry to build the model on, required to calculate sinking\ninitial_photosynthetic_slope, ..., remineralization_rate: NPZD parameter values\nsurface_phytosynthetically_active_radiation: funciton (or array in the future) for the photosynthetically available radiation at the surface, should be shape f(x, y, t)\nlight_attenuation_model: light attenuation model which integrated the attenuation of available light\nsediment_model: slot for AbstractSediment\nsinking_speed: named tuple of constant sinking, of fields (i.e. ZFaceField(...)) for any tracers which sink (convention is that a sinking speed is positive, but a field will need to follow the usual down being negative)\nopen_bottom: should the sinking velocity be smoothly brought to zero at the bottom to prevent the tracers leaving the domain\nparticles: slot for BiogeochemicalParticles\n\nExample\n\njulia> using OceanBioME\n\njulia> using Oceananigans\n\njulia> grid = RectilinearGrid(size=(20, 30), extent=(200, 200), topology=(Bounded, Flat, Bounded));\n\njulia> model = NutrientPhytoplanktonZooplanktonDetritus(; grid)\nNutrient Phytoplankton Zooplankton Detritus model (Float64) \n Light Attenuation Model: \n    └── Two-band light attenuation model (Float64)\n Sinking Velocities:\n    ├── P: 0.0 to -2.9525462962962963e-6 m/s \n    └── D: 0.0 to -3.181597222222222e-5 m/s\n\n\n\n\n\n","category":"method"},{"location":"appendix/library/#The-Lodyc-DAMTP-Ocean-Biogeochemical-Simulation-Tools-for-Ecosystem-and-Resources-(LOBSTER)","page":"Library","title":"The Lodyc-DAMTP Ocean Biogeochemical Simulation Tools for Ecosystem and Resources (LOBSTER)","text":"","category":"section"},{"location":"appendix/library/","page":"Library","title":"Library","text":"Modules = [OceanBioME.LOBSTERModel]\nprivate = true","category":"page"},{"location":"appendix/library/#OceanBioME.LOBSTERModel","page":"Library","title":"OceanBioME.LOBSTERModel","text":"The Lodyc-DAMTP Ocean Biogeochemical Simulation Tools for Ecosystem and Resources (LOBSTER) model.\n\nTracers\n\nNitrates: NO₃ (mmol N/m³)\nAmmonia: NH₄ (mmol N/m³)\nPhytoplankton: P (mmol N/m³)\nZooplankton: Z (mmol N/m³)\nSmall (slow sinking) particulate organic matter: sPOM (mmol N/m³)\nLarge (fast sinking) particulate organic matter: bPOM (mmol N/m³)\nDisolved organic matter: DOM (mmol N/m³)\n\nOptional tracers\n\nCarbonate chemistry\n\nDisolved inorganic carbon: DIC (mmol C/m³)\nAlkalinity: Alk (meq/m³)\n\nOxygen chemistry\n\nOxygen: O₂ (mmol O₂/m³)\n\nVariable redfield\n\nSmall (slow sinking) particulate organic matter carbon content: sPOC (mmol C/m³)\nLarge (fast sinking) particulate organic matter carbon content: bPOC (mmol C/m³)\nDisolved organic matter carbon content: DOC (mmol C/m³)\nWhen this option is enabled then the usual sPOM and bPOM change to sPON and bPON as they explicitly represent the nitrogen contained in the particulate matter\n\nRequired submodels\n\nPhotosynthetically available radiation: PAR (W/m²)\n\nFor optional tracers:\n\nTemperature: T (ᵒC)\nSalinity: S (‰)\n\n\n\n\n\n","category":"module"},{"location":"appendix/library/#OceanBioME.LOBSTERModel.LOBSTER-Union{Tuple{}, Tuple{P}, Tuple{S}, Tuple{LA}, Tuple{FT}} where {FT, LA, S, P}","page":"Library","title":"OceanBioME.LOBSTERModel.LOBSTER","text":"LOBSTER(; grid,\n          phytoplankton_preference::FT = 0.5,\n          maximum_grazing_rate::FT = 9.26e-6, # 1/s\n          grazing_half_saturation::FT = 1.0, # mmol N/m³\n          light_half_saturation::FT = 33.0, # W/m² (?)\n          nitrate_ammonia_inhibition::FT = 3.0,\n          nitrate_half_saturation::FT = 0.7, # mmol N/m³\n          ammonia_half_saturation::FT = 0.001, # mmol N/m³\n          maximum_phytoplankton_growthrate::FT = 1.21e-5, # 1/s\n          zooplankton_assimilation_fraction::FT = 0.7,\n          zooplankton_mortality::FT = 2.31e-6, # 1/s/mmol N/m³\n          zooplankton_excretion_rate::FT = 5.8e-7, # 1/s\n          phytoplankton_mortality::FT = 5.8e-7, # 1/s\n          small_detritus_remineralisation_rate::FT = 5.88e-7, # 1/s\n          large_detritus_remineralisation_rate::FT = 5.88e-7, # 1/s\n          phytoplankton_exudation_fraction::FT = 0.05,\n          nitrifcaiton_rate::FT = 5.8e-7, # 1/s\n          ammonia_fraction_of_exudate::FT = 0.75,\n          ammonia_fraction_of_excriment::FT = 0.5,\n          ammonia_fraction_of_detritus::FT = 0.0,\n          phytoplankton_redfield::FT = 6.56, # mol C/mol N\n          organic_redfield::FT = 6.56, # mol C/mol N\n          phytoplankton_chlorophyll_ratio::FT = 1.31, # g Chl/mol N\n          organic_carbon_calcate_ratio::FT = 0.1, # mol CaCO₃/mol C\n          respiraiton_oxygen_nitrogen_ratio::FT = 10.75, # mol O/molN\n          nitrifcation_oxygen_nitrogen_ratio::FT = 2.0, # mol O/molN\n          slow_sinking_mortality_fraction::FT = 0.5,\n          fast_sinking_mortality_fraction::FT = 0.5,\n          disolved_organic_breakdown_rate::FT = 3.86e-7, # 1/s\n          zooplankton_calcite_dissolution::FT = 0.3,\n\n          surface_phytosynthetically_active_radiation::SPAR = (x, y, t) -> 100*max(0.0, cos(t*π/(12hours))),\n\n          light_attenuation_model::LA =\n              TwoBandPhotosyntheticallyActiveRadiation(; grid,\n                                                         surface_PAR = surface_phytosynthetically_active_radiation),\n          sediment_model::S = nothing,\n\n          carbonates::Bool = false,\n          oxygen::Bool = false,\n          variable_redfield = false,\n\n          sinking_speed = (sPOM = 3.47e-5, bPOM = 200/day),\n          open_bottom::Bool = true,\n\n          particles::P = nothing)\n\nConstruct an instance of the LOBSTER biogeochemical model.\n\nKeyword Arguments\n\ngrid: (required) the geometry to build the model on, required to calculate sinking\nphytoplankton_preference, ..., disolved_organic_breakdown_rate: LOBSTER parameter values\nsurface_phytosynthetically_active_radiation: funciton (or array in the future) for the photosynthetically available radiation at the surface, should be shape f(x, y, t)\nlight_attenuation_model: light attenuation model which integrated the attenuation of available light\nsediment_model: slot for AbstractSediment\ncarbonates, oxygen, and variable_redfield: include models for carbonate chemistry and/or oxygen chemistry and/or variable redfield ratio disolved and particulate organic matter\nsinking_speed: named tuple of constant sinking, of fields (i.e. ZFaceField(...)) for any tracers which sink (convention is that a sinking speed is positive, but a field will need to follow the usual down being negative)\nopen_bottom: should the sinking velocity be smoothly brought to zero at the bottom to prevent the tracers leaving the domain\nparticles: slot for BiogeochemicalParticles\n\nExample\n\njulia> using OceanBioME\n\njulia> using Oceananigans\n\njulia> grid = RectilinearGrid(size=(3, 3, 30), extent=(10, 10, 200));\n\njulia> model = LOBSTER(; grid)\nLodyc-DAMTP Ocean Biogeochemical Simulation Tools for Ecosystem and Resources (LOBSTER) model (Float64) \n Light Attenuation Model: \n    └── Two-band light attenuation model (Float64)\n Optional components:\n    ├── Carbonates ❌ \n    ├── Oxygen ❌ \n    └── Variable Redfield Ratio ❌\n Sinking Velocities:\n    ├── sPOM: 0.0 to -3.47e-5 m/s \n    └── bPOM: 0.0 to -0.0023148148148148147 m/s\n\n\n\n\n\n","category":"method"},{"location":"appendix/library/#Sugar-kelp-(Saccharina-latissima)","page":"Library","title":"Sugar kelp (Saccharina latissima)","text":"","category":"section"},{"location":"appendix/library/","page":"Library","title":"Library","text":"Modules = [OceanBioME.SLatissimaModel]\nprivate = true","category":"page"},{"location":"appendix/library/#OceanBioME.SLatissimaModel","page":"Library","title":"OceanBioME.SLatissimaModel","text":"Sugar kelp model of Broch and Slagstad (2012) and updated by Broch et al. (2013), Fossberg et al. (2018), and Broch et al. (2019).\n\nPrognostic properties\n\nArea: A (dm²)\nNitrogen reserve: N (gN/gSW)\nCarbon reserve: C (gC/gSW)\n\nTracer dependencies\n\nNitrates: NO₃ (mmol N/m³)\nPhotosynthetically available radiation: PAR (einstein/m²/day)\n\nOptional\n\nAmmonia: NH₄ (mmol N/m³)\n\n\n\n\n\n","category":"module"},{"location":"appendix/library/#OceanBioME.SLatissimaModel.SLatissima","page":"Library","title":"OceanBioME.SLatissimaModel.SLatissima","text":"SLatissima(; architecture :: AR = CPU(),\n             growth_rate_adjustement :: FT = 4.5,\n             photosynthetic_efficiency :: FT = 4.15e-5 * 24 * 10^6 / (24 * 60 * 60),\n             minimum_carbon_reserve :: FT = 0.01,\n             structural_carbon :: FT = 0.2,\n             exudation :: FT = 0.5,\n             erosion :: FT = 0.22,\n             saturation_irradiance :: FT = 90 * day/ (10 ^ 6),\n             structural_dry_weight_per_area :: FT = 0.5,\n             structural_dry_to_wet_weight :: FT = 0.0785,\n             carbon_reserve_per_carbon :: FT = 2.1213,\n             nitrogen_reserve_per_nitrogen :: FT = 2.72,\n             minimum_nitrogen_reserve :: FT = 0.0126,\n             maximum_nitrogen_reserve :: FT = 0.0216,\n             growth_adjustement_2 :: FT = 0.039 / (2 * (1 - minimum_nitrogen_reserve / maximum_nitrogen_reserve)),\n             growth_adjustement_1 :: FT = 0.18 / (2 * (1 - minimum_nitrogen_reserve / maximum_nitrogen_reserve)) - growth_adjustement_2,\n             maximum_specific_growth_rate :: FT = 0.18,\n             structural_nitrogen :: FT = 0.0146,\n             photosynthesis_at_ref_temp_1 :: FT = 1.22e-3 * 24,\n             photosynthesis_at_ref_temp_2 :: FT = 1.3e-3 * 24,\n             photosynthesis_ref_temp_1 :: FT = 285.0,\n             photosynthesis_ref_temp_2 :: FT = 288.0,\n             photoperiod_1 :: FT = 0.85,\n             photoperiod_2 :: FT = 0.3,\n             respiration_at_ref_temp_1 :: FT = 2.785e-4 * 24,\n             respiration_at_ref_temp_2 :: FT = 5.429e-4 * 24,\n             respiration_ref_temp_1 :: FT = 285.0,\n             respiration_ref_temp_2 :: FT = 290.0,\n             photosynthesis_arrhenius_temp :: FT = (1 / photosynthesis_ref_temp_1 - 1 / photosynthesis_ref_temp_2) ^ -1 * log(photosynthesis_at_ref_temp_2 / photosynthesis_at_ref_temp_1),\n             photosynthesis_low_temp :: FT = 271.0,\n             photosynthesis_high_temp :: FT = 296.0,\n             photosynthesis_high_arrhenius_temp :: FT = 1414.87,\n             photosynthesis_low_arrhenius_temp :: FT = 4547.89,\n             respiration_arrhenius_temp :: FT = (1 / respiration_ref_temp_1 - 1 / respiration_ref_temp_2) ^ -1 * log(respiration_at_ref_temp_2 / respiration_at_ref_temp_1),\n             current_speed_for_0p65_uptake :: FT = 0.03,\n             nitrate_half_saturation :: FT = 4.0,\n             ammonia_half_saturation :: FT = 1.3,\n             maximum_nitrate_uptake :: FT = 10 * structural_dry_weight_per_area * 24 * 14 / (10^6),\n             maximum_ammonia_uptake :: FT = 12 * structural_dry_weight_per_area * 24 * 14 / (10^6),\n             current_1 :: FT = 0.72,\n             current_2 :: FT = 0.28,\n             current_3 :: FT = 0.045,\n             respiration_reference_A :: FT = 1.11e-4 * 24,\n             respiration_reference_B :: FT = 5.57e-5 * 24,\n             exudation_redfield_ratio :: FT = Inf,\n\n             pescribed_velocity :: U = 0.1,\n             pescribed_temperature :: T = nothing,\n             pescribed_salinity :: S = nothing,\n\n             #position\n             x :: P = arch_array(architecture, [0.0])\n             y :: P = arch_array(architecture, zeros(Float64, length(x))),\n             z :: P = arch_array(architecture, zeros(Float64, length(x))),\n\n             #properties\n             A :: P = arch_array(architecture, ones(Float64, length(x)) * 30),\n             N :: P = arch_array(architecture, ones(Float64, length(x)) * 0.01),\n             C :: P = arch_array(architecture, ones(Float64, length(x)) * 0.1),\n\n             #feedback\n             nitrate_uptake :: P = arch_array(architecture, zeros(Float64, length(x))),\n             ammonia_uptake :: P = arch_array(architecture, zeros(Float64, length(x))),\n             primary_production :: P = arch_array(architecture, zeros(Float64, length(x))),\n             frond_exudation :: P = arch_array(architecture, zeros(Float64, length(x))),\n             nitrogen_erosion :: P = arch_array(architecture, zeros(Float64, length(x))),\n             carbon_erosion :: P = arch_array(architecture, zeros(Float64, length(x))),\n\n             custom_dynamics :: F = no_dynamics,\n\n             scalefactor :: FT = 1.0,\n             latitude :: FT = 57.5)\n\nKeyword Arguments\n\narchitecture: the architecture to adapt arrays to\ngrowth_rate_adjustement, ..., exudation_redfield_ratio: parameter values\npescribed_velocity, pescribed_temperature and pescribed_salinity: functions for the relative velocity, temperature and salinity in the form f(x, y, z, t)\nx,y and z: positions of the particles\nA, N, and C: area, nitrogen, and carbon reserves\nnitrate_uptake ... carbon_erosion: diagnostic values coupled to tracer fields\ncustom_dynamics: place to add any function of form f!(particles, model, bgc, Δt)\nscalefactor: scalar scaling for tracer coupling\nlatitude: model latitude for seasonal growth modulation\n\n\n\n\n\n","category":"type"},{"location":"appendix/library/#Light-Attenuation-Models","page":"Library","title":"Light Attenuation Models","text":"","category":"section"},{"location":"appendix/library/","page":"Library","title":"Library","text":"Modules = [OceanBioME.Light]\nprivate = false","category":"page"},{"location":"appendix/library/#OceanBioME.Light","page":"Library","title":"OceanBioME.Light","text":"Light attenuation by chlorophyll as described by Karleskind et al. (2011) (implemented as twoBand) and Morel (1988).\n\n\n\n\n\n","category":"module"},{"location":"appendix/library/#OceanBioME.Light.TwoBandPhotosyntheticallyActiveRadiation-Union{Tuple{}, Tuple{SPAR}, Tuple{FT}} where {FT, SPAR}","page":"Library","title":"OceanBioME.Light.TwoBandPhotosyntheticallyActiveRadiation","text":"TwoBandPhotosyntheticallyActiveRadiation(; grid, \n                                           water_red_attenuation::FT = 0.225, # 1/m\n                                           water_blue_attenuation::FT = 0.0232, # 1/m\n                                           chlorophyll_red_attenuation::FT = 0.037, # 1/(m * (mgChl/m³) ^ eʳ)\n                                           chlorophyll_blue_attenuation::FT = 0.074, # 1/(m * (mgChl/m³) ^ eᵇ)\n                                           chlorophyll_red_exponent::FT = 0.629,\n                                           chlorophyll_blue_exponent::FT = 0.674,\n                                           pigment_ratio::FT = 0.7,\n                                           phytoplankton_chlorophyll_ratio::FT = 1.31,\n                                           surface_PAR::SPAR = (x, y, t) -> 100 * max(0.0, cos(t * π / 12hours)))\n\nKeyword Arguments\n\ngrid: grid for building the model on\nwater_red_attenuation, ..., phytoplankton_chlorophyll_ratio: parameter values\nsurface_PAR: function (or array in the future) for the photosynthetically available radiation at the surface,   which should be f(x, y, t) where x and y are the native coordinates (i.e. meters for rectilinear grids  and latitude/longitude as appropriate)\n\n\n\n\n\n","category":"method"},{"location":"appendix/library/#Boundary-Conditions","page":"Library","title":"Boundary Conditions","text":"","category":"section"},{"location":"appendix/library/","page":"Library","title":"Library","text":"Modules = [OceanBioME.Boundaries]\nprivate = false","category":"page"},{"location":"appendix/library/#OceanBioME.Boundaries","page":"Library","title":"OceanBioME.Boundaries","text":"Boundary conditions for air/sea and sediment flux. \n\nCurrently implemented:\n\ngasexchange (Wanninkhof, 1992)\nGeneric air-sea flux model described by Wanninkhof (1992) but only setup for CO₂ and O₂.\nForces the DIC and oxygen fields, and requires temp (in centigrade) and salinity, plus current DIC and ALK concentration.\nSediments\nSoetaert (Soetaert et al., 2000)\nsimple (integrated) sediment model described by Soetaert et al. (2000), where organic matter  that sinks to the bottom is stored, decays into NO₃ and NH₄, and takes up O₂ in the process.\nExtended to attribute the corresponding release of DIC.\nForced by O₂, NO₃, NH₄ and particle concentration in bottom cell.\nInstant remineralisation \nsimple model from Aumont et al. (2015), where sinking organic matter is instantly remineralised  and returned to the bottom cell\nsome fraction is stored permanently in the sediment at an efficiency given by Dunne et al. (2007)\n\n\n\n\n\n","category":"module"},{"location":"appendix/library/#OceanBioME.Boundaries.GasExchange-Union{Tuple{}, Tuple{PCO}, Tuple{S}, Tuple{T}, Tuple{AP}, Tuple{AC}, Tuple{FT}, Tuple{βP}, Tuple{ScP}} where {ScP, βP, FT, AC, AP, T, S, PCO}","page":"Library","title":"OceanBioME.Boundaries.GasExchange","text":"GasExchange(; gas,\n              schmidt_params::ScP = (CO₂ = (A=2073.1, B=125.62, C=3.6276, D=0.043219),\n                               O₂ = (A=1953.4, B=128.0, C=3.9918, D=0.050091))[gas],\n              solubility_params::βP = (CO₂ = (A₁=-60.2409, A₂=93.4517, A₃=23.3585, B₁=0.023517, B₂=-0.023656, B₃=0.0047036),\n                                 O₂ = (A₁=-58.3877, A₂=85.8079, A₃=23.8439, B₁=-0.034892, B₂=0.015568, B₃=-0.0019387))[gas],\n              ocean_density::FT = 1026, # kg/m³\n              air_concentration::AC = (CO₂ = 413.4, O₂ = 9352.7)[gas], # ppmv, mmolO₂/m³ (20.95 mol O₂/mol air, 0.0224m^3/mol air)\n              air_pressure::FT = 1.0, # atm\n              average_wind_speed::FT = 10, # m/s\n              field_dependencies = (CO₂ = (:DIC, :ALK), O₂ = (:OXY, ))[gas],\n              temperature::T = nothing,\n              salinity::S = nothing)\n\nConstruct an Oceananigans FluxBoundaryCondition for the exchange of gas with the relevant tracer (i.e., DIC for CO₂ and oxygen for O₂). Please see note for other gases.\n\nKeyword arguments\n\ngas: (required) the gas to be exchanged, if :CO₂ or :O₂ are specified then all other settings may be infered\nschmidt_params : named tuple of parameters for calculating the Schmidt number using the parameterisation of Wanninkhof (1992)\nsolubility_params : named tuple of parameters for calculating the solubility (for O₂ the Bunsen solubility and CO₂ K₀, see note)\nocean_density : density of the ocean in kg/m³\nair_concentratio : concentration of the gas in air in relivant units (i.e. ppmv for CO₂ and mmol O₂/m³ for O₂), can also be a function of x, y, t, or a field\nair_pressure : air pressure in atm (only used for CO₂), can also be a function of x, y, t, or a field\naverage_wind_speed : average wind speed at 10m used to calculate the gas transfer velocity by the Wanninkhof (1992) parameterisation\nfield_dependencies : tracer fields that gas exchange depends on, if the defaults have different names in your model you can specify as long as they are in the same order\ntemperature : either nothing to track a temperature tracer field, or a function or shape f(x, y, z, t) for the temperature in °C\nsalinity : either nothing to track a salinity tracer field, or a function or shape f(x, y, z, t) for the salinity in ‰\npCO₂ : pCO₂ calculator\n\nnote: Gases other than CO₂ and O₂\nThis model is fully capable of exchanging any gas but the parameters have only been configured for CO₂ and O₂, and the specific formulation is only ensured for these gasses. For any gas where the Wanninkhof (1992) parameterisation returns the Bunsen Solubility Coefficient this model will work out of the box and can just be passed new parameters. For the other solubility types (i.e. K₀, K' and f) you will need to overload the (gasexchange::GasExchange) function to ensure the correct formulaiton.\n\n\n\n\n\n","category":"method"},{"location":"appendix/library/","page":"Library","title":"Library","text":"Modules = [OceanBioME.Boundaries.Sediments]\nprivate = false","category":"page"},{"location":"appendix/library/#OceanBioME.Boundaries.Sediments.InstantRemineralisation","page":"Library","title":"OceanBioME.Boundaries.Sediments.InstantRemineralisation","text":"struct InstantRemineralisation\n\nHold the parameters and fields the simplest benthic boundary layer where organic carbon is assumed to remineralise instantly with some portion  becoming N, and a fraction being perminantly burried.\n\nBurial efficiency from Dunne et al. (2007).\n\n\n\n\n\n","category":"type"},{"location":"appendix/library/#OceanBioME.Boundaries.Sediments.InstantRemineralisation-Tuple{}","page":"Library","title":"OceanBioME.Boundaries.Sediments.InstantRemineralisation","text":"InstantRemineralisation(; grid,\n    burial_efficiency_constant1::FT = 0.013,\n    burial_efficiency_constant2::FT = 0.53,\n    burial_efficiency_half_saturaiton::FT = 7)\n\nReturn a single-layer instant remineralisaiton model for NPZD bgc models.\n\nExample\n\nusing OceanBioME, Oceananigans, OceanBioME.Sediments\n\ngrid = RectilinearGrid(size=(3, 3, 30), extent=(10, 10, 200))\n\nsediment_model = InstantRemineralisation(; grid)\n\n\n\n\n\n","category":"method"},{"location":"appendix/library/#OceanBioME.Boundaries.Sediments.SimpleMultiG","page":"Library","title":"OceanBioME.Boundaries.Sediments.SimpleMultiG","text":"struct SimpleMultiG\n\nHold the parameters and fields for a simple \"multi G\" single-layer sediment model. Based on the Level 3 model described by Soetaert et al. (2000).\n\n\n\n\n\n","category":"type"},{"location":"appendix/library/#OceanBioME.Boundaries.Sediments.SimpleMultiG-Union{Tuple{}, Tuple{P4}, Tuple{P3}, Tuple{P2}, Tuple{P1}, Tuple{FT}} where {FT, P1, P2, P3, P4}","page":"Library","title":"OceanBioME.Boundaries.Sediments.SimpleMultiG","text":"SimpleMultiG(; grid\n               fast_decay_rate::FT = 2/day,\n               slow_decay_rate::FT = 0.2/day,\n               fast_redfield::FT = 0.1509,\n               slow_redfield::FT = 0.13,\n               fast_fraction::FT = 0.74,\n               slow_fraction::FT = 0.26,\n               refactory_fraction::FT = 0.1,\n               nitrate_oxidation_params::P1 = (A = - 1.9785, B = 0.2261, C = -0.0615, D = -0.0289, E = - 0.36109, F = - 0.0232),\n               denitrification_params::P2 = (A = - 3.0790, B = 1.7509, C = 0.0593, D = - 0.1923, E = 0.0604, F = 0.0662),\n               anoxic_params::P3 = (A = - 3.9476, B = 2.6269, C = - 0.2426, D = -1.3349, E = 0.1826, F = - 0.0143),\n               depth = abs(znodes(grid, Face())[1]),\n               solid_dep_params::P4 = (A = 0.233, B = 0.336, C = 982, D = - 1.548, depth = depth))\n\nReturn a single-layer \"multi G\" sediment model (SimpleMultiG) on grid, where parameters can be optionally specified.\n\nThe model is a single layer (i.e. does not include porous diffusion) model with three classes of sediment organic matter which decay at three different rates (fast, slow, refactory). The nitrifcation/denitrifcation/anoxic mineralisation fractions default to the parameterisation of Soetaert et al. 2000; doi:10.1016/S0012-8252(00)00004-0.\n\nThis model has not yet been validated or compared to observational data. The variety of degridation processes is likely to be strongly dependent on oxygen availability (see https://bg.copernicus.org/articles/6/1273/2009/bg-6-1273-2009.pdf) so it will therefore be important to also thoroughly validate the oxygen model (also currently limited).\n\nExample\n\njulia> using OceanBioME, Oceananigans, OceanBioME.Sediments\n\njulia> grid = RectilinearGrid(size=(3, 3, 30), extent=(10, 10, 200));\n\njulia> sediment_model = SimpleMultiG(; grid)\n┌ Warning: Sediment models are an experimental feature and have not yet been validated.\n└ @ OceanBioME.Boundaries.Sediments ~/OceanBioME.jl/src/Boundaries/Sediments/simple_multi_G.jl:102\n[ Info: This sediment model is currently only compatible with models providing NH₄, NO₃, O₂, and DIC.\nSingle-layer multi-G sediment model (Float64)\n\n\n\n\n\n","category":"method"},{"location":"appendix/library/#Box-Model","page":"Library","title":"Box Model","text":"","category":"section"},{"location":"appendix/library/","page":"Library","title":"Library","text":"Modules = [OceanBioME.BoxModels]\nprivate = false","category":"page"},{"location":"appendix/library/#OceanBioME.BoxModels","page":"Library","title":"OceanBioME.BoxModels","text":"Integrate biogeochemical models on a single point\n\n\n\n\n\n","category":"module"},{"location":"appendix/library/#OceanBioME.BoxModels.BoxModel-Union{Tuple{}, Tuple{C}, Tuple{TS}, Tuple{FT}, Tuple{B}} where {B, FT, TS, C}","page":"Library","title":"OceanBioME.BoxModels.BoxModel","text":"BoxModel(; biogeochemistry::B,\n           stop_time::FT = 0.0,\n           forcing = NamedTuple(),\n           timestepper::TS = RungeKutta3TimeStepper((required_biogeochemical_tracers(biogeochemistry)..., required_biogeochemical_auxiliary_fields(biogeochemistry)...)),\n           Δt::FT = 1.0,\n           clock::C = Clock(0.0, 0, 1))\n\nConstructs a box model of a biogeochemistry model. Once this has been constructed you can set initial condiitons by set!(model, X=1.0...) and then run!(model).\n\nKeyword Arguments\n\nbiogeochemistry: (required) an OceanBioME biogeochemical model, most models must be passed a grid which can be set to BoxModelGrid() for box models\nstop_time: end time of simulation\nforcing: NamedTuple of additional forcing functions for the biogeochemical tracers to be integrated\ntimestepper: Timestepper to integrate model, only available is currently RungeKutta3TimeStepper\nΔt: time step length\nclock: Oceananigans clock to keep track of time\n\n\n\n\n\n","category":"method"},{"location":"appendix/library/#OceanBioME.BoxModels.SaveBoxModel","page":"Library","title":"OceanBioME.BoxModels.SaveBoxModel","text":"SaveBoxModel(filepath::FP)\n\nConstruct object to save box model outputs at filepath.\n\nArguments\n\nfilepath - path to save results to\n\n\n\n\n\n","category":"type"},{"location":"appendix/library/#Oceananigans.Fields.set!-Tuple{BoxModel}","page":"Library","title":"Oceananigans.Fields.set!","text":"set!(model::BoxModel; kwargs...)\n\nSet the values for a BoxModel\n\nArguments\n\nmodel - the model to set the arguments for\n\nKeyword Arguments\n\nvariables and value pairs to set\n\n\n\n\n\n","category":"method"},{"location":"appendix/library/#Oceananigans.Simulations.run!-Tuple{BoxModel}","page":"Library","title":"Oceananigans.Simulations.run!","text":"run!(model::BoxModel; feedback_interval = 1000, save_interval = Inf, save = nothing)\n\nRun a box model.\n\nArguments\n\nmodel - the BoxModel to solve\n\nKeyword Arguments\n\nfeedback_interval: how often (number of iterations) to display progress\nsave_interval: how often (number of iterations) to save output\nsave: SaveBoxModel object to specify how to save output\n\nTODO: should abstract out to simulation like Oceananigans to add e.g. callbacks\n\n\n\n\n\n","category":"method"},{"location":"references/#References","page":"References","title":"References","text":"","category":"section"},{"location":"references/","page":"References","title":"References","text":"","category":"page"},{"location":"appendix/params/#parameters","page":"Parameters","title":"Parameters","text":"","category":"section"},{"location":"appendix/params/","page":"Parameters","title":"Parameters","text":"These pages contain most of the parameters used in the models included in OceanBioME.jl for ease of reference.","category":"page"},{"location":"appendix/params/","page":"Parameters","title":"Parameters","text":"Units are generally mmol X / m³ for concentration, and SI otherwise.","category":"page"},{"location":"model_components/individuals/#individuals","page":"Overview","title":"Individuals","text":"","category":"section"},{"location":"model_components/individuals/","page":"Overview","title":"Overview","text":"The effects of individuals can be modelled in OceanBioME. We have implemented this through custom dynamics in the Lagrangian Particle tracking feature of Oceananigans. We have extended these functionalities to make it easier to implement \"active\" particles which interact with the tracers. We have then implemented a model of sugar kelp which can be followed as an example of using this functionality.","category":"page"},{"location":"model_components/individuals/","page":"Overview","title":"Overview","text":"To setup particles first create a particle type with the desired properties, e.g.:","category":"page"},{"location":"model_components/individuals/","page":"Overview","title":"Overview","text":"using OceanBioME.Particles: BiogeochemicalParticles\n\nstruct GrowingParticles{FT, VT} <: BiogeochemicalParticles \n    nutrients_half_saturation :: FT\n\n    size :: VT\n    nitrate_uptake :: VT\n\n    x :: VT\n    y :: VT\n    z :: VT\nend","category":"page"},{"location":"model_components/individuals/","page":"Overview","title":"Overview","text":"You then need to overload particular functions to integrate the growth, so they need to first be imported:","category":"page"},{"location":"model_components/individuals/","page":"Overview","title":"Overview","text":"import Oceananigans.Biogeochemistry: update_tendencies!\nimport Oceananigans.Models.LagrangianParticleTracking: update_lagrangian_particle_properties!, _advect_particles!","category":"page"},{"location":"model_components/individuals/","page":"Overview","title":"Overview","text":"First, to integrate the particles properties we overload update_particle_properties, in this fictitious case we will have a Mondo-quota nutrient uptake and growth:","category":"page"},{"location":"model_components/individuals/","page":"Overview","title":"Overview","text":"using Oceananigans.Fields: interpolate\n\nfunction update_lagrangian_particle_properties!(particles::GrowingParticles, model, bgc, Δt)\n    @inbounds for p in 1:length(particles)\n        nutrients = @inbounds interpolate(model.tracers.NO₃, particle.x[p], particle.y[p], particle.z[p])\n\n        uptake = nutrients / (particle.nutrients_half_saturation + nutrients)\n\n        particles.size[p] += uptake * Δt\n        particles.nitrate_uptake[p] = uptake\n    end\n    return nothing\nend\n\nnothing # hide","category":"page"},{"location":"model_components/individuals/","page":"Overview","title":"Overview","text":"In this example the particles will not move around, and are only integrated on a single thread. For a more comprehensive example see the Sugar Kelp implementation. We then need to update the tracer tendencies to match the nutrients' uptake:","category":"page"},{"location":"model_components/individuals/","page":"Overview","title":"Overview","text":"using OceanBioME.Particles: get_node\n\nfunction update_tendencies!(bgc, particles::GrowingParticles, model)\n    @inbounds for p in 1:length(particles)\n        # here we use an OceanBioME utility to find the nearest nodes to apply the tendency to\n        nodes, normfactor = @inbounds get_nearest_nodes(particles.x[p], particles.y[p], particles.z[p], model.grid, (Center(), Center(), Center()))\n\n        for (i, j, k, d) in nodes \n            # Reflect back on Bounded boundaries or wrap around for Periodic boundaries\n            i, j, k = (get_node(TX(), i, grid.Nx), get_node(TY(), j, grid.Ny), get_node(TZ(), k, grid.Nz))\n\n            node_volume = volume(i, j, k, grid, LX(), LY(), LZ())\n            @inbounds model.timestepper.Gⁿ.NO₃[i, j, k] += particles.nitrate_uptake[p] / (d * node_volume)\n        end\n    end\n    return nothing\nend\n\nnothing # hide","category":"page"},{"location":"model_components/individuals/","page":"Overview","title":"Overview","text":"Now we can just plug this into any biogeochemical model setup to have particles (currently NPZD and LOBSTER):","category":"page"},{"location":"model_components/individuals/","page":"Overview","title":"Overview","text":"using OceanBioME, Oceananigans\n\nLx, Ly, Lz = 1000, 1000, 100\ngrid = RectilinearGrid(; size = (64, 64, 16), extent = (Lx, Ly, Lz))\n\n# Start the particles randomly distributed, floating on the surface\nparticles = GrowingParticles(0.5, zeros(3), zeros(3), rand(3) * Lx, rand(3) * Ly, zeros(3))\n\nbiogeochemistry = LOBSTER(; grid, particles)","category":"page"},{"location":"model_implementation/#model_implementation","page":"Implementing new models","title":"Implementing a new models","text":"","category":"section"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"Here we will describe how OceanBioME defines biogeochemical (BGC) models, how this varies from Oceananigans, and how to implement your own model.","category":"page"},{"location":"model_implementation/#Model-structure","page":"Implementing new models","title":"Model structure","text":"","category":"section"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"OceanBioME BGC models are structs of type ContinuousFormBiogeochemistry, which is of abstract type AbstractContinuousFormBiogeochemistry from Oceananigans. In Oceananigans this describes BGC models which are continuous (depend continuously on x, y, and z) rather than discrete (depending on i, j, k). This simplifies the implementation of BGC models as forcing and sinking are very simple to define and add to tracers, and then Oceananigans handles the rest.","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"OceanBioME's ContinuousFormBiogeochemistry adds a layer on top of this which makes adding light attenuation models, sediment, and biologically active particles. This is because ContinuousFormBiogeochemistry has parameters in which the types of these components are stored. This means that the model components will automatically be integrated with the BGC model without having to add new methods to various Oceananigans functions as you otherwise will have. ","category":"page"},{"location":"model_implementation/#Implementing-a-model","page":"Implementing new models","title":"Implementing a model","text":"","category":"section"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"The nature of multiple dispatch in Julia means that we define new BGC models as new types. You can then define methods to this type which are used by OceanBioME and Oceananigans to integrate the model.","category":"page"},{"location":"model_implementation/#The-basics","page":"Implementing new models","title":"The basics","text":"","category":"section"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"For this example we are going to implement the simple Nutrient-Phytoplankton model similar to that used in (Chen et al., 2015), although we neglect the nutrient in/outflow terms since they may be added as boundary conditions, and modified to conserve nitrogen.","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"The first step we need is to import the abstract type from OceanBioME, some units from Oceananigans (for ease of parameter definition), and import some functions from Oceananigans which we will add methods to:","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"using OceanBioME: ContinuousFormBiogeochemistry\nusing Oceananigans.Units\n\nimport Oceananigans.Biogeochemistry: required_biogeochemical_tracers,\n                                     required_biogeochemical_auxiliary_fields,\n                                     update_biogeochemical_state!,\n                                     biogeochemical_drift_velocity,\n                                     biogeochemical_auxiliary_fields","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"We then define our struct with the model parameters, as well as slots for the particles, light attenuation, and sediment models:","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"@kwdef struct NutrientPhytoplankton{FT, LA, S, W, P} <:ContinuousFormBiogeochemistry{LA, S, P}\n            base_growth_rate :: FT = 1.27 / day              # 1 / seconds\n    nutrient_half_saturation :: FT = 0.025 * 1000 / 14       # mmol N / m³\n       light_half_saturation :: FT = 300.0                   # micro einstein / m² / s\n        temperature_exponent :: FT = 0.24                    # 1\n     temperature_coefficient :: FT = 1.57                    # 1\n         optimal_temperature :: FT = 28.0                    # °C\n              mortality_rate :: FT = 0.15 / day              # 1 / seconds\n     crowding_mortality_rate :: FT = 0.004 / day / 1000 * 14 # 1 / seconds / mmol N / m³\n\n     light_attenuation_model :: LA = nothing\n              sediment_model :: S  = nothing\n            sinking_velocity :: W  = 2 / day\n                   particles :: P  = nothing\nend","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"In the above we used @kwdef to set default values for the models so that we don't have to set these up each time we use the model. We have also included a sinking_velocity field to later demonstrate how we can get tracers to sink. We also need to define some functions so that OceanBioME and Oceananigans know what tracers and auxiliary fields (e.g. light intensity) we need setting up:","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"required_biogeochemical_tracers(::NutrientPhytoplankton) = (:N, :P, :T)\n\nrequired_biogeochemical_auxiliary_fields(::NutrientPhytoplankton) = (:PAR, )\n\nbiogeochemical_auxiliary_fields(bgc::NutrientPhytoplankton) = biogeochemical_auxiliary_fields(bgc.light_attenuation_model)","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"Next, we need to define the methods that specify how the nutrient, N, and phytoplankton P evolve. We want the phytoplankton to evolve at the rate given by:","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"fracpartial Ppartial t = mu g(T) f(N) h(PAR) P - mP - bP^2","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"where mu is base_growth_rate, m is mortality_rate, and b is crowding. The functions g, f, and h are given by:","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"beginalign\ng(T) = c_1expleft(-c_2T - T_optright)\nf(N) = fracNk_N + N\nh(PAR) = fracPARk_P + PAR\nendalign","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"where c_1 is temperature_coefficient,  c_2 is temperature_exponent, T_opt is optimal_temperature, k_N is nutrient_half_saturation, and k_P is light_half_saturation. Since this is a simple two variable model and the total concentration is conserved, fracpartial Npartial t = - fracpartial Ppartial t.","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"We turn this into a method of our new type by writing:","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"@inline function (bgc::NutrientPhytoplankton)(::Val{:P}, x, y, z, t, N, P, T, PAR)\n    μ = bgc.base_growth_rate\n    m = bgc.mortality_rate\n    b = bgc.crowding_mortality_rate\n\n    growth = μ * g(bgc, T) * f(bgc, N) * h(bgc, PAR) * P\n\n    death = m * P + b * P ^ 2\n\n    return growth - death\nend\n\n@inline function g(bgc, T)\n    c₁ = bgc.temperature_coefficient\n    c₂ = bgc.temperature_exponent\n    Tₒ = bgc.optimal_temperature\n\n    return c₁ * exp(-c₂ * abs(T - Tₒ))\nend\n\n@inline function f(bgc, N)\n    kₙ = bgc.nutrient_half_saturation\n\n    return N / (N + kₙ)\nend\n\n@inline function h(bgc, PAR)\n    kₚ = bgc.light_half_saturation\n\n    return PAR / (PAR + kₚ)\nend","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"The first parameter ::Val{:P} is a special value type that allows this function to be dispatched when it is given the value Val(:P). This is how Oceananigans tells the model which forcing function it wants. At the start of this function we unpack some parameters from the model, then calculate each term, and return the total change. For the nutrient, we will define the evolution by:","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"@inline (bgc::NutrientPhytoplankton)(::Val{:N}, args...) = -bgc(Val(:P), args...)","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"Finally, we need to define some functions to make sure that the sub-models (light attenuation) get updated in the right place","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"using OceanBioME: BoxModel\nimport OceanBioME.BoxModels: update_boxmodel_state!\n\nfunction update_biogeochemical_state!(bgc::NutrientPhytoplankton, model)\n    update_PAR!(model, bgc.light_attenuation_model)\nend\n\nfunction update_boxmodel_state!(model::BoxModel{<:NutrientPhytoplankton, <:Any, <:Any, <:Any, <:Any, <:Any})\n    getproperty(model.values, :PAR) .= model.forcing.PAR(model.clock.time)\n    getproperty(model.values, :T) .= model.forcing.T(model.clock.time)\nend","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"Now we can run an example similar to the LOBSTER box model example:","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"using OceanBioME, Oceananigans.Units\n\nconst year = years = 365days\n\n@inline PAR⁰(t) = 500 * (1 - cos((t + 15days) * 2π / year)) * (1 / (1 + 0.2 * exp(-((mod(t, year) - 200days) / 50days)^2))) + 2\n\nz = -10 # specify the nominal depth of the box for the PAR profile\n@inline PAR(t) = PAR⁰(t) * exp(0.2z) # Modify the PAR based on the nominal depth and exponential decay \n\n@inline temp(t) = 2.4 * cos(t * 2π / year + 50days) + 26\n\nbiogeochemistry = NutrientPhytoplankton() \n\nmodel = BoxModel(; biogeochemistry, forcing = (; PAR, T = temp))\nmodel.Δt = 5minutes\nmodel.stop_time = 5years\n\nset!(model, N = 15, P = 15)\n\n# ## Run the model (should only take a few seconds)\n@info \"Running the model...\"\nrun!(model, save_interval = 100, feedback_interval = Inf, save = SaveBoxModel(\"box_np.jld2\"))","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"We can then visualise this:","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"using JLD2\n\nvars = (:N, :P, :T, :PAR)\nfile = jldopen(\"box_np.jld2\")\ntimes = parse.(Float64, keys(file[\"values\"]))\n\ntimeseries = NamedTuple{vars}(ntuple(t -> zeros(length(times)), length(vars)))\n\nfor (idx, time) in enumerate(times)\n    values = file[\"values/$time\"]\n    for tracer in vars\n        getproperty(timeseries, tracer)[idx] = values[tracer]\n    end\nend\n\nclose(file)\n\n# ## And plot\nusing CairoMakie\n\nfig = Figure(resolution = (1200, 480), fontsize = 20)\n\naxN= Axis(fig[1, 1], ylabel = \"Nutrient \\n(mmol N / m³)\")\nlines!(axN, times / year, timeseries.N, linewidth = 3)\n\naxP = Axis(fig[1, 2], ylabel = \"Phytoplankton \\n(mmol N / m³)\")\nlines!(axP, times / year, timeseries.P, linewidth = 3)\n\naxPAR= Axis(fig[2, 1], ylabel = \"PAR (einstein / m² / s)\", xlabel = \"Time (years)\")\nlines!(axPAR, times / year, timeseries.PAR, linewidth = 3)\n\naxT = Axis(fig[2, 2], ylabel = \"Temperature (°C)\", xlabel = \"Time (years)\")\nlines!(axT, times / year, timeseries.T, linewidth = 3)\n\nfig","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"So now we know it works.","category":"page"},{"location":"model_implementation/#Phytoplankton-sinking","page":"Implementing new models","title":"Phytoplankton sinking","text":"","category":"section"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"Now that we have a fully working BGC model we might want to add some more features. Another aspect that is easy to add is negative buoyancy. To-do this all we do is add a method to the Oceananigans function biogeochemical_drift_velocity. In this case we are going to only consider the phytoplankton to sink, so when we define the velocity we just need to set sinking_velocity to the speed like NutrientPhytoplankton(; light_attenuation_model, sinking_velocity = 2/day). Then we add some more Oceananigans functions, and add the method:","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"using Oceananigans.Fields: ZeroField, ConstantField\n\nbiogeochemical_drift_velocity(bgc::NutrientPhytoplankton, ::Val{:P}) = \n    (u = ZeroField(), v = ZeroField(), w = bgc.sinking_velocity)","category":"page"},{"location":"model_implementation/#Sediment-model-coupling","page":"Implementing new models","title":"Sediment model coupling","text":"","category":"section"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"Another aspect that OceanBioME allows easy coupling with is sediment models. Doing this varies between sediment models, but for the most generic and simplest all we need to do is add methods to two functions:","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"using OceanBioME.Boundaries.Sediments: sinking_flux\n\nimport OceanBioME.Boundaries.Sediments: nitrogen_flux, carbon_flux, remineralisation_receiver\n\n@inline nitrogen_flux(grid, advection, bgc::NutrientPhytoplankton, tracers, i, j) =\n    sinking_flux(i, j, grid, advection, Val(:P), bgc, tracers)\n                 \n@inline carbon_flux(bgc::NutrientPhytoplankton, tracers, i, j) = nitrogen_flux(bgc, tracers, i, j) * 6.56\n\n@inline remineralisation_receiver(::NutrientPhytoplankton) = :N","category":"page"},{"location":"model_implementation/#Putting-it-together","page":"Implementing new models","title":"Putting it together","text":"","category":"section"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"Now that we have added these elements we can put it together into another simple example:","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"using Oceananigans, OceanBioME\nusing OceanBioME.Sediments: InstantRemineralisation\n\n# define some simple forcing\n\n@inline surface_PAR(x, y, t) = 200 * (1 - cos((t + 15days) * 2π / year)) * (1 / (1 + 0.2 * exp(-((mod(t, year) - 200days) / 50days)^2))) + 2\n\n@inline temp(x, y, z, t) = cos(t * 2π / year + 50days) + 28\n\n@inline κₜ(x, y, z, t) = 1e-2 * (1 + tanh((z - 50) / 10)) / 2 + 1e-4\n\n# define the grid\n\ngrid = RectilinearGrid(topology = (Flat, Flat, Bounded), size = (32, ), extent = (100, ))\n\n# setup the biogeochemical model\n\nlight_attenuation_model = TwoBandPhotosyntheticallyActiveRadiation(; grid, surface_PAR)\n\nsediment_model = InstantRemineralisation(; grid)\n\nsinking_velocity = ZFaceField(grid)\n\nw_sink(x, y, z) = 2 / day * tanh(z / 5)\n\nset!(sinking_velocity, w_sink)\n\nbiogeochemistry = NutrientPhytoplankton(; light_attenuation_model, sinking_velocity, sediment_model) \n\n# put the model together\n\nmodel = NonhydrostaticModel(; grid,\n                              biogeochemistry,\n                              closure = ScalarDiffusivity(ν = κₜ, κ = κₜ), \n                              forcing = (T = Relaxation(rate = 1/day, target=temp), ))\n\nset!(model, P = 0.01, N = 15, T = 28)\n\n# run\n\nsimulation = Simulation(model, Δt = 9minutes, stop_time = 1years)\n\nsimulation.output_writers[:tracers] = JLD2OutputWriter(model, model.tracers,\n                                                       filename = \"column_np.jld2\",\n                                                       schedule = TimeInterval(1day),\n                                                       overwrite_existing = true)\n\nsimulation.output_writers[:sediment] = JLD2OutputWriter(model, model.biogeochemistry.sediment_model.fields,\n                                                        indices = (:, :, 1),\n                                                        filename = \"column_np_sediment.jld2\",\n                                                        schedule = TimeInterval(1day),\n                                                        overwrite_existing = true)\n\nscale_negative_tracers = ScaleNegativeTracers(; model, tracers = (:N, :P))\nsimulation.callbacks[:nan_tendencies] = Callback(remove_NaN_tendencies!; callsite = TendencyCallsite())\n\nrun!(simulation)","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"We can then visualise this:","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"N = FieldTimeSeries(\"column_np.jld2\", \"N\")\nP = FieldTimeSeries(\"column_np.jld2\", \"P\")\n\nsed = FieldTimeSeries(\"column_np_sediment.jld2\", \"N_storage\")\n\nfig = Figure()\n\naxN = Axis(fig[1, 1], ylabel = \"z (m)\")\naxP = Axis(fig[2, 1], ylabel = \"z (m)\")\naxSed = Axis(fig[3, 1:2], ylabel = \"Sediment (mmol N / m²)\", xlabel = \"Time (years)\")\n\n_, _, zc = nodes(grid, Center(), Center(), Center())\ntimes = N.times\n\nhmN = heatmap!(axN, times ./ year, zc, N[1, 1, 1:grid.Nz, 1:end]', interpolate = true, colormap = Reverse(:batlow))\n\nhmP = heatmap!(axP, times ./ year, zc, P[1, 1, 1:grid.Nz, 1:end]', interpolate = true, colormap = Reverse(:batlow))\n\nlines!(axSed, times ./ year, sed[1, 1, 1, :])\n\nColorbar(fig[1, 2], hmN, label = \"Nutrient (mmol N / m³)\")\nColorbar(fig[2, 2], hmP, label = \"Phytoplankton (mmol N / m³)\")\n\nfig","category":"page"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"We can see in this that some phytoplankton sink to the bottom, and are both remineralized back into nutrients and stored in the sediment.","category":"page"},{"location":"model_implementation/#Final-notes","page":"Implementing new models","title":"Final notes","text":"","category":"section"},{"location":"model_implementation/","page":"Implementing new models","title":"Implementing new models","text":"When implementing a new model we recommend following a testing process as we have here, starting with a box model, then a column, and finally using it in a realistic physics scenarios. We have found this very helpful for spotting bugs that were proving difficult to decipher in other situations. You can also add Individuals, light attenuation models, and sediment models in a similar fashion.","category":"page"},{"location":"generated/O₂ air-sea exchange_parameters/#O-air-sea-exchange-default-parameters","page":"O₂ air-sea exchange","title":"O₂ air-sea exchange default parameters","text":"","category":"section"},{"location":"generated/O₂ air-sea exchange_parameters/","page":"O₂ air-sea exchange","title":"O₂ air-sea exchange","text":"Name Value\ngas Val{:O₂}()\nschmidt_params (A = 1953.4, B = 128.0, C = 3.9918, D = 0.050091)\nsolubility_params (A₁ = -58.3877, A₂ = 85.8079, A₃ = 23.8439, B₁ = -0.034892, B₂ = 0.015568, B₃ = -0.0019387)\nocean_density 1024.5\nair_concentration 9352.7\nair_pressure 1.0\naverage_wind_speed 10.0","category":"page"},{"location":"model_components/individuals/slatissima/#SLatissima","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar kelp (Saccharina latissima) individuals","text":"","category":"section"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"We have implemented a model of sugar kelp growth within this spatially infinitesimal Lagrangian particles framework originally based on the model of Broch and Slagstad (2012) and updated by Broch et al. (2013), Fossberg et al. (2018), and Broch et al. (2019). This is the same model passively forced by Strong-Wright and Taylor (2022).","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"The model tracks three variables, the frond area, A (dm²), carbon reserve, C (gC / gSW), and nitrate reserve, N (gN / gSW). The growth depends on the nitrate (and optionally ammonia) availability in the water, the temperature, and light availability. The minimum required coupling is with nitrates so the model can be coupled with an NPZD model, but can optionally uptake ammonia, DIC (CO₂), oxygen, and release dissolved organic matter (from exudation) and large detritus.  ","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"Results could look something like this (from Strong-Wright and Taylor (2022)): (Image: Example A, N, and C profiles from [StrongWright2022](@citet))","category":"page"},{"location":"model_components/individuals/slatissima/#Model-equations","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Model equations","text":"","category":"section"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"As per Broch and Slagstad (2012) this model variables evolve as:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"fracdAdt = left(mu - nuright)A","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"fracdNdt = J - mu(N + N_textstruct)","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"fracdCdt = P(1 - E) - R - mu(C + C_textstruct)","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"The apical frond loss given by:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"nu = frac10^-6exp(varepsilon A)1 + 10^-6(exp(varepsilon A) - 1)","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"The growth given by:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"mu = f_textareaf_textseasonalf_texttempminleft(mu_c max(mu_NO_3 mu_NH_4)right)","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"where:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"f_textarea = m_1exp(-(AA_0)^2) + m_2","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"f_textseasonal = a_1(1 + textsgn(lambda(n))lambda(n)^12) + a_2","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"f_texttemp = left beginarrayll\n                    008T + 02  -18leq T  10 \n                    1            10 leq T leq 15 \n                    194 - T4   15  T leq 19 \n                    0            T  19\n                 endarray right","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"where n is the day of the year, lambda is the normalised day length change, and T is the temperature in degrees centigrade. The limiting rates (mu_c, mu_NO_3, mu_NH_4) depend on the availability of carbon giving:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"mu_c = 1 - fracC_textminC","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"and on the available nitrogen which is either limited by the instantanious uptake of ammonia, or the nitrogen reserve. To find these limits J, the nutrient uptake, must first be found (Fossberg et al., 2018). The uptake is calculated by first finding the NO_3 uptake rate:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"J_NO_3 = J_NO_3text maxf_textcurrfracN_textmax - NN_textmax - N_textminfracNO_3k_NO_3 + NO_3","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"where f_curr = c_1(1 - exp(-u  c_2)) + c_3 (Broch et al., 2019) where u is the relative current speed. We then calculate the potential ammonia uptake:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"tildeJ_NH_4 = J_NH_4text maxf_textcurrfracNH_4k_NH_4 + NH_4","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"This results in a theoretical instantaneous area increase rate of:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"mu_NH_4 = frac1N_textmin + N_textstructfractildeJ_NH_4k_A","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"or growth from reserves of:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"mu_NO_3 = 1 - fracN_textminN","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"The actual resulting ammonia uptake is then:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"J_NH_4 = minleft(tildeJ_NH_4 mu k_A (N_textmin + N_textstruct)right)","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"and the total uptake J = fracJ_NH_4 + J_NO_3k_A.","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"The production of carbon from photosynthesis is given by:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"P = P_Sleft1 - expleft(fracalpha PARP_Sright)rightexpleft(fracbeta PARP_Sright)","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"where PAR is the photosynthetically available radiation and","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"P_S = fracalpha I_textsatln(1 + alphabeta)","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"alpha is a constant but beta depends on the maximum photosynthetic rate which is defined by both:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"P_textmax = fracalpha I_textsatln(1 + alphabeta)left(fracalphaalpha + betaright)left(fracbetaalpha + betaright) ^ betaalpha","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"and","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"P_textmax = fracP_1expleft(fracT_APT_P1 - fracT_APTright)1 + expleft(fracT_APLT - fracT_APLT_PLright) + expleft(fracT_APHT - fracT_APHT_PHright)","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"where T is the temperature in kelvin and the T_X are Arrhenius temperature constants. We solve these iteratively to find beta.","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"The exudation fraction is given by:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"E = 1 - expleft(gamma(C_min - C)right)","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"As per Broch et al. (2013) R, the respiration rate, is given by:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"R = leftR_Aleft(fracmumu_textmax + fracJJ_textmaxright) + R_Brightexpleft(fracT_ARRT_1 - fracT_ARRTright)","category":"page"},{"location":"model_components/individuals/slatissima/#Parameter-variable-names","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Parameter variable names","text":"","category":"section"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"Symbol Variable name Units\nA_0 growth_rate_adjustement 1 / dm²\nalpha photosynthetic_efficiency gC / dm² / s / einstein\nC_textmin minimum_carbon_reserve gC / gSW\nC_textstruct structural_carbon gC / gSW\ngamma exudation gC / g\nvarepsilon erosion 1 / dm²\nI_textsat saturation_irradiance einstein\nk_A structural_dry_weight_per_area g / dm²\nk_dw structural_dry_to_wet_weight -\nk_C carbon_reserve_per_carbon g / gC\nk_N nitrogen_reserve_per_nitrogen g / gN\nN_textmin minimum_nitrogen_reserve gN / gSW\nN_textmax maximum_nitrogen_reserve gN / gSW\nm_2 growth_adjustement_2 -\nm_1 growth_adjustement_1 -\nmu_textmax maximum_specific_growth_rate 1 / s\nN_textstruct structural_nitrogen gN / gSW\nP_1 photosynthesis_at_ref_temp_1 gC / dm² / s\nP_2 photosynthesis_at_ref_temp_2 gC / dm² / s\nT_P1 photosynthesis_ref_temp_1 °K\nT_P2 photosynthesis_ref_temp_2 °K\na_1 photoperiod_1 -\na_2 photoperiod_2 -\nR_1 respiration_at_ref_temp_1 gC / dm² / s\nR_2 respiration_at_ref_temp_2 gC / dm² / s\nT_R1 respiration_ref_temp_1 °K\nT_R2 respiration_ref_temp_2 °K\nT_AP photosynthesis_arrhenius_temp °K\nT_PL photosynthesis_low_temp °K\nT_PH photosynthesis_high_temp °K\nT_APL photosynthesis_high_arrhenius_temp °K\nT_APH photosynthesis_low_arrhenius_temp °K\nT_ARR respiration_arrhenius_temp °K\nu_0p65 current_speed_for_0p65_uptake m / s\nk_NO_3 nitrate_half_saturation mmol N / m³\nk_NH_4 ammonia_half_saturation mmol N / m³\nJ_NO_3text max maximum_nitrate_uptake gN / dm² / s\nJ_NH_4text max maximum_ammonia_uptake gN / dm² / s\nc_1 current_1 -\nc_2 current_2 1 / m / s\nc_3 current_3 -\nR_A respiration_reference_A gC / dm² / s\nR_B respiration_reference_B gC / dm² / s\n- exudation_redfield_ratio mmol C / mmol N","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"All default parameter values are given in Parameters.","category":"page"},{"location":"model_components/individuals/slatissima/#Model-conservations","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Model conservations","text":"","category":"section"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"Total nitrogen (and carbon where appropriate) are conserved between the individuals and biogeochemistry. The total nitrogen in each individual is:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"N_texttotal = Ak_A(N + N_textstruct)","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"and carbon:","category":"page"},{"location":"model_components/individuals/slatissima/","page":"Sugar Kelp (Broch and Slagstad 2012 ++)","title":"Sugar Kelp (Broch and Slagstad 2012 ++)","text":"C_texttotal = Ak_A(C + C_textstruct)","category":"page"},{"location":"contributing/#Contributors-Guide","page":"Contibutors guide","title":"Contributors Guide","text":"","category":"section"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"Thank you for considering contributions to OceanBioME! We hope this guide helps.","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"Feel free to ask us questions and chat with us at any time about any topic at all by:","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"Opening a GitHub issue\nCreating a GitHub discussion","category":"page"},{"location":"contributing/#Creating-issues","page":"Contibutors guide","title":"Creating issues","text":"","category":"section"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"The simplest way to contribute to OceanBioME is to create or comment on issues and discussions.","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"The most useful bug reports:","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"Provide an explicit code snippet –- not just a link –- that reproduces the bug in the latest tagged version of OceanBioME. This is sometimes called the \"minimal working example\". Reducing bug-producing code to a minimal example can dramatically decrease the time it takes to resolve an issue.\nPaste the entire error received when running the code snippet, even if it's unbelievably long.\nUse triple backticks (e.g., ```some_code; and_some_more_code;```) to enclose code snippets, and other markdown formatting syntax to make your issue easy and quick to read.\nReport the OceanBioME version, Julia version, machine (especially if using a GPU) and any other possibly useful details of the computational environment in which the bug was created.","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"Discussions are recommended for asking questions about (for example) the user interface, implementation details, science, and life in general.","category":"page"},{"location":"contributing/#But-I-want-to-*code*!","page":"Contibutors guide","title":"But I want to code!","text":"","category":"section"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"New users help write OceanBioME code and documentation by forking the OceanBioME repository, using git to edit code and docs, and then creating a pull request. Pull requests are reviewed by OceanBioME collaborators.\nA pull request can be merged once it is reviewed and approved by collaborators. If the pull request author has write access, they have the responsibility of merging their pull request. Otherwise, OceanBioME.jl collaborators will execute the merge with permission from the pull request author.\nNote: for small or minor changes (such as fixing a typo in documentation), the GitHub editor is super useful for forking and opening a pull request with a single click.\nWrite your code with love and care. In particular, conform to existing OceanBioME style and formatting conventions. For example, we love verbose and explicit variable names, use TitleCase for types, snake_case for objects, and always.put.spaces.after.commas. For formatting decisions we loosely follow the YASGuide. It's worth few extra minutes of our time to leave future generations with well-written, readable code.","category":"page"},{"location":"contributing/#What-is-a-\"collaborator\"-and-how-can-I-become-one?","page":"Contibutors guide","title":"What is a \"collaborator\" and how can I become one?","text":"","category":"section"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"Collaborators have permissions to review pull requests and status allows a contributor to review pull requests in addition to opening them. Collaborators can also create branches in the main OceanBioME repository.\nWe ask that new contributors try their hand at forking OceanBioME, and opening and merging a pull request before requesting collaborator status.","category":"page"},{"location":"contributing/#What's-a-good-way-to-start-developing-OceanBioME?","page":"Contibutors guide","title":"What's a good way to start developing OceanBioME?","text":"","category":"section"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"Tackle an existing issue. We keep a list of good first issues that are self-contained and suitable for a newcomer to try and work on.\nTry to run OceanBioME and play around with it. If you run into any problems or find it difficult to use or understand, please open an issue!\nWrite up an example or tutorial on how to do something useful with OceanBioME, like how to set up a new configuration.\nImprove documentation or comments if you found something hard to use.\nImplement a new feature if you need it to use OceanBioME.","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"If you're interested in working on something, let us know by commenting on existing issues or  by opening a new issue. This is to make sure no one else is working on the same issue and so  we can help and guide you in case there is anything you need to know beforehand.","category":"page"},{"location":"contributing/#Ground-Rules","page":"Contibutors guide","title":"Ground Rules","text":"","category":"section"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"Each pull request should consist of a logical collection of changes. You can include multiple bug fixes in a single pull request, but they should be related. For unrelated changes, please submit multiple pull requests.\nDo not commit changes to files that are irrelevant to your feature or bugfix (eg: .gitignore).\nBe willing to accept criticism and work on improving your code; we don't want to break other users' code, so care must be taken not to introduce bugs. We discuss pull requests and keep working on them until we believe we've done a good job.\nBe aware that the pull request review process is not immediate, and is generally proportional to the size of the pull request.","category":"page"},{"location":"contributing/#Reporting-a-bug","page":"Contibutors guide","title":"Reporting a bug","text":"","category":"section"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"The easiest way to get involved is to report issues you encounter when using OceanBioME or by requesting something you think is missing.","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"Head over to the issues page.\nSearch to see if your issue already exists or has even been solved previously.\nIf you indeed have a new issue or request, click the \"New Issue\" button.\nPlease be as specific as possible. Include the version of the code you were using, as well as what operating system you are running. The output of Julia's versioninfo() and ] status is helpful to include. Try your best to include a complete, \"minimal working example\" that reproduces the issue.","category":"page"},{"location":"contributing/#Setting-up-your-development-environment","page":"Contibutors guide","title":"Setting up your development environment","text":"","category":"section"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"Install Julia on your system.\nInstall git on your system if it is not already there (install XCode command line tools on a Mac or git bash on Windows).\nLogin to your GitHub account and make a fork of the OceanBioME repository by clicking the \"Fork\" button.\nClone your fork of the OceanBioME repository (in terminal on Mac/Linux or git shell/ GUI on Windows) in the location you'd like to keep it.\ngit clone https://github.com/your-user-name/OceanBioME.jl.git\nNavigate to that folder in the terminal or in Anaconda Prompt if you're on Windows.\nConnect your repository to the upstream (main project).\ngit remote add oceananigans https://github.com/OceanBioME/OceanBioME.jl.git\nCreate the development environment by opening Julia via julia --project then typing in ] instantiate. This will install all the dependencies in the Project.toml file.\nYou can test to make sure OceanBioME works by typing in ] test. Doing so will run all the tests (and this can take a while).","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"Your development environment is now ready!","category":"page"},{"location":"contributing/#Pull-Requests","page":"Contibutors guide","title":"Pull Requests","text":"","category":"section"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"We follow the ColPrac guide for collaborative practices. We ask that new contributors read that guide before submitting a pull request.","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"Changes and contributions should be made via GitHub pull requests against the main branch.","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"When you're done making changes, commit the changes you made. Chris Beams has written a  guide on how to write good commit messages.","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"When you think your changes are ready to be merged into the main repository, push to your fork and submit a pull request.","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"Working on your first Pull Request? You can learn how from this free video series How to Contribute to an Open Source Project on GitHub, Aaron Meurer's tutorial on the git workflow, or the guide “How to Contribute to Open Source\".","category":"page"},{"location":"contributing/#Documentation","page":"Contibutors guide","title":"Documentation","text":"","category":"section"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"Now that you've made your awesome contribution, it's time to tell the world how to use it. Writing documentation strings is really important to make sure others use your functionality properly. Didn't write new functions? That's fine, but be sure that the documentation for the code you touched is still in great shape. It is not uncommon to find some strange wording or clarification that you can take care of while you are here.","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"You can preview how the Documentation will look like after merging by building the documentation  locally. From the main directory of your local repository call","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"JULIA_DEBUG=Documenter julia --project=docs/ docs/make.jl","category":"page"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"and then open docs/build/index.html in your favorite browser. Providing the environment variable  JULIA_DEBUG=Documenter will provide with more information in the documentation build process and thus help figuring out a potential bug.","category":"page"},{"location":"contributing/#Credits","page":"Contibutors guide","title":"Credits","text":"","category":"section"},{"location":"contributing/","page":"Contibutors guide","title":"Contibutors guide","text":"This contributor's guide is heavily based on the excellent Oceananigans contributors guide which in turn is based on the MetPy contributor's guide.","category":"page"},{"location":"generated/TwoBandPhotosyntheticallyActiveRadiation_parameters/#TwoBandPhotosyntheticallyActiveRadiation-default-parameters","page":"TwoBandPhotosyntheticallyActiveRadiation","title":"TwoBandPhotosyntheticallyActiveRadiation default parameters","text":"","category":"section"},{"location":"generated/TwoBandPhotosyntheticallyActiveRadiation_parameters/","page":"TwoBandPhotosyntheticallyActiveRadiation","title":"TwoBandPhotosyntheticallyActiveRadiation","text":"Name Value\nwater_red_attenuation 0.225\nwater_blue_attenuation 0.0232\nchlorophyll_red_attenuation 0.037\nchlorophyll_blue_attenuation 0.074\nchlorophyll_red_exponent 0.629\nchlorophyll_blue_exponent 0.674\npigment_ratio 0.7\nphytoplankton_chlorophyll_ratio 1.31\nsurface_PAR #3","category":"page"},{"location":"model_components/biogeochemical/NPZ/#NPZD","page":"NPZD","title":"Nutrient Phytoplankton Zooplankton Detritus (NPZD) model","text":"","category":"section"},{"location":"model_components/biogeochemical/NPZ/","page":"NPZD","title":"NPZD","text":"The provided NPZD model is the low complexity model of Kuhn et al. (2015).","category":"page"},{"location":"model_components/biogeochemical/NPZ/","page":"NPZD","title":"NPZD","text":"<img src=\"../npzd.svg\"  alt=\"Diagram of NPZD formulation\" style=\"max-width: calc(100% - 20px);\">","category":"page"},{"location":"model_components/biogeochemical/NPZ/#Model-equations","page":"NPZD","title":"Model equations","text":"","category":"section"},{"location":"model_components/biogeochemical/NPZ/","page":"NPZD","title":"NPZD","text":"fracpartial Ppartial t = mu_textmaxfracNk_N + Nfracalpha PARsqrtmu_textmax^2 + alpha^2PAR^2P - g_textmaxfracP^2k_P^2 + P^2Z-(l_PN+l_PD)P","category":"page"},{"location":"model_components/biogeochemical/NPZ/","page":"NPZD","title":"NPZD","text":"fracpartial Zpartial t = beta g_textmaxfracP^2k_P^2 + P^2Z - (l_ZN + l_ZDZ)Z","category":"page"},{"location":"model_components/biogeochemical/NPZ/","page":"NPZD","title":"NPZD","text":"fracpartial Dpartial t = (1 - beta) g_textmaxfracP^2k_P^2 + P^2Z + l_ZDZ^2 + l_PDP - r_DND","category":"page"},{"location":"model_components/biogeochemical/NPZ/","page":"NPZD","title":"NPZD","text":"fracpartial Npartial t = - mu_textmaxfracNk_N + Nfracalpha PARsqrtmu_textmax^2 + alpha^2PAR^2P + l_PNP + l_ZNZ + r_DND","category":"page"},{"location":"model_components/biogeochemical/NPZ/","page":"NPZD","title":"NPZD","text":"Here mu_textmax = mu_0Q_10(T) and l_XY = l_XY0 Q_10(T) where Q_10(T) = 188^T10.","category":"page"},{"location":"model_components/biogeochemical/NPZ/","page":"NPZD","title":"NPZD","text":"Additionally, the phytoplankton and detritus sink at a constant rate.","category":"page"},{"location":"model_components/biogeochemical/NPZ/#Parameter-variable-names","page":"NPZD","title":"Parameter variable names","text":"","category":"section"},{"location":"model_components/biogeochemical/NPZ/","page":"NPZD","title":"NPZD","text":"Symbol Variable name Units\nalpha initial_photosynthetic_slope 1 / (W / m² / s)\nmu_0 base_maximum_growth 1 / s\nk_N nutrient_half_saturation mmol N / m³\nl_PN0 base_respiration_rate 1 / s\nl_PD0 phyto_base_mortality_rate 1 / s\ng_textmax maximum_grazing_rate 1 / s\nk_P grazing_half_saturation mmol N / m³\nbeta assimulation_efficiency -\nl_ZN base_excretion_rate 1 / s\nl_ZD zoo_base_mortality_rate 1 / s\nr_DN remineralization_rate 1 / s","category":"page"},{"location":"model_components/biogeochemical/NPZ/","page":"NPZD","title":"NPZD","text":"All default parameter values are given in Parameters.","category":"page"},{"location":"model_components/biogeochemical/NPZ/#Model-conservation","page":"NPZD","title":"Model conservation","text":"","category":"section"},{"location":"model_components/biogeochemical/NPZ/","page":"NPZD","title":"NPZD","text":"Nitrogen is conserved in the evolution of this model (excluding external sources and sinking), i.e. fracpartial Ppartial t + fracpartial Zpartial t + fracpartial Dpartial t + fracpartial Npartial t = 0.","category":"page"},{"location":"appendix/function_index/#Index","page":"Function index","title":"Index","text":"","category":"section"},{"location":"appendix/function_index/","page":"Function index","title":"Function index","text":"","category":"page"},{"location":"visualization/#Visualize-output","page":"Visualization","title":"Visualize output","text":"","category":"section"},{"location":"visualization/","page":"Visualization","title":"Visualization","text":"In the examples we use Makie.jl for plotting.","category":"page"},{"location":"visualization/","page":"Visualization","title":"Visualization","text":"Makie comes with a few backends. In the documented examples we use CairoMakie since this backend works well on headless devices, that is, devices without monitor. Because the documentation is automatically built via GitHub actions the CairoMakie backend is necessary. However, users that want to run the examples on devices with a monitor might want to change to GLMakie that displays figures in an interactive window. To do that you need to install GLMakie, e.g.,","category":"page"},{"location":"visualization/","page":"Visualization","title":"Visualization","text":"using Pkg\npkg\"add GLMakie\"","category":"page"},{"location":"visualization/","page":"Visualization","title":"Visualization","text":"and replace using CairoMakie with using GLMakie.","category":"page"},{"location":"generated/CO₂ air-sea exchange_parameters/#CO-air-sea-exchange-default-parameters","page":"CO₂ air-sea exchange","title":"CO₂ air-sea exchange default parameters","text":"","category":"section"},{"location":"generated/CO₂ air-sea exchange_parameters/","page":"CO₂ air-sea exchange","title":"CO₂ air-sea exchange","text":"Name Value\ngas Val{:CO₂}()\nschmidt_params (A = 2073.1, B = 125.62, C = 3.6276, D = 0.043219)\nsolubility_params (A₁ = -60.2409, A₂ = 93.4517, A₃ = 23.3585, B₁ = 0.023517, B₂ = -0.023656, B₃ = 0.0047036)\nocean_density 1024.5\nair_concentration 413.4\nair_pressure 1.0\naverage_wind_speed 10.0","category":"page"},{"location":"generated/OceanBioME.Boundaries.pCO₂_parameters/#OceanBioME.Boundaries.pCO-default-parameters","page":"OceanBioME.Boundaries.pCO₂","title":"OceanBioME.Boundaries.pCO₂ default parameters","text":"","category":"section"},{"location":"generated/OceanBioME.Boundaries.pCO₂_parameters/","page":"OceanBioME.Boundaries.pCO₂","title":"OceanBioME.Boundaries.pCO₂","text":"Name Value\nsolubility (C = -162.8301, invT = 21829.68, logCT = 0.01, ClogT = 90.9241, T² = -0.000147696, ST² = 4.9867e-7, ST = -0.00025225000000000003, S = 0.025695)\nbicarbonate_dissociation (C = 62.008, S = 0.0118, S² = -0.000116, invT = -3670.7, logT = -9.7944)\ncarbonate_dissociation (C = -4.777, S = 0.0184, S² = -0.000118, invT = -1394.7, logT = 0.0)\nboric_acid_dissociation (C = 148.0248, invT = -8966.9, invTsqrtS = -2890.53, invTS = -77.942, invTS¹⁵ = 1.728, invTS² = -0.0996, sqrtS = 137.1942, S = 1.62142, logT = -24.4344, logTsqrtS = -25.085, logTS = -0.2474, TsqrtS = 0.053105)\nwater_dissociaiton (C = 148.9652, invT = -13847.26, logT = -23.6521, sqrtSinvT = 118.67, sqrtS = -5.977, sqrtSlogT = 1.0495, S = -0.01615)\nlower_pH_bound 0.0\nupper_pH_bound 14.0\nboron_ratio 1.1878787997327509e-5\nthermal_expansion 0.000167\nhaline_contraction 0.00078","category":"page"},{"location":"generated/NutrientPhytoplanktonZooplanktonDetritus_parameters/#NutrientPhytoplanktonZooplanktonDetritus-default-parameters","page":"NutrientPhytoplanktonZooplanktonDetritus","title":"NutrientPhytoplanktonZooplanktonDetritus default parameters","text":"","category":"section"},{"location":"generated/NutrientPhytoplanktonZooplanktonDetritus_parameters/","page":"NutrientPhytoplanktonZooplanktonDetritus","title":"NutrientPhytoplanktonZooplanktonDetritus","text":"Name Value\ninitial_photosynthetic_slope 2.2604166666666667e-6\nbase_maximum_growth 8.08912037037037e-6\nnutrient_half_saturation 2.3868\nbase_respiration_rate 7.638888888888889e-7\nphyto_base_mortality_rate 1.1689814814814814e-7\nmaximum_grazing_rate 2.4909722222222224e-5\ngrazing_half_saturation 0.5573\nassimulation_efficiency 0.9116\nbase_excretion_rate 1.1805555555555556e-7\nzoo_base_mortality_rate 3.929398148148148e-6\nremineralization_rate 1.4039351851851852e-6\nP sinking speed 2.9525462962962963e-6\nD sinking speed 3.181597222222222e-5","category":"page"},{"location":"model_components/light/#light","page":"Light attenuation models","title":"Light attenuation models","text":"","category":"section"},{"location":"model_components/light/","page":"Light attenuation models","title":"Light attenuation models","text":"Nearly all BGC models require some model of the attenuation of PAR through the water. Usually this depends on the concentration of chlorophyll in the water (in phytoplankton), and may depend on the concentration of coloured dissolved organic matter or particulates.","category":"page"},{"location":"model_components/light/","page":"Light attenuation models","title":"Light attenuation models","text":"We currently have two models of light attenuation, a two band model by Karleskind et al. (2011) and the more widely used three band model by Morel (1988). As the light level is diagnostic of the phytoplankton concentration these models are implemented with the light level as various auxiliary fields which are updated with callbacks within the biogeochemical model.","category":"page"},{"location":"model_components/light/","page":"Light attenuation models","title":"Light attenuation models","text":"Models requiring light attenuation models will set these up automatically, for example LOBSTER sets light_attenuation_model = TwoBandPhotosyntheticallyActiveRadiation(). You may choose others. Additionally, you can pass the surface PAR as a function of horizontal position and time. The default for LOBSTER is (x, y, t) -> 100*max(0.0, cos(t*π/(12hours))).","category":"page"},{"location":"model_components/light/#Model-equations-(for-the-two-band-model)","page":"Light attenuation models","title":"Model equations (for the two band model)","text":"","category":"section"},{"location":"model_components/light/","page":"Light attenuation models","title":"Light attenuation models","text":"Light attenuation is calculated by integrating attenuation (from the surface). The PAR is considered as two components attenuated at different rates. At depth z the total PAR is given by:","category":"page"},{"location":"model_components/light/","page":"Light attenuation models","title":"Light attenuation models","text":"PAR = fracPAR_02 leftexpleft(k_rz + chi_rint_z=0^z Chl_r dzright) + expleft(k_bz + chi_bint_z=0^z Chl_b dzright)right","category":"page"},{"location":"model_components/light/","page":"Light attenuation models","title":"Light attenuation models","text":"where PAR_0 is the surface value, k_r and k_b are the red and blue attenuation coefficients of water, chi_r and chi_b are the red and blue chlorophyll attenuation coefficients, and Chl_r and Chl_b are the red and blue chlorophyll pigment concentrations. The chlorophyll pigment concentration is derived from the phytoplankton concentration where it is assumed that the pigment concentration is given by:","category":"page"},{"location":"model_components/light/","page":"Light attenuation models","title":"Light attenuation models","text":"Chl = PR_ChlP","category":"page"},{"location":"model_components/light/","page":"Light attenuation models","title":"Light attenuation models","text":"where the ratio is constant and found in Parameters. The red and blue pigment concentrations are then found as Chl_r = left(fracChlr_textpigright)^e_r and Chl_b = left(fracChlr_textpigright)^e_b. ","category":"page"},{"location":"model_components/light/#Parameter-variable-names","page":"Light attenuation models","title":"Parameter variable names","text":"","category":"section"},{"location":"model_components/light/","page":"Light attenuation models","title":"Light attenuation models","text":"Symbol Variable name Units\nk_r water_red_attenuation 1 / m\nk_b water_blue_attenuation 1 / m\nchi_r chlorophyll_red_attenuation 1 / m / (mg Chl / m³) ^ e_r\nchi_b chlorophyll_blue_attenuation 1 / m / (mg Chl / m³) ^ e_b\ne_r chlorophyll_red_exponent -\ne_b chlorophyll_blue_exponent -\nr_textpig pigment_ratio -\nR_ChlP phytoplankton_chlorophyll_ratio mg Chl / mmol N","category":"page"},{"location":"model_components/sediments/#sediment","page":"Overview","title":"Sediment","text":"","category":"section"},{"location":"model_components/sediments/","page":"Overview","title":"Overview","text":"Sediment models can be added to biogeochemical models. For details of the BGC models currently implemented please see the following pages. ","category":"page"},{"location":"model_components/sediments/","page":"Overview","title":"Overview","text":"Sediment models are usually added by setting up the model and then passing it to the biogeochemical model, for example:","category":"page"},{"location":"model_components/sediments/","page":"Overview","title":"Overview","text":"sediment = SEDIMENT_MODEL_NAME(; grid)\n\nbiogeochemistry = BIOGEOCHEMICAL_MODEL_NAME(; name, sediment, ...)","category":"page"},{"location":"model_components/sediments/","page":"Overview","title":"Overview","text":"where SEDIMENT_MODEL_NAME is the chosen sediment model, and BIOGEOCHEMICAL_MODEL_NAME is the chosen biogeochemical model and ... replaces the other parameters you may wish to pass to the model.","category":"page"},{"location":"model_components/sediments/","page":"Overview","title":"Overview","text":"Please note that not all sediment models are compatible with all biogeochemical models. This will be noted on the documentation page for each model.","category":"page"},{"location":"generated/LOBSTER_parameters/#LOBSTER-default-parameters","page":"LOBSTER","title":"LOBSTER default parameters","text":"","category":"section"},{"location":"generated/LOBSTER_parameters/","page":"LOBSTER","title":"LOBSTER","text":"Name Value\nphytoplankton_preference 0.5\nmaximum_grazing_rate 9.26e-6\ngrazing_half_saturation 1.0\nlight_half_saturation 33.0\nnitrate_ammonia_inhibition 3.0\nnitrate_half_saturation 0.7\nammonia_half_saturation 0.001\nmaximum_phytoplankton_growthrate 1.21e-5\nzooplankton_assimilation_fraction 0.7\nzooplankton_mortality 2.31e-6\nzooplankton_excretion_rate 5.8e-7\nphytoplankton_mortality 5.8e-7\nsmall_detritus_remineralisation_rate 5.88e-7\nlarge_detritus_remineralisation_rate 5.88e-7\nphytoplankton_exudation_fraction 0.05\nnitrifcaiton_rate 5.8e-7\nammonia_fraction_of_exudate 0.75\nammonia_fraction_of_excriment 0.5\nammonia_fraction_of_detritus 0.0\nphytoplankton_redfield 6.56\norganic_redfield 6.56\nphytoplankton_chlorophyll_ratio 1.31\norganic_carbon_calcate_ratio 0.1\nrespiraiton_oxygen_nitrogen_ratio 10.75\nnitrifcation_oxygen_nitrogen_ratio 2.0\nslow_sinking_mortality_fraction 0.5\nfast_sinking_mortality_fraction 0.5\ndisolved_organic_breakdown_rate 3.86e-7\nzooplankton_calcite_dissolution 0.3\nsPOM sinking speed 3.47e-5\nbPOM sinking speed 0.0023148148148148147","category":"page"},{"location":"model_components/air-sea-gas/#air-sea-gas","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"","category":"section"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"We currently have one air-sea gas exchange model implemented. The model, proposed by Wanninkhof (1992), calculates the solubility of the gas in the water dependent on the temperature and salinity, and calculates the flux depending on the solubility and mixing from the wind.","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"Currently, the parameters for CO₂ and oxygen are included, but it would be very straightforward to add the parameters given in the original publication for other gases (e.g. inert tracers of other nutrients such as N₂). We also currently have a very simple formulation of the gas transfer velocity which depends on an average wind speed, but it would straightforwardly be expanded to permit variable wind speed (e.g. to simulate enhanced exchange from storms).","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"It is straightforward to set up a boundary as an air-sea gas exchange:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"using OceanBioME\nCO₂_flux = GasExchange(; gas = :CO₂)\nusing Oceananigans\n\ngrid = RectilinearGrid(size=(3, 3, 30), extent=(10, 10, 200));\n\nmodel = NonhydrostaticModel(; grid,\n                              biogeochemistry = LOBSTER(; grid, carbonates = true),\n                              boundary_conditions = (DIC = FieldBoundaryConditions(top = CO₂_flux), ))","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"using OceanBioME\n\nCO₂_flux = GasExchange(; gas = :CO₂)","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"Where the symbol specifies the exchanged gas (currently :CO₂ or :O₂). This can then be passed in the setup of a BGC model, for example:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"using Oceananigans\n\ngrid = RectilinearGrid(size=(3, 3, 30), extent=(10, 10, 200));\n\nmodel = NonhydrostaticModel(; grid,\n                              biogeochemistry = LOBSTER(; grid, carbonates = true),\n                              boundary_conditions = (DIC = FieldBoundaryConditions(top = CO₂_flux), ))","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"If the temperature and salinity are not included in the model they can be passed as functions (or even anonymous functions):","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"T_function(x, y, z, t) = 12.0\n\nCO₂_flux = GasExchange(; gas = :CO₂, temperature = T_function, salinity = (args...) -> 35)","category":"page"},{"location":"model_components/air-sea-gas/#Model-equations","page":"Air-sea gas exchange","title":"Model equations","text":"","category":"section"},{"location":"model_components/air-sea-gas/#Gas-transfer","page":"Air-sea gas exchange","title":"Gas transfer","text":"","category":"section"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"The gas flux is given by:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"F = k(C_w - alpha C_a)","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"where C_w is the concentration in the water, C_a the concentration in the air, alpha the Oswald solubility coefficient, and k the gas transfer velocity. For carbon dioxide the flux is modified to:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"F = kbetarho_o(pCO_2w - pCO_2a)","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"where pCO_2w and pCO_2a are the partial pressure of carbon dioxide in the water and air, beta is the Bunsen Solubility Coefficient, and rho_o is the density of the water.","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"The gas transfer velocity is parameterised by the wind speed and Schmidt number, which in turn is parameterised by the temperature and salinity. The gas transfer velocity is given by:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"k = 108times10^-6u^2left(fracSc660right)^-12","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"where u is the winds speed 10m above the surface, and Sc is the Schmidt number parameterised as:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"Sc = A - BT + CT^2 - DT^3","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"where T is temperature in Kelvin and the other parameters are dependent on the gas type and given in Parameters.","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"The solubilities are given by:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"alpha = 000367 T expA_1 + 100fracA_2T + A_3 lnfracT100 + Sleft(B_1 + fracB_2T + fracB_3T^2right)","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"and","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"beta = expA_1 + 100fracA_2T + A_3 lnfracT100 + Sleft(B_1 + fracB_2T + fracB_3T^2right)","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"where S is salinity in practical units and the other default parameters are given in Parameters.","category":"page"},{"location":"model_components/air-sea-gas/#Partial-pressure-of-carbon-dioxide","page":"Air-sea gas exchange","title":"Partial pressure of carbon dioxide","text":"","category":"section"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"We currently do not have the full OCMIP partial pressure formulation, instead we follow the simplified formulation (as used in Aumont et al. (2015)) where the partial pressure of CO_2 (muatm) in gas is found from:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"pCO_2a = f_CO_2P_a","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"where f_CO_2 is the air fraction (ppmv), and P_a is the atmospheric pressure (atm). The ocean partial pressure (muatm) is derived from the dissolved inorganic carbon content, and alkalinity, as described by MacAladay (1998), from the equilibrium of the following chemical system:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"ceCO_2(g) ce= CO_2(aq) K_0=fracceO_2(aq)cepCO_2","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"ceCO_2(aq) + H_2Oce= H^+ + HCO^-_3 K_1=fracceHCO^-_3H^+ceCO_2(aq)","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"ceHCO^-_3 ce= H^+ + CO^2-_3 K_2=fracceCO^2-_3H^+ceHCO^-_3","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"ceH_2O ce= H^+ + OH^-","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"These have rates constants:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"K_0 = fracceCO_2(aq)cepCO_2","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"K_1 = fracceHCO^-_3H^+ceCO_2(aq)","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"K_2=fracceCO^2-_3H^+ceHCO^-_3","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"K_w = ceOH^-H^+","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"In this system DIC and Alk are defined to be:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"ceDIC = ceCO_2(aq) + HCO^-_3 + CO_3^2-","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"ceAlk = ceHCO^-_3 + 2CO^2-_3 + B(OH)^-_4 + OH^- - H^+  + OH^- pm minor species","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"To solve this we must find the Boric acid dissociation from:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"ceB(OH)_3 =H^+ + B(OH)^-_4 K_B = fracceB(OH)^-_4H^+ceB(OH)_3","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"resulting in the equilibrium constant:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"K_B = fracceB(OH)^-_4H^+ceB(OH)_3","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"Finally, taking the DIC and Alkalinity in micro equivalents (i.e. scaled by 10^-3rho_o from mmol C/m^3) denoted by barDIC and barAlk, the carbonate alkalinity is given by Alk_C = barAlk + B(OH)^-_4 + OH^-, and we define the boron content, B, to be R_BSS mol/kg.","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"The system can be rearranged to give two equations for the carbonate alkalinity:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"ceAlk_C = DICfracK_1H + 2K^1K^2H^2 + K_1H+K_1K_2","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"ceAlk_C = ceAlk - fracK_WH - fracK_BBK_B + H","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"The equilibrium constants (K_0, K_1, and K_2) are given by:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"K_0  = expleft(A_0 + fracB_0T + C_0log(fracT100) + S  (D_0 - E_0T + F_0left(fracT100right)^2)right)","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"K_1 = expleft(A_1 - fracB_1T - C_1  log(T) - (D_1 + fracE_1T)sqrtS + F_1S - G_1S^15right)","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"K_2 = expleft(A_2 - fracB_2T - C_2 log(T) - (D_2 + fracE_2T)sqrtS + F_2S - G_1S^15right)","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"K_b = expleft(fracA_b - B_bsqrtS - C_bS + D_b  S^15 - E_bS^2T + F_b + G_B  sqrtS + H_b  S - (I_b + J_b sqrtS + S)  log(T) + L_b  sqrtS  Tright)","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"K_w = expleft(A_w + fracB_wT + C_w ln T + sqrtSleft(D_w + fracE_wT + F_w ln Tright)G_w Sright)","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"We solve these equations iteratively from an initial guess of pH=8 to find H, from which the partial pressure of CO_2 is calculated as:","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"pCO_2 = 10^6fracAlk_CH^2K_0(K_1H + 2 K_1K_2)","category":"page"},{"location":"model_components/air-sea-gas/#Parameter-variable-names","page":"Air-sea gas exchange","title":"Parameter variable names","text":"","category":"section"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"Gas transfer","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"Symbol Variable name Units\nA, B, C, D schmidt_params -\nA_i and B_i for iin1 2 3 solubility_params -","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"Partial pressure of carbon dioxide","category":"page"},{"location":"model_components/air-sea-gas/","page":"Air-sea gas exchange","title":"Air-sea gas exchange","text":"Symbol Variable name Units\nL_0 where L is a Latin character solubility -\nL_1 bicarbonate_dissociation -\nL_2 carbonate_dissociation -\nL_b boric_acid_dissociation -\nL_w water_dissociaiton -\nR_BS boron_ratio mol B / psu\nalpha thermal_expansion 1 / °K\nbeta haline_contraction 1 / psu","category":"page"},{"location":"model_components/biogeochemical/#bgc_models","page":"Overview","title":"Biogeochemical Models","text":"","category":"section"},{"location":"model_components/biogeochemical/","page":"Overview","title":"Overview","text":"Biogeochemical (BGC) models can be used within the Oceananigans biogeochemistry framework or as stand alone box models. All BGC models should be setup in the same way so that they can easily be substituted for each other. You can easily implement a different model (or a variation on a current model) by following the guide here.","category":"page"},{"location":"model_components/biogeochemical/","page":"Overview","title":"Overview","text":"For details of the BGC models currently implemented please see the following pages.","category":"page"},{"location":"model_components/biogeochemical/#Oceananigans-setup","page":"Overview","title":"Oceananigans setup","text":"","category":"section"},{"location":"model_components/biogeochemical/","page":"Overview","title":"Overview","text":"At the simplest level all that is required to setup a BGC model is to pass it to the Oceananigans model setup:","category":"page"},{"location":"model_components/biogeochemical/","page":"Overview","title":"Overview","text":"model = NonhydrostaticModel(; grid,\n                              ...,\n                              biogeochemistry = MODEL_NAME(; grid))","category":"page"},{"location":"model_components/biogeochemical/","page":"Overview","title":"Overview","text":"Where MODEL_NAME is the name of the model, you may also need to pass other parameters like:","category":"page"},{"location":"model_components/biogeochemical/","page":"Overview","title":"Overview","text":"MODEL_NAME(; grid, growth_rate = 10.0)","category":"page"},{"location":"model_components/biogeochemical/","page":"Overview","title":"Overview","text":"This will set up the required tracers and auxiliary fields, and you may also set boundary conditions or additional forcing through the normal Oceananigans setup. ","category":"page"},{"location":"model_components/biogeochemical/","page":"Overview","title":"Overview","text":"Models usually have a default light attenuation model specified, these may be substituted easily by passing different models as parameters as above.","category":"page"},{"location":"quick_start/#Quick-start","page":"Quick start","title":"Quick start","text":"","category":"section"},{"location":"quick_start/","page":"Quick start","title":"Quick start","text":"OceanBioME provides biogeochemical models to plug into Oceananigans, for example this code will run one month of a single column, 7 variable (P, Z, sPOM, bPOM, DOM, NO₃, NH₄) biogeochemical situation with constant forcing.","category":"page"},{"location":"quick_start/","page":"Quick start","title":"Quick start","text":"First we need to check we have the required dependencies:","category":"page"},{"location":"quick_start/","page":"Quick start","title":"Quick start","text":"using Pkg\nPkg.add([\"OceanBioME\", \"Oceananigans\"])","category":"page"},{"location":"quick_start/","page":"Quick start","title":"Quick start","text":"using OceanBioME, Oceananigans\nusing Oceananigans.Units\n\ngrid = RectilinearGrid(size = 10, extent = 200meters, topology = (Flat, Flat, Bounded))\n\nPAR = CenterField(grid)\n\nmodel = NonhydrostaticModel(; grid, biogeochemistry = LOBSTER(; grid), auxiliary_fields = (; PAR))\n\nset!(model, P = 0.001, Z = 0.001, NO₃ = 1, NH₄ = 0.01)\n\nsimulation = Simulation(model, Δt = 1minute, stop_time = 30days)\n\nsimulation.output_writers[:profiles] = JLD2OutputWriter(model, model.tracers,\n                                                        filename = \"quickstart.jld2\",\n                                                        schedule = TimeInterval(0.5days),\n                                                        overwrite_existing = true)\n\nrun!(simulation)","category":"page"},{"location":"quick_start/","page":"Quick start","title":"Quick start","text":"This isn't quite as simple as it could be as it records the output so that we can visualize it:","category":"page"},{"location":"quick_start/","page":"Quick start","title":"Quick start","text":"Pkg.add(\"CairoMakie\")\n\nusing CairoMakie\n\nphytoplankton = FieldTimeSeries(\"quickstart.jld2\", \"P\")\nnitrates = FieldTimeSeries(\"quickstart.jld2\", \"NO₃\")\n\n_, _, z = nodes(nitrates)\n\nfig = Figure()\n\naxis_kwargs = (xlabel = \"Day\", ylabel = \"Depth (m)\")\nax1 = Axis(fig[1, 1]; title = \"Phytoplankton (mmol N/m³)\", axis_kwargs...)\nax2 = Axis(fig[1, 2]; title = \"Nitrate (mmol N/m³)\", axis_kwargs...)\n\nhm1 = heatmap!(ax1, phytoplankton.times / day, z, interior(phytoplankton , 1, 1, :, :)')\nhm2 = heatmap!(ax2,      nitrates.times / day, z, interior(nitrates, 1, 1, :, :)')\n\nfig","category":"page"},{"location":"quick_start/","page":"Quick start","title":"Quick start","text":"OceanBioME provides the tools to add to this, for example adding a carbonate chemistry model, or sediment at the bottom of the model. Please have a look at the rest of the examples to explore these options.","category":"page"},{"location":"model_components/sediments/simple_multi_g/#multi-g","page":"Simple Multi-G","title":"Simple multi-G","text":"","category":"section"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"This model, proposed by Soetaert et al. (2000), is a \"G class\" model that evolves carbon and nitrogen in three classes (fast, slow and refectory). The model is also only compatible with the LOBSTER biogeochemical model with carbonate chemistry, oxygen, and variable redfield options on. You also must ensure that the open_bottom option is on for particles to leave the bottom of the domain to the sediment model.","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"It is straightforward to set up:","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"using OceanBioME, Oceananigans, OceanBioME.Sediments\n\ngrid = RectilinearGrid(size=(3, 3, 30), extent=(10, 10, 200))\n\nsediment_model = SimpleMultiG(; grid)\n\n# output\n┌ Warning: Sediment models are an experimental feature and have not yet been validated.\n└ @ OceanBioME.Boundaries.Sediments ~/OceanBioME.jl/src/Boundaries/Sediments/simple_multi_G.jl:102\n[ Info: This sediment model is currently only compatible with models providing NH₄, NO₃, O₂, and DIC.\nSingle-layer multi-G sediment model (Float64)","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"You may optionally specify the model parameters. This can then be passed in the setup of a BGC model:","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"biogeochemistry = LOBSTER(; grid, \n                            carbonates = true, oxygen = true, variable_redfield = true, \n                            open_bottom = true, \n                            sediment_model)","category":"page"},{"location":"model_components/sediments/simple_multi_g/#Model-equations","page":"Simple Multi-G","title":"Model equations","text":"","category":"section"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"This model evolved the carbon and nitrogen components of three liability classes: fast, slow, and refractory. Each component is remineralised with first order decay so evolved like:","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"fracdX_idt = F_X_i - lambda_iX_i","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"For the fast and slow classes lambda is a positive, non-zero, rate constant, and for the refractory class it is 0. F_X_i is the flux, and the flux for each class is simply a constant fraction of the total flux:","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"F_X_i = f_iF_X","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"The fraction of remineralised sediment (X_textmin = Sigma_ilambda_X_iX_i) that becomes ammonia or nitrate depends on the equilibrium of chemical equations dependent on the bottom water NO_3, NH_4, and O_2 concentrations, as well as the total remineralisation and mean degradation rate. The mean first order degredation rate is given by:","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"k = fraclambda_textfast C_textfast + lambda_textslow C_textslowC_textfast + C_textslow","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"and, based on Soetaert et al. (2000), the fraction nitrified (i.e becoming nitrate rather than ammonia) is given by:","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"lnleft(C_textminp_nitright) = n_A + n_Bln C_textminln O_2 + n_C * ln C_textmin ^ 2 + n_D * ln k ln NH_4 + n_E ln C_textmin + n_F ln C_textmin ln NH_4","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"Therefore, the efflux of nitrate and ammonia are given by:","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"fracpartial NO_3partial t =fracN_textminp_textnitDelta z","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"fracpartial NH_4partial t = fracN_textmin(1 - p_textnit)Delta z","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"where Delta z is the depth of the bottom cell (since X_i is a surface concentration). This mineralisation also consumes oxygen at a rate:","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"fracpartial O_2partial t =fracC_textmin(1 - p_textanoxp_textsolid deposition) + N_textminp_textnit ONDelta z","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"where the constants are given by:","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"p_textsolid deposition = s_A w ^s_B","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"with, w = s_CD^s_D where D is the water depth.","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"lnleft(C_textminp_textanoxright) = a_A + a_Bln C_textmin + a_C ln C_textmin ^ 2 + a_D ln k + a_E ln O_2 ln k + a_F ln NO_3 ^2","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"The original model of Soetaert et al. (2000) also includes denitrification terms whereby nitrogen is returned to the water column as dissolved N_2, but we currently do not account for this in order to conserve the nitrogen budget.","category":"page"},{"location":"model_components/sediments/simple_multi_g/#Parameter-variable-names","page":"Simple Multi-G","title":"Parameter variable names","text":"","category":"section"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"Symbol Variable name Units\nlambda_textfast fast_decay_rate 1 / s\nlambda_textslow slow_decay_rate 1 / s\nf_textfast fast_fraction -\nf_textslow slow_fraction -\nf_textref refactory_fraction -\nn_i nitrate_oxidation_params -\na_i anoxic_param -\ns_i solid_dep_params -","category":"page"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"All parameters are given in Parameters. ","category":"page"},{"location":"model_components/sediments/simple_multi_g/#Model-conservations","page":"Simple Multi-G","title":"Model conservations","text":"","category":"section"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"Nitrogen and carbon is conserved between the model domain and sediment, any nitrogen or carbon not returned to the bottom cell is stored in a sediment field.","category":"page"},{"location":"model_components/sediments/simple_multi_g/#Model-compatibility","page":"Simple Multi-G","title":"Model compatibility","text":"","category":"section"},{"location":"model_components/sediments/simple_multi_g/","page":"Simple Multi-G","title":"Simple Multi-G","text":"This model is currently only compatible with the LOBSTER biogeochemical model.","category":"page"},{"location":"model_components/sediments/instant_remineralisation/#instant_remineralisation","page":"Instant remineralisation","title":"Instant remineralisation","text":"","category":"section"},{"location":"model_components/sediments/instant_remineralisation/","page":"Instant remineralisation","title":"Instant remineralisation","text":"This model is similar to that described in Aumont et al. (2015) where the majority of organic matter that sinks to the bottom of the domain is instantly remineralised and returned to a nutrient pool (usually NH_4) in the bottom cell of the domain, and the remainder is permanently stored. ","category":"page"},{"location":"model_components/sediments/instant_remineralisation/#Model-equations","page":"Instant remineralisation","title":"Model equations","text":"","category":"section"},{"location":"model_components/sediments/instant_remineralisation/","page":"Instant remineralisation","title":"Instant remineralisation","text":"The burial fraction from Dunne et al. (2007) is given by:","category":"page"},{"location":"model_components/sediments/instant_remineralisation/","page":"Instant remineralisation","title":"Instant remineralisation","text":"E = E_0 + E_1left(fracF_OCk_B + F_OCright)^2","category":"page"},{"location":"model_components/sediments/instant_remineralisation/","page":"Instant remineralisation","title":"Instant remineralisation","text":"where F_OC is the carbon flux (in this implementation the nitrogen flux multiplied by the Redfield ratio).","category":"page"},{"location":"model_components/sediments/instant_remineralisation/#Parameter-variable-names","page":"Instant remineralisation","title":"Parameter variable names","text":"","category":"section"},{"location":"model_components/sediments/instant_remineralisation/","page":"Instant remineralisation","title":"Instant remineralisation","text":"Symbol Variable name Units\nE_0 burial_efficiency_constant1 -\nE_1 burial_efficiency_constant2 -\nk_B burial_efficiency_half_saturaiton mmol C / m² / s","category":"page"},{"location":"model_components/sediments/instant_remineralisation/#Model-conservations","page":"Instant remineralisation","title":"Model conservations","text":"","category":"section"},{"location":"model_components/sediments/instant_remineralisation/","page":"Instant remineralisation","title":"Instant remineralisation","text":"Nitrogen is conserved between the model domain and sediment, any nitrogen not returned to the bottom cell is stored in a sediment field.","category":"page"},{"location":"model_components/sediments/instant_remineralisation/#Model-compatibility","page":"Instant remineralisation","title":"Model compatibility","text":"","category":"section"},{"location":"model_components/sediments/instant_remineralisation/","page":"Instant remineralisation","title":"Instant remineralisation","text":"This model is compatible with all currently implemented models but does not separately store or remineralise carbon.","category":"page"},{"location":"model_components/utils/#utils","page":"Utilities","title":"Utilities","text":"","category":"section"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"We provide some utilities that may be useful.","category":"page"},{"location":"model_components/utils/#Time-step-adaptation","page":"Utilities","title":"Time step adaptation","text":"","category":"section"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"We have added a few additional utilities which extend the capabilities of Oceananigans' time step wizard. For column models where there is no water velocity we have added functions to calculate the advection timescale from the biogeochemical model defined sinking velocities. This could be used by:","category":"page"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"wizard = TimeStepWizard(cfl = 0.2, diffusive_cfl = 0.2, max_change = 2.0, min_change = 0.5, cell_advection_timescale = column_advection_timescale)\nsimulation.callbacks[:wizard] = Callback(wizard, IterationInterval(10))","category":"page"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"Additionally, in a column model you may have a functional definition for the viscosity, so we define an additional diffusion timescale function:","category":"page"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"wizard = TimeStepWizard(cfl = 0.2, diffusive_cfl = 0.2, max_change = 2.0, min_change = 0.5, cell_diffusion_timescale = column_diffusion_timescale, cell_advection_timescale = column_advection_timescale)\nsimulation.callbacks[:wizard] = Callback(wizard, IterationInterval(10))","category":"page"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"Finally, sinking may be more limiting than the normal advective CFL conditions so, we have an additional cell advection timescale defined for 3D models:","category":"page"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"wizard = TimeStepWizard(cfl = 0.6, diffusive_cfl = 0.5, max_change = 1.5, min_change = 0., cell_advection_timescale = sinking_advection_timescale)\nsimulation.callbacks[:wizard] = Callback(wizard, IterationInterval(10))","category":"page"},{"location":"model_components/utils/#Negative-tracer-detection","page":"Utilities","title":"Negative tracer detection","text":"","category":"section"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"As a temporary measure we have implemented a callback to either detect negative tracers and either scale a conserved group, force them back to zero, or throw an error. Please see the numerical implementations' page for details. This can be set up by:","category":"page"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"negativity_protection! = ScaleNegativeTracers(tracers = (:P, :Z, :N))\nsimulation.callbacks[:neg] = Callback(negativity_protection!; callsite = UpdateStateCallsite())","category":"page"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"You may also pass a scale factor for each component (e.g. in case they have different redfield ratios):","category":"page"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"negativity_protection! = ScaleNegativeTracers(tracers = (:P, :Z, :D), scalefactors = (P = 1, Z = 1, D = 2))\nsimulation.callbacks[:neg] = Callback(negativity_protection!; callsite = UpdateStateCallsite())","category":"page"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"Here you should carefully consider which tracers form a conserved group (if at all). Alternatively, force to zero by:","category":"page"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"simulation.callbacks[:neg] = Callback(OceanBioME.no_negative_tracers!, callsite = UpdateStateCallsite())","category":"page"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"or throw an error:","category":"page"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"simulation.callbacks[:neg] = Callback(OceanBioME.error_on_neg!, callsite = UpdateStateCallsite())","category":"page"},{"location":"model_components/utils/","page":"Utilities","title":"Utilities","text":"The latter two both optionally take a named tuple of parameters which may include exclude which can be a tuple of tracer names (Symbols) which are allowed to be negative.","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"EditURL = \"../../../examples/data_forced.jl\"","category":"page"},{"location":"generated/data_forced/#One-dimensional-column-forced-by-external-data-with-carbonate-chemistry","page":"Data forced column model","title":"One dimensional column forced by external data with carbonate chemistry","text":"","category":"section"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"In this example we will setup a simple 1D column with the LOBSTER biogeochemical model and observe its evolution. This demonstrates:","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"How to setup OceanBioME's biogeochemical models\nHow to load external forcing data\nHow to run with optional tracer sets such as carbonate chemistry\nHow to setup a non-uniform grid for better near surface resolution\nHow to visualise results","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"This is forced by mixing layer depth and surface photosynthetically available radiation (PAR) data from the Mercator Ocean model and NASA VIIRS observations","category":"page"},{"location":"generated/data_forced/#Install-dependencies","page":"Data forced column model","title":"Install dependencies","text":"","category":"section"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"First we will check we have the dependencies installed","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"using Pkg\npkg\"add OceanBioME, Oceananigans, NetCDF, Interpolations, DataDeps, CairoMakie\"","category":"page"},{"location":"generated/data_forced/#Model-setup","page":"Data forced column model","title":"Model setup","text":"","category":"section"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"First load the required packages","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"using OceanBioME\nusing Oceananigans, Random, Printf, NetCDF, Interpolations, DataDeps\nusing Oceananigans.Units\n\nconst year = years = 365days # just for these idealised cases","category":"page"},{"location":"generated/data_forced/#Load-external-forcing-data","page":"Data forced column model","title":"Load external forcing data","text":"","category":"section"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"Loading the forcing data from our online copy","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"dd = DataDep(\n    \"example_data\",\n    \"example data from subpolar re analysis and observational products\",\n    \"https://github.com/OceanBioME/OceanBioME_example_data/raw/main/subpolar.nc\"\n)\nregister(dd)\nfilename = datadep\"example_data/subpolar.nc\"\ntimes = ncread(filename, \"time\")\ntemp = ncread(filename, \"temp\")\nsalinity = ncread(filename, \"so\")\nmld = ncread(filename, \"mld\")\npar = ncread(filename, \"par\")\n\ntemperature_itp = LinearInterpolation(times, temp)\nsalinity_itp = LinearInterpolation(times, salinity)\nmld_itp = LinearInterpolation(times, mld)\nPAR_itp = LinearInterpolation(times, par)\n\nt_function(x, y, z, t) = temperature_itp(mod(t, 364days))\ns_function(x, y, z, t) = salinity_itp(mod(t, 364days))\nsurface_PAR(x, y, t) = PAR_itp(mod(t, 364days))\nκₜ(x, y, z, t) = 2e-2 * max(1 - (z + mld_itp(mod(t, 364days)) / 2)^2 / (mld_itp(mod(t, 364days)) / 2)^2, 0) + 1e-4","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"┌ Warning: Checksum not provided, add to the Datadep Registration the following hash line\n│   hash = \"1d1bc2734d3269084ff16e529003c1f1610734bca093d474bb205d09b60734bd\"\n└ @ DataDeps ~/.julia/packages/DataDeps/1KjBt/src/verification.jl:44\n","category":"page"},{"location":"generated/data_forced/#Grid-and-PAR-field","page":"Data forced column model","title":"Grid and PAR field","text":"","category":"section"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"Define the grid (in this case a non uniform grid for better resolution near the surface) and an extra Oceananigans field for the PAR to be stored in","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"Nz = 33\nLz = 600meters\nrefinement = 10\nstretching = 5.754\nh(k) = (k - 1) / Nz\nζ₀(k) = 1 + (h(k) - 1) / refinement\nΣ(k) = (1 - exp(-stretching * h(k))) / (1 - exp(-stretching))\nz_faces(k) = Lz * (ζ₀(k) * Σ(k) - 1)\n\ngrid = RectilinearGrid(size = (1, 1, Nz), x = (0, 20meters), y = (0, 20meters), z = z_faces)","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"1×1×33 RectilinearGrid{Float64, Oceananigans.Grids.Periodic, Oceananigans.Grids.Periodic, Oceananigans.Grids.Bounded} on Oceananigans.Architectures.CPU with 3×3×3 halo\n├── Periodic x ∈ [0.0, 20.0)   regularly spaced with Δx=20.0\n├── Periodic y ∈ [0.0, 20.0)   regularly spaced with Δy=20.0\n└── Bounded  z ∈ [-600.0, 0.0] variably spaced with min(Δz)=2.18055, max(Δz)=86.9713","category":"page"},{"location":"generated/data_forced/#Biogeochemical-and-Oceananigans-model","page":"Data forced column model","title":"Biogeochemical and Oceananigans model","text":"","category":"section"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"Here we instantiate the LOBSTER model with carbonate chemistry and a surface flux of DIC (CO₂)","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"CO₂_flux = GasExchange(; gas = :CO₂, temperature = t_function, salinity = s_function)\nmodel = NonhydrostaticModel(; grid,\n                              closure = ScalarDiffusivity(ν = κₜ, κ = κₜ),\n                              biogeochemistry = LOBSTER(; grid,\n                                                          surface_phytosynthetically_active_radiation = surface_PAR,\n                                                          carbonates = true),\n                              boundary_conditions = (DIC = FieldBoundaryConditions(top = CO₂_flux),))\n\nset!(model, P = 0.03, Z = 0.03, NO₃ = 11.0, NH₄ = 0.05, DIC = 2200.0, Alk = 2400.0)","category":"page"},{"location":"generated/data_forced/#Simulation","page":"Data forced column model","title":"Simulation","text":"","category":"section"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"Next we setup the simulation along with some callbacks that:","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"Show the progress of the simulation\nStore the output\nPrevent the tracers from going negative from numerical error (see discussion of this in the positivity preservation implementation page)\nAdapt the timestep length to reduce the run time","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"simulation = Simulation(model, Δt = 1minutes, stop_time = 100days)\n\nprogress_message(sim) = @printf(\"Iteration: %04d, time: %s, Δt: %s, wall time: %s\\n\",\n                                iteration(sim),\n                                prettytime(sim),\n                                prettytime(sim.Δt),\n                                prettytime(sim.run_wall_time))\n\nsimulation.callbacks[:progress] = Callback(progress_message, IterationInterval(500))\n\nfilename = \"data_forced\"\nsimulation.output_writers[:profiles] = JLD2OutputWriter(model,\n                                                        merge(model.tracers, model.auxiliary_fields),\n                                                        filename = \"$filename.jld2\",\n                                                        schedule = TimeInterval(1day),\n                                                        overwrite_existing = true)","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"JLD2OutputWriter scheduled on TimeInterval(1 day):\n├── filepath: ./data_forced.jld2\n├── 10 outputs: (NO₃, NH₄, P, Z, sPOM, bPOM, DOM, DIC, Alk, PAR)\n├── array type: Array{Float64}\n├── including: [:grid, :coriolis, :buoyancy, :closure]\n└── max filesize: Inf YiB","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"TODO: make tendency callback to force no NaNs in tendencies","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"scale_negative_tracers = ScaleNegativeTracers(; model, tracers = (:NO₃, :NH₄, :P, :Z, :sPOM, :bPOM, :DOM))\nsimulation.callbacks[:neg] = Callback(scale_negative_tracers; callsite = UpdateStateCallsite())\n\nwizard = TimeStepWizard(cfl = 0.2, diffusive_cfl = 0.2,\n                        max_change = 2.0, min_change = 0.5,\n                        cell_diffusion_timescale = column_diffusion_timescale,\n                        cell_advection_timescale = column_advection_timescale)\nsimulation.callbacks[:wizard] = Callback(wizard, IterationInterval(10))","category":"page"},{"location":"generated/data_forced/#Run!","page":"Data forced column model","title":"Run!","text":"","category":"section"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"We are ready to run the simulation","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"run!(simulation)","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"[ Info: Initializing simulation...\nIteration: 0000, time: 0 seconds, Δt: 1 minute, wall time: 0 seconds\n[ Info:     ... simulation initialization complete (8.034 seconds)\n[ Info: Executing initial time step...\n[ Info:     ... initial time step complete (45.918 seconds).\nIteration: 0500, time: 1.081 days, Δt: 3.140 minutes, wall time: 56.497 seconds\nIteration: 1000, time: 2.170 days, Δt: 3.140 minutes, wall time: 59.044 seconds\nIteration: 1500, time: 3.259 days, Δt: 3.140 minutes, wall time: 1.025 minutes\nIteration: 2000, time: 4.349 days, Δt: 3.140 minutes, wall time: 1.068 minutes\nIteration: 2500, time: 5.438 days, Δt: 3.140 minutes, wall time: 1.110 minutes\nIteration: 3000, time: 6.528 days, Δt: 3.140 minutes, wall time: 1.152 minutes\nIteration: 3500, time: 7.617 days, Δt: 3.140 minutes, wall time: 1.194 minutes\nIteration: 4000, time: 8.706 days, Δt: 3.140 minutes, wall time: 1.235 minutes\nIteration: 4500, time: 9.796 days, Δt: 3.140 minutes, wall time: 1.278 minutes\nIteration: 5000, time: 10.885 days, Δt: 3.140 minutes, wall time: 1.319 minutes\nIteration: 5500, time: 11.975 days, Δt: 3.140 minutes, wall time: 1.361 minutes\nIteration: 6000, time: 13.063 days, Δt: 3.140 minutes, wall time: 1.403 minutes\nIteration: 6500, time: 14.153 days, Δt: 3.140 minutes, wall time: 1.444 minutes\nIteration: 7000, time: 15.242 days, Δt: 3.140 minutes, wall time: 1.487 minutes\nIteration: 7500, time: 16.331 days, Δt: 3.140 minutes, wall time: 1.529 minutes\nIteration: 8000, time: 17.421 days, Δt: 3.140 minutes, wall time: 1.571 minutes\nIteration: 8500, time: 18.510 days, Δt: 3.140 minutes, wall time: 1.613 minutes\nIteration: 9000, time: 19.600 days, Δt: 3.140 minutes, wall time: 1.655 minutes\nIteration: 9500, time: 20.689 days, Δt: 3.140 minutes, wall time: 1.697 minutes\nIteration: 10000, time: 21.778 days, Δt: 3.140 minutes, wall time: 1.738 minutes\nIteration: 10500, time: 22.868 days, Δt: 3.140 minutes, wall time: 1.780 minutes\nIteration: 11000, time: 23.957 days, Δt: 3.140 minutes, wall time: 1.823 minutes\nIteration: 11500, time: 25.046 days, Δt: 3.140 minutes, wall time: 1.865 minutes\nIteration: 12000, time: 26.135 days, Δt: 3.140 minutes, wall time: 1.908 minutes\nIteration: 12500, time: 27.225 days, Δt: 3.140 minutes, wall time: 1.950 minutes\nIteration: 13000, time: 28.314 days, Δt: 3.140 minutes, wall time: 1.992 minutes\nIteration: 13500, time: 29.403 days, Δt: 3.140 minutes, wall time: 2.034 minutes\nIteration: 14000, time: 30.493 days, Δt: 3.140 minutes, wall time: 2.077 minutes\nIteration: 14500, time: 31.582 days, Δt: 3.140 minutes, wall time: 2.119 minutes\nIteration: 15000, time: 32.672 days, Δt: 3.140 minutes, wall time: 2.162 minutes\nIteration: 15500, time: 33.761 days, Δt: 3.140 minutes, wall time: 2.204 minutes\nIteration: 16000, time: 34.850 days, Δt: 3.140 minutes, wall time: 2.245 minutes\nIteration: 16500, time: 35.940 days, Δt: 3.140 minutes, wall time: 2.287 minutes\nIteration: 17000, time: 37.028 days, Δt: 3.140 minutes, wall time: 2.328 minutes\nIteration: 17500, time: 38.118 days, Δt: 3.140 minutes, wall time: 2.370 minutes\nIteration: 18000, time: 39.207 days, Δt: 3.140 minutes, wall time: 2.417 minutes\nIteration: 18500, time: 40.297 days, Δt: 3.140 minutes, wall time: 2.461 minutes\nIteration: 19000, time: 41.386 days, Δt: 3.140 minutes, wall time: 2.503 minutes\nIteration: 19500, time: 42.475 days, Δt: 3.140 minutes, wall time: 2.545 minutes\nIteration: 20000, time: 43.565 days, Δt: 3.140 minutes, wall time: 2.588 minutes\nIteration: 20500, time: 44.654 days, Δt: 3.140 minutes, wall time: 2.630 minutes\nIteration: 21000, time: 45.744 days, Δt: 3.140 minutes, wall time: 2.673 minutes\nIteration: 21500, time: 46.833 days, Δt: 3.140 minutes, wall time: 2.716 minutes\nIteration: 22000, time: 47.922 days, Δt: 3.140 minutes, wall time: 2.758 minutes\nIteration: 22500, time: 49.011 days, Δt: 3.140 minutes, wall time: 2.801 minutes\nIteration: 23000, time: 50.100 days, Δt: 3.140 minutes, wall time: 2.843 minutes\nIteration: 23500, time: 51.190 days, Δt: 3.140 minutes, wall time: 2.886 minutes\nIteration: 24000, time: 52.279 days, Δt: 3.140 minutes, wall time: 2.928 minutes\nIteration: 24500, time: 53.369 days, Δt: 3.140 minutes, wall time: 2.971 minutes\nIteration: 25000, time: 54.458 days, Δt: 3.140 minutes, wall time: 3.014 minutes\nIteration: 25500, time: 55.547 days, Δt: 3.140 minutes, wall time: 3.057 minutes\nIteration: 26000, time: 56.637 days, Δt: 3.140 minutes, wall time: 3.099 minutes\nIteration: 26500, time: 57.726 days, Δt: 3.140 minutes, wall time: 3.141 minutes\nIteration: 27000, time: 58.816 days, Δt: 3.140 minutes, wall time: 3.184 minutes\nIteration: 27500, time: 59.905 days, Δt: 3.140 minutes, wall time: 3.227 minutes\nIteration: 28000, time: 60.994 days, Δt: 3.140 minutes, wall time: 3.269 minutes\nIteration: 28500, time: 62.083 days, Δt: 3.140 minutes, wall time: 3.312 minutes\nIteration: 29000, time: 63.172 days, Δt: 3.140 minutes, wall time: 3.354 minutes\nIteration: 29500, time: 64.262 days, Δt: 3.140 minutes, wall time: 3.397 minutes\nIteration: 30000, time: 65.351 days, Δt: 3.140 minutes, wall time: 3.439 minutes\nIteration: 30500, time: 66.440 days, Δt: 3.140 minutes, wall time: 3.480 minutes\nIteration: 31000, time: 67.530 days, Δt: 3.140 minutes, wall time: 3.523 minutes\nIteration: 31500, time: 68.619 days, Δt: 3.140 minutes, wall time: 3.564 minutes\nIteration: 32000, time: 69.709 days, Δt: 3.140 minutes, wall time: 3.605 minutes\nIteration: 32500, time: 70.798 days, Δt: 3.140 minutes, wall time: 3.646 minutes\nIteration: 33000, time: 71.887 days, Δt: 3.140 minutes, wall time: 3.689 minutes\nIteration: 33500, time: 72.977 days, Δt: 3.140 minutes, wall time: 3.732 minutes\nIteration: 34000, time: 74.065 days, Δt: 3.140 minutes, wall time: 3.774 minutes\nIteration: 34500, time: 75.155 days, Δt: 3.140 minutes, wall time: 3.819 minutes\nIteration: 35000, time: 76.244 days, Δt: 3.140 minutes, wall time: 3.862 minutes\nIteration: 35500, time: 77.334 days, Δt: 3.140 minutes, wall time: 3.906 minutes\nIteration: 36000, time: 78.423 days, Δt: 3.140 minutes, wall time: 3.950 minutes\nIteration: 36500, time: 79.512 days, Δt: 3.140 minutes, wall time: 3.994 minutes\nIteration: 37000, time: 80.602 days, Δt: 3.140 minutes, wall time: 4.039 minutes\nIteration: 37500, time: 81.691 days, Δt: 3.140 minutes, wall time: 4.083 minutes\nIteration: 38000, time: 82.781 days, Δt: 3.140 minutes, wall time: 4.127 minutes\nIteration: 38500, time: 83.870 days, Δt: 3.140 minutes, wall time: 4.171 minutes\nIteration: 39000, time: 84.959 days, Δt: 3.140 minutes, wall time: 4.215 minutes\nIteration: 39500, time: 86.048 days, Δt: 3.140 minutes, wall time: 4.259 minutes\nIteration: 40000, time: 87.137 days, Δt: 3.140 minutes, wall time: 4.302 minutes\nIteration: 40500, time: 88.227 days, Δt: 3.140 minutes, wall time: 4.346 minutes\nIteration: 41000, time: 89.316 days, Δt: 3.140 minutes, wall time: 4.389 minutes\nIteration: 41500, time: 90.406 days, Δt: 3.140 minutes, wall time: 4.431 minutes\nIteration: 42000, time: 91.495 days, Δt: 3.140 minutes, wall time: 4.474 minutes\nIteration: 42500, time: 92.584 days, Δt: 3.140 minutes, wall time: 4.516 minutes\nIteration: 43000, time: 93.674 days, Δt: 3.140 minutes, wall time: 4.559 minutes\nIteration: 43500, time: 94.629 days, Δt: 1.862 minutes, wall time: 4.601 minutes\nIteration: 44000, time: 95.062 days, Δt: 1.025 minutes, wall time: 4.643 minutes\nIteration: 44500, time: 95.621 days, Δt: 2.412 minutes, wall time: 4.685 minutes\nIteration: 45000, time: 96.674 days, Δt: 3.140 minutes, wall time: 4.727 minutes\nIteration: 45500, time: 97.763 days, Δt: 3.140 minutes, wall time: 4.770 minutes\nIteration: 46000, time: 98.853 days, Δt: 3.140 minutes, wall time: 4.812 minutes\nIteration: 46500, time: 99.919 days, Δt: 2.548 minutes, wall time: 4.855 minutes\n[ Info: Simulation is stopping after running for 4.859 minutes.\n[ Info: Simulation time 100 days equals or exceeds stop time 100 days.\n","category":"page"},{"location":"generated/data_forced/#Load-output-and-plot","page":"Data forced column model","title":"Load output and plot","text":"","category":"section"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"Now we can visualise the results with some post processing to diagnose the air-sea CO₂ flux","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"   P = FieldTimeSeries(\"$filename.jld2\", \"P\")\n NO₃ = FieldTimeSeries(\"$filename.jld2\", \"NO₃\")\n   Z = FieldTimeSeries(\"$filename.jld2\", \"Z\")\nsPOM = FieldTimeSeries(\"$filename.jld2\", \"sPOM\")\nbPOM = FieldTimeSeries(\"$filename.jld2\", \"bPOM\")\n DIC = FieldTimeSeries(\"$filename.jld2\", \"DIC\")\n Alk = FieldTimeSeries(\"$filename.jld2\", \"Alk\")\n\nx, y, z = nodes(P)\ntimes = P.times","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"101-element Vector{Float64}:\n      0.0\n  86400.0\n 172800.0\n 259200.0\n 345600.0\n 432000.0\n 518400.0\n 604800.0\n 691200.0\n 777600.0\n 864000.0\n 950400.0\n      1.0368e6\n      1.1232e6\n      1.2096e6\n      1.296e6\n      1.3824e6\n      1.4688e6\n      1.5552e6\n      1.6416e6\n      1.728e6\n      1.8144e6\n      1.9008e6\n      1.9872e6\n      2.0736e6\n      2.16e6\n      2.2464e6\n      2.3328e6\n      2.4192e6\n      2.5056e6\n      2.592e6\n      2.6784e6\n      2.7648e6\n      2.8512e6\n      2.9376e6\n      3.024e6\n      3.1104e6\n      3.1968e6\n      3.2832e6\n      3.3696e6\n      3.456e6\n      3.5424e6\n      3.6288e6\n      3.7152e6\n      3.8016e6\n      3.888e6\n      3.9744e6\n      4.0608e6\n      4.1472e6\n      4.2336e6\n      4.32e6\n      4.4064e6\n      4.4928e6\n      4.5792e6\n      4.6656e6\n      4.752e6\n      4.8384e6\n      4.9248e6\n      5.0112e6\n      5.0976e6\n      5.184e6\n      5.2704e6\n      5.3568e6\n      5.4432e6\n      5.5296e6\n      5.616e6\n      5.7024e6\n      5.7888e6\n      5.8752e6\n      5.9616e6\n      6.048e6\n      6.1344e6\n      6.2208e6\n      6.3072e6\n      6.3936e6\n      6.48e6\n      6.5664e6\n      6.6528e6\n      6.7392e6\n      6.8256e6\n      6.912e6\n      6.9984e6\n      7.0848e6\n      7.1712e6\n      7.2576e6\n      7.344e6\n      7.4304e6\n      7.5168e6\n      7.6032e6\n      7.6896e6\n      7.776e6\n      7.8624e6\n      7.9488e6\n      8.0352e6\n      8.1216e6\n      8.208e6\n      8.2944e6\n      8.3808e6\n      8.4672e6\n      8.5536e6\n      8.64e6","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"We compute the  air-sea CO₂ flux at the surface (corresponding to vertical index k = grid.Nz) and the carbon export by computing how much carbon sinks below some arbirtrary depth; here we use depth that corresponds to k = grid.Nz - 20.","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"air_sea_CO₂_flux = zeros(length(times))\ncarbon_export = zeros(length(times))\n\nfor (i, t) in enumerate(times)\n    air_sea_CO₂_flux[i] = CO₂_flux.condition.parameters(0.0, 0.0, t, DIC[1, 1, grid.Nz, i], Alk[1, 1, grid.Nz, i], t_function(1, 1, 0, t), s_function(1, 1, 0, t))\n    carbon_export[i] = (sPOM[1, 1, grid.Nz-20, i] * model.biogeochemistry.sinking_velocities.sPOM.w[1, 1, grid.Nz-20] +\n                        bPOM[1, 1, grid.Nz-20, i] * model.biogeochemistry.sinking_velocities.bPOM.w[1, 1, grid.Nz-20]) * model.biogeochemistry.organic_redfield\nend","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"Both air_sea_CO₂_flux and carbon_export are in units mmol CO₂ / (m² s).","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"using CairoMakie\n\nfig = Figure(resolution = (1000, 1500), fontsize = 20)\n\naxis_kwargs = (xlabel = \"Time (days)\", ylabel = \"z (m)\", limits = ((0, times[end] / days), (-150meters, 0)))\n\naxP = Axis(fig[1, 1]; title = \"Phytoplankton concentration (mmol N/m³)\", axis_kwargs...)\nhmP = heatmap!(times / days, z, interior(P, 1, 1, :, :)', colormap=:batlow)\nColorbar(fig[1, 2], hmP)\n\naxNO₃ = Axis(fig[2, 1]; title = \"Nitrate concentration (mmol N/m³)\", axis_kwargs...)\nhmNO₃ = heatmap!(times / days, z, interior(NO₃, 1, 1, :, :)', colormap=:batlow)\nColorbar(fig[2, 2], hmNO₃)\n\naxZ = Axis(fig[3, 1]; title = \"Zooplankton concentration (mmol N/m³)\", axis_kwargs...)\nhmZ = heatmap!(times / days, z, interior(Z, 1, 1, :, :)', colormap=:batlow)\nColorbar(fig[3, 2], hmZ)\n\naxD = Axis(fig[4, 1]; title = \"Detritus concentration (mmol N/m³)\", axis_kwargs...)\nhmD = heatmap!(times / days, z, interior(sPOM, 1, 1, :, :)' .+ interior(bPOM, 1, 1, :, :)', colormap=:batlow)\nColorbar(fig[4, 2], hmD)\n\nCO₂_molar_mass = (12 + 2 * 16) * 1e-3 # kg / mol\n\naxfDIC = Axis(fig[5, 1], xlabel = \"Time (days)\", ylabel = \"Flux (kgCO₂/m²/year)\",\n                         title = \"Air-sea CO₂ flux and Sinking\", limits = ((0, times[end] / days), nothing))\nlines!(axfDIC, times / days, cumsum(air_sea_CO₂_flux) /1e3 * CO₂_molar_mass * year, linewidth = 3, label = \"Air-sea flux\")\nlines!(axfDIC, times / days, cumsum(carbon_export) /1e3    * CO₂_molar_mass * year, linewidth = 3, label = \"Sinking export\")\nLegend(fig[5, 2], axfDIC, framevisible = false)\n\nfig","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"(Image: )","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"","category":"page"},{"location":"generated/data_forced/","page":"Data forced column model","title":"Data forced column model","text":"This page was generated using Literate.jl.","category":"page"},{"location":"generated/SimpleMultiG_parameters/#SimpleMultiG-default-parameters","page":"SimpleMultiG","title":"SimpleMultiG default parameters","text":"","category":"section"},{"location":"generated/SimpleMultiG_parameters/","page":"SimpleMultiG","title":"SimpleMultiG","text":"Name Value\nfast_decay_rate 2.3148148148148147e-5\nslow_decay_rate 2.3148148148148148e-6\nfast_redfield 0.1509\nslow_redfield 0.13\nfast_fraction 0.74\nslow_fraction 0.26\nrefactory_fraction 0.1\nnitrate_oxidation_params (A = -1.9785, B = 0.2261, C = -0.0615, D = -0.0289, E = -0.36109, F = -0.0232)\ndenitrification_params (A = -3.079, B = 1.7509, C = 0.0593, D = -0.1923, E = 0.0604, F = 0.0662)\nanoxic_params (A = -3.9476, B = 2.6269, C = -0.2426, D = -1.3349, E = 0.1826, F = -0.0143)\nsolid_dep_params (A = 0.233, B = 0.336, C = 982, D = -1.548, depth = 1000)","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"EditURL = \"../../../examples/column.jl\"","category":"page"},{"location":"generated/column/#OneD_column","page":"Simple column model","title":"One-dimensional column example","text":"","category":"section"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"In this example we setup a simple 1D column with the LOBSTER biogeochemical model and observe its evolution. This demonstrates:","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"How to setup OceanBioME's biogeochemical models\nHow to visualise results","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"This is forced by idealised mixing layer depth and surface photosynthetically available radiation (PAR) which are setup first","category":"page"},{"location":"generated/column/#Install-dependencies","page":"Simple column model","title":"Install dependencies","text":"","category":"section"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"First we will check we have the dependencies installed","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"using Pkg\npkg\"add OceanBioME, Oceananigans, CairoMakie\"","category":"page"},{"location":"generated/column/#Model-setup","page":"Simple column model","title":"Model setup","text":"","category":"section"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"We load the packages and choose the default LOBSTER parameter set","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"using OceanBioME, Oceananigans, Printf\nusing OceanBioME.SLatissimaModel: SLatissima\nusing Oceananigans.Units\n\nconst year = years = 365days","category":"page"},{"location":"generated/column/#Surface-PAR-and-turbulent-vertical-diffusivity-based-on-idealised-mixed-layer-depth","page":"Simple column model","title":"Surface PAR and turbulent vertical diffusivity based on idealised mixed layer depth","text":"","category":"section"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"Setting up idealised functions for PAR and diffusivity (details here can be ignored but these are typical of the North Atlantic)","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"@inline PAR⁰(x, y, t) = 60 * (1 - cos((t + 15days) * 2π / year)) * (1 / (1 + 0.2 * exp(-((mod(t, year) - 200days) / 50days)^2))) + 2\n\n@inline H(t, t₀, t₁) = ifelse(t₀ < t < t₁, 1.0, 0.0)\n\n@inline fmld1(t) = H(t, 50days, year) * (1 / (1 + exp(-(t - 100days) / 5days))) * (1 / (1 + exp((t - 330days) / 25days)))\n\n@inline MLD(t) = - (10 + 340 * (1 - fmld1(year - eps(year)) * exp(-mod(t, year) / 25days) - fmld1(mod(t, year))))\n\n@inline κₜ(x, y, z, t) = 1e-2 * (1 + tanh((z - MLD(t)) / 10)) / 2 + 1e-4\n\n@inline temp(x, y, z, t) = 2.4 * cos(t * 2π / year + 50days) + 10","category":"page"},{"location":"generated/column/#Grid","page":"Simple column model","title":"Grid","text":"","category":"section"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"Define the grid.","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"grid = RectilinearGrid(size=(1, 1, 50), extent=(20meters, 20meters, 200meters))","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"1×1×50 RectilinearGrid{Float64, Oceananigans.Grids.Periodic, Oceananigans.Grids.Periodic, Oceananigans.Grids.Bounded} on Oceananigans.Architectures.CPU with 3×3×3 halo\n├── Periodic x ∈ [0.0, 20.0)   regularly spaced with Δx=20.0\n├── Periodic y ∈ [0.0, 20.0)   regularly spaced with Δy=20.0\n└── Bounded  z ∈ [-200.0, 0.0] regularly spaced with Δz=4.0","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"Specify the boundary conditions for DIC and O₂ based on the air-sea CO₂ and O₂ flux","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"CO₂_flux = GasExchange(; gas = :CO₂, temperature = temp, salinity = (args...) -> 35)\n\nmodel = NonhydrostaticModel(; grid,\n                              closure = ScalarDiffusivity(ν = κₜ, κ = κₜ),\n                              biogeochemistry = LOBSTER(; grid,\n                                                          surface_phytosynthetically_active_radiation = PAR⁰,\n                                                          carbonates = true),\n                              boundary_conditions = (DIC = FieldBoundaryConditions(top = CO₂_flux), ))\n\nset!(model, P = 0.03, Z = 0.03, NO₃ = 4.0, NH₄ = 0.05, DIC = 2239.8, Alk = 2409.0)","category":"page"},{"location":"generated/column/#Simulation","page":"Simple column model","title":"Simulation","text":"","category":"section"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"Next we setup a simulation and add some callbacks that:","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"Show the progress of the simulation\nStore the model and particles output\nPrevent the tracers from going negative from numerical error (see discussion in the positivity preservation implementation section)","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"simulation = Simulation(model, Δt = 3minutes, stop_time = 100days)\n\nprogress_message(sim) = @printf(\"Iteration: %04d, time: %s, Δt: %s, wall time: %s\\n\",\n                                                        iteration(sim),\n                                                        prettytime(sim),\n                                                        prettytime(sim.Δt),\n                                                        prettytime(sim.run_wall_time))\n\nsimulation.callbacks[:progress] = Callback(progress_message, TimeInterval(10days))\n\nfilename = \"column\"\nsimulation.output_writers[:profiles] = JLD2OutputWriter(model, merge(model.tracers, model.auxiliary_fields),\n                                                        filename = \"$filename.jld2\",\n                                                        schedule = TimeInterval(1day),\n                                                        overwrite_existing = true)\n\nscale_negative_tracers = ScaleNegativeTracers(; model, tracers = (:NO₃, :NH₄, :P, :Z, :sPOM, :bPOM, :DOM))\nsimulation.callbacks[:neg] = Callback(scale_negative_tracers; callsite = UpdateStateCallsite())","category":"page"},{"location":"generated/column/#Run!","page":"Simple column model","title":"Run!","text":"","category":"section"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"We are ready to run the simulation","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"run!(simulation)","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"[ Info: Initializing simulation...\nIteration: 0000, time: 0 seconds, Δt: 3 minutes, wall time: 0 seconds\n[ Info:     ... simulation initialization complete (5.846 seconds)\n[ Info: Executing initial time step...\n[ Info:     ... initial time step complete (52.986 seconds).\nIteration: 4800, time: 10 days, Δt: 3 minutes, wall time: 1.183 minutes\nIteration: 9600, time: 20 days, Δt: 3 minutes, wall time: 1.385 minutes\nIteration: 14400, time: 30 days, Δt: 3 minutes, wall time: 1.587 minutes\nIteration: 19200, time: 40 days, Δt: 3 minutes, wall time: 1.796 minutes\nIteration: 24000, time: 50 days, Δt: 3 minutes, wall time: 2.008 minutes\nIteration: 28800, time: 60 days, Δt: 3 minutes, wall time: 2.207 minutes\nIteration: 33600, time: 70 days, Δt: 3 minutes, wall time: 2.406 minutes\nIteration: 38400, time: 80 days, Δt: 3 minutes, wall time: 2.613 minutes\nIteration: 43200, time: 90 days, Δt: 3 minutes, wall time: 2.810 minutes\n[ Info: Simulation is stopping after running for 3.004 minutes.\n[ Info: Simulation time 100 days equals or exceeds stop time 100 days.\nIteration: 48000, time: 100 days, Δt: 3 minutes, wall time: 3.004 minutes\n","category":"page"},{"location":"generated/column/#Load-saved-output","page":"Simple column model","title":"Load saved output","text":"","category":"section"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"Now we can load the results and do some post processing to diagnose the air-sea CO₂ flux. Hopefully, this looks different to the example without kelp!","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"   P = FieldTimeSeries(\"$filename.jld2\", \"P\")\n NO₃ = FieldTimeSeries(\"$filename.jld2\", \"NO₃\")\n   Z = FieldTimeSeries(\"$filename.jld2\", \"Z\")\nsPOM = FieldTimeSeries(\"$filename.jld2\", \"sPOM\")\nbPOM = FieldTimeSeries(\"$filename.jld2\", \"bPOM\")\n DIC = FieldTimeSeries(\"$filename.jld2\", \"DIC\")\n Alk = FieldTimeSeries(\"$filename.jld2\", \"Alk\")\n\nx, y, z = nodes(P)\ntimes = P.times","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"101-element Vector{Float64}:\n      0.0\n  86400.0\n 172800.0\n 259200.0\n 345600.0\n 432000.0\n 518400.0\n 604800.0\n 691200.0\n 777600.0\n 864000.0\n 950400.0\n      1.0368e6\n      1.1232e6\n      1.2096e6\n      1.296e6\n      1.3824e6\n      1.4688e6\n      1.5552e6\n      1.6416e6\n      1.728e6\n      1.8144e6\n      1.9008e6\n      1.9872e6\n      2.0736e6\n      2.16e6\n      2.2464e6\n      2.3328e6\n      2.4192e6\n      2.5056e6\n      2.592e6\n      2.6784e6\n      2.7648e6\n      2.8512e6\n      2.9376e6\n      3.024e6\n      3.1104e6\n      3.1968e6\n      3.2832e6\n      3.3696e6\n      3.456e6\n      3.5424e6\n      3.6288e6\n      3.7152e6\n      3.8016e6\n      3.888e6\n      3.9744e6\n      4.0608e6\n      4.1472e6\n      4.2336e6\n      4.32e6\n      4.4064e6\n      4.4928e6\n      4.5792e6\n      4.6656e6\n      4.752e6\n      4.8384e6\n      4.9248e6\n      5.0112e6\n      5.0976e6\n      5.184e6\n      5.2704e6\n      5.3568e6\n      5.4432e6\n      5.5296e6\n      5.616e6\n      5.7024e6\n      5.7888e6\n      5.8752e6\n      5.9616e6\n      6.048e6\n      6.1344e6\n      6.2208e6\n      6.3072e6\n      6.3936e6\n      6.48e6\n      6.5664e6\n      6.6528e6\n      6.7392e6\n      6.8256e6\n      6.912e6\n      6.9984e6\n      7.0848e6\n      7.1712e6\n      7.2576e6\n      7.344e6\n      7.4304e6\n      7.5168e6\n      7.6032e6\n      7.6896e6\n      7.776e6\n      7.8624e6\n      7.9488e6\n      8.0352e6\n      8.1216e6\n      8.208e6\n      8.2944e6\n      8.3808e6\n      8.4672e6\n      8.5536e6\n      8.64e6","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"We compute the  air-sea CO₂ flux at the surface (corresponding to vertical index k = grid.Nz) and the carbon export by computing how much carbon sinks below some arbirtrary depth; here we use depth that corresponds to k = grid.Nz - 20.","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"air_sea_CO₂_flux = zeros(length(times))\ncarbon_export = zeros(length(times))\n\nfor (i, t) in enumerate(times)\n    air_sea_CO₂_flux[i] = CO₂_flux.condition.parameters(0.0, 0.0, t, DIC[1, 1, grid.Nz, i], Alk[1, 1, grid.Nz, i], temp(1, 1, 0, t), 35)\n    carbon_export[i] = (sPOM[1, 1, grid.Nz-20, i] * model.biogeochemistry.sinking_velocities.sPOM.w[1, 1, grid.Nz-20] +\n                        bPOM[1, 1, grid.Nz-20, i] * model.biogeochemistry.sinking_velocities.bPOM.w[1, 1, grid.Nz-20]) * model.biogeochemistry.organic_redfield\nend","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"Both air_sea_CO₂_flux and carbon_export are in units mmol CO₂ / (m² s).","category":"page"},{"location":"generated/column/#Plot","page":"Simple column model","title":"Plot","text":"","category":"section"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"Finally, we plot!","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"using CairoMakie\n\nfig = Figure(resolution = (1000, 1500), fontsize = 20)\n\naxis_kwargs = (xlabel = \"Time (days)\", ylabel = \"z (m)\", limits = ((0, times[end] / days), (-150meters, 0)))\n\naxP = Axis(fig[1, 1]; title = \"Phytoplankton concentration (mmol N / m³)\", axis_kwargs...)\nhmP = heatmap!(times / days, z, interior(P, 1, 1, :, :)', colormap = :batlow)\nColorbar(fig[1, 2], hmP)\n\naxNO₃ = Axis(fig[2, 1]; title = \"Nitrate concentration (mmol N / m³)\", axis_kwargs...)\nhmNO₃ = heatmap!(times / days, z, interior(NO₃, 1, 1, :, :)', colormap = :batlow)\nColorbar(fig[2, 2], hmNO₃)\n\naxZ = Axis(fig[3, 1]; title = \"Zooplankton concentration (mmol N / m³)\", axis_kwargs...)\nhmZ = heatmap!(times / days, z, interior(Z, 1, 1, :, :)', colormap = :batlow)\nColorbar(fig[3, 2], hmZ)\n\naxD = Axis(fig[4, 1]; title = \"Detritus concentration (mmol N / m³)\", axis_kwargs...)\nhmD = heatmap!(times / days, z, interior(sPOM, 1, 1, :, :)' .+ interior(bPOM, 1, 1, :, :)', colormap = :batlow)\nColorbar(fig[4, 2], hmD)\n\nCO₂_molar_mass = (12 + 2 * 16) * 1e-3 # kg / mol\n\naxfDIC = Axis(fig[5, 1], xlabel = \"Time (days)\", ylabel = \"Flux (kgCO₂/m²/year)\",\n                         title = \"Air-sea CO₂ flux and Sinking\", limits = ((0, times[end] / days), nothing))\nlines!(axfDIC, times / days, air_sea_CO₂_flux / 1e3 * CO₂_molar_mass * year, linewidth = 3, label = \"Air-sea flux\")\nlines!(axfDIC, times / days, carbon_export / 1e3    * CO₂_molar_mass * year, linewidth = 3, label = \"Sinking export\")\nLegend(fig[5, 2], axfDIC, framevisible = false)\n\nfig","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"(Image: )","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"","category":"page"},{"location":"generated/column/","page":"Simple column model","title":"Simple column model","text":"This page was generated using Literate.jl.","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/#LOBSTER","page":"LOBSTER","title":"The Lodyc-DAMTP Ocean Biogeochemical Simulation Tools for Ecosystem and Resources (LOBSTER) model","text":"","category":"section"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"LOBSTER is a medium complexity BGC model with seven core prognostic variables: phytoplankton, zooplankton, small and large detritus, nitrates, ammonia, and dissolved organic matter. LOBSTER was originally proposed by Lévy et al. (2005) and subsequently added to by Lévy et al. (2001), Resplandy et al. (2009), Karleskind et al. (2011), and Resplandy et al. (2012).","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"(Image: Diagram of LOBSTER formulation)","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"Additionally, this implementation of LOBSTER optionally models simple carbonate chemistry (DIC and Alkalinity), Oxygen, and variable redfield ratios for the now dissolved and particulate organic groups (which then allows carbon to be conserved). These are activated in the model setup, for example:","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"julia> using OceanBioME, Oceananigans\n\njulia> grid = RectilinearGrid(size=(3, 3, 30), extent=(10, 10, 200));\n\njulia> bgc_model = LOBSTER(; grid, carbonates = true)\nLodyc-DAMTP Ocean Biogeochemical Simulation Tools for Ecosystem and Resources (LOBSTER) model (Float64) \n Light Attenuation Model: \n    └── Two-band light attenuation model (Float64)\n Optional components:\n    ├── Carbonates ✅ \n    ├── Oxygen ❌ \n    └── Variable Redfield Ratio ❌\n Sinking Velocities:\n    ├── sPOM: 0.0 to -3.47e-5 m/s \n    └── bPOM: 0.0 to -0.0023148148148148147 m/s","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/#Model-equations","page":"LOBSTER","title":"Model equations","text":"","category":"section"},{"location":"model_components/biogeochemical/LOBSTER/#Core-components","page":"LOBSTER","title":"Core components","text":"","category":"section"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"When no additional components are activated the tracers NO_3, NH_4, P, Z, sPOM, bPOM, and DOM evolve like:","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"fracpartial Ppartial t = (1-gamma)mu_P L_PARleft(L_NO_3 + L_NH_4right)P - G_P - m_PP^2","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"fracpartial Zpartial t = a_zleft(G_P + G_sPOMright) - m_ZZ^2 - mu_ZZ","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"fracpartial NO_3partial t = -mu_PL_PARL_NO_3 + mu_nNH_4","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"fracpartial NH_4partial t = -mu_PL_PARL_NH_4 - mu_nNH_4 \n     + alpha_Pgammamu_P L_PARleft(L_NO_3 + L_NH_4right)P\n     + alpha_Zmu_ZZ + alpha_dmu_sPOMsPOM + alpha_dmu_bPOMbPOM\n     + mu_DOMDOM","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"fracpartial sPOMpartial t = f_sleft(1-a_Z)left(G_P + G_sPOMright) + m_PP^2 + m_ZZ^2right - G_sPOM - mu_sPOMsPOM - fracpartialpartial z(sPOM w_s)","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"fracpartial bPOMpartial t = (1-f_s)left(1-a_Z)left(G_P + G_sPOMright) + m_PP^2 + m_ZZ^2right - mu_bPOMbPOM - fracpartialpartial z(bPOM w_b)","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"fracpartial DOMpartial t = (1-alpha_P)gammamu_P L_PARleft(L_NO_3 + L_NH_4right)R_PP + (1-alpha_Z)mu_ZR_ZZ + (1-alpha_D)mu_sPOMsPOM + (1-alpha_D)mu_bPOMbPOM - mu_DOMDOM","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"Where:","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"L_PAR = 1 - e^-PARk_PAR","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"L_NO_3 = fracNO_3NO_3 + k_NO_3e^-psi NH_4","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"L_NH_4 = fracNH_4NH_4 + k_NH_4","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"G_P = g_zfractildepPk_z + tildepP + (1-tildep)sPOMZ","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"G_sPOM = g_zfrac(1-tildep)sPOMk_z + tildepP + (1-tildep)sPOMZ","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"Additionally, the sPOM and bPOM detritus components sink with constant sinking speed.","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/#Carbonate-chemistry","page":"LOBSTER","title":"Carbonate chemistry","text":"","category":"section"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"When the carbonate chemistry is activated additional tracers DIC and Alk evolve like:","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"fracpartial DICpartial t = alpha_Pgammamu_P L_PARleft(L_NO_3 + L_NH_4right)R_PP + alpha_Zmu_ZZR_Z + alpha_Dmu_sPOMR_OsPOM\n+ alpha_Dmu_bPOMR_ObPOM + mu_DOMR_ODOM - mu_P L_PARleft(L_NO_3 + L_NH_4right) R_P (1 + rho_CaCO_3(1 - gamma))P\n+ G_Peta R_Prho_CaCO_3","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"fracpartial Alkpartial t = mu_P L_PARL_NO_3P - 2rho_CaCO_3mu_P L_PARleft(L_NO_3 + L_NH_4right)R_PP","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/#Oxygen-chemistry","page":"LOBSTER","title":"Oxygen chemistry","text":"","category":"section"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"When the oxygen chemistry is activated additional tracer O_2 evolve like:","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"fracpartial O_2partial t = mu_P L_PARleft(L_NO_3 + L_NH_4right)R_O_2P - (R_O_2 - R_nit)fracpartial NH_4partial t - R_O_2mu_nNH_4","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/#Variable-Redfield","page":"LOBSTER","title":"Variable Redfield","text":"","category":"section"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"When the variable Redfield modification is activated the organic components are modified to evolve their nitrogen and carbon content separately. This means that the waste from non-Redfield models (e.g. loss from the kelp) can be accounted for.","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"In this case the organic components are split into nitrogen and carbon compartments, so the tracers sPOM, bPOM, and DOM are replaced with sPON, sPOC, bPON, bPOC, DON, and DOC. The nitrogen compartments evolve as per the organic matter equations above (i.e. replacing each XOM with XON), while the carbon compartments evolve like:","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"fracpartial sPOCpartial t = f_sleft(1-a_Z)left(G_P + G_sPOMright)R_Z + m_PP^2 + m_ZR_ZZ^2right - G_sPONR_Z - mu_sPOMsPOC - fracpartialpartial z(sPOC w_s)","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"fracpartial bPOCpartial t = (1-f_s)left(1-a_Z)left(G_P + G_sPOMright)R_Z + m_PR_PP^2 + m_ZR_ZZ^2right + (G_P(1 - eta) + m_PP^2)R_Prho_CaCO_3 - mu_bPOMbPOC - fracpartialpartial z(bPOC w_b)","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"fracpartial DOCpartial t = (1-alpha_P)gammamu_P L_PARleft(L_NO_3 + L_NH_4right)R_PP + (1-alpha_Z)mu_ZR_ZZ + (1-alpha_D)mu_sPOMsPOC + (1-alpha_D)mu_bPOMbPOC - mu_DOMDOC","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"Additionally, the DIC and Alk equations are modified to replace each XOM cdot R_O with the corresponding XOC.","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/#Parameter-variable-names","page":"LOBSTER","title":"Parameter variable names","text":"","category":"section"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"Symbol Variable name Units\ntildep phytoplankton_preference -\ng_z maximum_grazing_rate 1 / s\nk_z grazing_half_saturation mmol N / m³\nk_PAR light_half_saturation W / m²\npsi nitrate_ammonia_inhibition -\nk_NO_3 nitrate_half_saturation mmol N / m³\nk_NH_4 ammonia_half_saturation mmol N / m³\nmu_P maximum_phytoplankton_growthrate 1 / s\na_z zooplankton_assimilation_fraction -\nm_Z zooplankton_mortality 1 / s / mmol N/m³\nmu_z zooplankton_excretion_rate 1 / s\nm_P phytoplankton_mortality 1 / s\nmu_sPOM small_detritus_remineralisation_rate 1 / s\nmu_bPOM large_detritus_remineralisation_rate 1 / s\ngamma phytoplankton_exudation_fraction -\nmu_n nitrifcaiton_rate 1 / 2\nalpha_P ammonia_fraction_of_exudate -\nalpha_Z ammonia_fraction_of_excriment -\nalpha_d ammonia_fraction_of_detritus -\nR_P phytoplankton_redfield mmol C / mmol N\nR_O organic_redfield mmol C / mmol N\nR_ChlN phytoplankton_chlorophyll_ratio mg Chl / mmol N\nrho_CaCO_3 organic_carbon_calcate_ratio mmol CaCO₃/ mmol C\nR_O_2 respiraiton_oxygen_nitrogen_ratio mmol O / mmol N\nR_nit nitrifcation_oxygen_nitrogen_ratio mmol O / mmol N\nf_s slow_sinking_mortality_fraction -\nmu_DOM disolved_organic_breakdown_rate 1 / s\neta zooplankton_calcite_dissolution -","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"All default parameter values are given in Parameters; and a more thorough explanation of new terms will be included in a publication that is in prep.","category":"page"},{"location":"model_components/biogeochemical/LOBSTER/#Model-conservations","page":"LOBSTER","title":"Model conservations","text":"","category":"section"},{"location":"model_components/biogeochemical/LOBSTER/","page":"LOBSTER","title":"LOBSTER","text":"In the core configuration nitrogen is conserved in the evolution of the equations (excluding external sources and sinking), i.e. partial_t NO_3 + partial_t NH_4 + partial_t P + partial_t Z + partial_t sPOM + partial_t bPOM + partial_t DOM = 0. When the carbonate chemistry component is activated carbon is also conserved, i.e. R(partial_t P + partial_t Z + partial_t sPOM + partial_t bPOM + partial_t DOM) + partial_t DIC = 0. Trivially this is also the case when the variable Redfield component is also activated, i.e. R(partial_t P + partial_t Z) + partial_t sPOC + partial_t bPOC + partial_t DOC + partial_t DIC = 0.","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"EditURL = \"../../../examples/kelp.jl\"","category":"page"},{"location":"generated/kelp/#Simple-active-particle-example","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Simple active particle example","text":"","category":"section"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"In this example we will setup a simple 1D column with the LOBSTER biogeochemical model and active particles modelling the growth of sugar kelp. This demonstrates:","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"How to setup OceanBioME's biogeochemical models\nHow to add biologically active particles which interact with the biodeochemical model\nHow to visualise results","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"This is forced by idealised mixing layer depth and surface photosynthetically available radiation (PAR) which are setup first","category":"page"},{"location":"generated/kelp/#Install-dependencies","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Install dependencies","text":"","category":"section"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"First we will check we have the dependencies installed","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"using Pkg\npkg \"add OceanBioME, Oceananigans, CairoMakie, JLD2\"","category":"page"},{"location":"generated/kelp/#Model-setup","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model setup","text":"","category":"section"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"First load the required packages","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"using OceanBioME, Oceananigans, Printf\nusing Oceananigans.Units\nusing Oceananigans.Architectures: arch_array\n\nconst year = years = 365days # just for these idealised cases","category":"page"},{"location":"generated/kelp/#Surface-PAR-and-turbulent-vertical-diffusivity-based-on-idealised-mixed-layer-depth","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Surface PAR and turbulent vertical diffusivity based on idealised mixed layer depth","text":"","category":"section"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"Setting up idealised functions for PAR and diffusivity (details here can be ignored but these are typical of the North Atlantic)","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"@inline PAR⁰(x, y, t) = 60 * (1 - cos((t + 15days) * 2π / year)) * (1 / (1 + 0.2 * exp(-((mod(t, year) - 200days) / 50days) ^ 2))) + 2\n\n@inline H(t, t₀, t₁) = ifelse(t₀ < t < t₁, 1.0, 0.0)\n\n@inline fmld1(t) = H(t, 50days, year) * (1 / (1 + exp(-(t - 100days) / 5days))) * (1 / (1 + exp((t - 330days) / 25days)))\n\n@inline MLD(t) = - (10 + 340 * (1 - fmld1(year - eps(year)) * exp(-mod(t, year) / 25days) - fmld1(mod(t, year))))\n\n@inline κₜ(x, y, z, t) = 1e-2 * (1 + tanh((z - MLD(t))/10)) / 2 + 1e-4\n\n@inline temp(x, y, z, t) = 2.4 * cos(t * 2π / year + 50day) + 10\n\narchitecture = CPU()","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"Oceananigans.Architectures.CPU()","category":"page"},{"location":"generated/kelp/#Grid-and-PAR-field","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Grid and PAR field","text":"","category":"section"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"Define the grid and an extra Oceananigans field for the PAR to be stored in","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"Lx, Ly = 20meters, 20meters\ngrid = RectilinearGrid(architecture, size=(1, 1, 50), extent=(Lx, Ly, 200))","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"1×1×50 RectilinearGrid{Float64, Oceananigans.Grids.Periodic, Oceananigans.Grids.Periodic, Oceananigans.Grids.Bounded} on Oceananigans.Architectures.CPU with 3×3×3 halo\n├── Periodic x ∈ [0.0, 20.0)   regularly spaced with Δx=20.0\n├── Periodic y ∈ [0.0, 20.0)   regularly spaced with Δy=20.0\n└── Bounded  z ∈ [-200.0, 0.0] regularly spaced with Δz=4.0","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"Specify the boundary conditions for DIC and O₂ based on the air-sea CO₂ and O₂ flux","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"CO₂_flux = GasExchange(; gas = :CO₂, temperature = temp, salinity = (args...) -> 35)","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"FluxBoundaryCondition: ContinuousBoundaryFunction gasexchange_function at (Nothing, Nothing, Nothing)","category":"page"},{"location":"generated/kelp/#Kelp-Particle-setup","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Kelp Particle setup","text":"","category":"section"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"@info \"Setting up kelp particles\"\n\nn = 5 # number of kelp fronds\nz₀ = [-21:5:-1;] * 1.0 # depth of kelp fronds\n\nparticles = SLatissima(; architecture,\n                         x = arch_array(architecture, ones(n) * Lx / 2),\n                         y = arch_array(architecture, ones(n) * Ly / 2),\n                         z = arch_array(architecture, z₀),\n                         A = arch_array(architecture, ones(n) * 10.0),\n                         latitude = 57.5,\n                         scalefactor = 500.0,\n                         pescribed_temperature = temp)","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"5 BiogeochemicalParticles with eltype Any:\n└── 63 properties: (:architecture, :growth_rate_adjustement, :photosynthetic_efficiency, :minimum_carbon_reserve, :structural_carbon, :exudation, :erosion, :saturation_irradiance, :structural_dry_weight_per_area, :structural_dry_to_wet_weight, :carbon_reserve_per_carbon, :nitrogen_reserve_per_nitrogen, :minimum_nitrogen_reserve, :maximum_nitrogen_reserve, :growth_adjustement_2, :growth_adjustement_1, :maximum_specific_growth_rate, :structural_nitrogen, :photosynthesis_at_ref_temp_1, :photosynthesis_at_ref_temp_2, :photosynthesis_ref_temp_1, :photosynthesis_ref_temp_2, :photoperiod_1, :photoperiod_2, :respiration_at_ref_temp_1, :respiration_at_ref_temp_2, :respiration_ref_temp_1, :respiration_ref_temp_2, :photosynthesis_arrhenius_temp, :photosynthesis_low_temp, :photosynthesis_high_temp, :photosynthesis_high_arrhenius_temp, :photosynthesis_low_arrhenius_temp, :respiration_arrhenius_temp, :current_speed_for_0p65_uptake, :nitrate_half_saturation, :ammonia_half_saturation, :maximum_nitrate_uptake, :maximum_ammonia_uptake, :current_1, :current_2, :current_3, :respiration_reference_A, :respiration_reference_B, :exudation_redfield_ratio, :pescribed_velocity, :pescribed_temperature, :pescribed_salinity, :x, :y, :z, :A, :N, :C, :nitrate_uptake, :ammonia_uptake, :primary_production, :frond_exudation, :nitrogen_erosion, :carbon_erosion, :custom_dynamics, :scalefactor, :latitude)\n","category":"page"},{"location":"generated/kelp/#Setup-BGC-model","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Setup BGC model","text":"","category":"section"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"biogeochemistry = LOBSTER(; grid,\n                            surface_phytosynthetically_active_radiation = PAR⁰,\n                            carbonates = true,\n                            variable_redfield = true,\n                            particles)\n\nmodel = NonhydrostaticModel(; grid,\n                              closure = ScalarDiffusivity(ν = κₜ, κ = κₜ),\n                              biogeochemistry)\n\nset!(model, P = 0.03, Z = 0.03, NO₃ = 4.0, NH₄ = 0.05, DIC = 2239.8, Alk = 2409.0)","category":"page"},{"location":"generated/kelp/#Simulation","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Simulation","text":"","category":"section"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"Next we setup the simulation along with some callbacks that:","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"Show the progress of the simulation\nStore the model and particles output\nPrevent the tracers from going negative from numerical error (see discussion of this in the positivity preservation implementation page)","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"simulation = Simulation(model, Δt = 3minutes, stop_time = 100days)\n\nprogress_message(sim) = @printf(\"Iteration: %04d, time: %s, Δt: %s, wall time: %s\\n\",\n                                                        iteration(sim),\n                                                        prettytime(sim),\n                                                        prettytime(sim.Δt),\n                                                        prettytime(sim.run_wall_time))\n\nsimulation.callbacks[:progress] = Callback(progress_message, TimeInterval(10days))\n\nfilename = \"kelp\"\nsimulation.output_writers[:profiles] = JLD2OutputWriter(model, merge(model.tracers, model.auxiliary_fields),\n                                                        filename = \"$filename.jld2\",\n                                                        schedule = TimeInterval(1day),\n                                                        overwrite_existing = true)\n\nsimulation.output_writers[:particles] = JLD2OutputWriter(model, (; particles),\n                                                         filename = \"$(filename)_particles.jld2\",\n                                                         schedule = TimeInterval(1day),\n                                                         overwrite_existing = true)\n\nscale_negative_tracers = ScaleNegativeTracers(; model, tracers = (:NO₃, :NH₄, :P, :Z, :sPON, :bPON, :DON))\nsimulation.callbacks[:neg] = Callback(scale_negative_tracers; callsite = UpdateStateCallsite())","category":"page"},{"location":"generated/kelp/#Run!","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Run!","text":"","category":"section"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"Finally we run the simulation","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"run!(simulation)","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"[ Info: Initializing simulation...\nIteration: 0000, time: 0 seconds, Δt: 3 minutes, wall time: 0 seconds\n[ Info:     ... simulation initialization complete (7.926 seconds)\n[ Info: Executing initial time step...\n[ Info:     ... initial time step complete (1.331 minutes).\nIteration: 4800, time: 10 days, Δt: 3 minutes, wall time: 1.813 minutes\nIteration: 9600, time: 20 days, Δt: 3 minutes, wall time: 2.152 minutes\nIteration: 14400, time: 30 days, Δt: 3 minutes, wall time: 2.491 minutes\nIteration: 19200, time: 40 days, Δt: 3 minutes, wall time: 2.834 minutes\nIteration: 24000, time: 50 days, Δt: 3 minutes, wall time: 3.193 minutes\nIteration: 28800, time: 60 days, Δt: 3 minutes, wall time: 3.541 minutes\nIteration: 33600, time: 70 days, Δt: 3 minutes, wall time: 3.900 minutes\nIteration: 38400, time: 80 days, Δt: 3 minutes, wall time: 4.242 minutes\nIteration: 43200, time: 90 days, Δt: 3 minutes, wall time: 4.595 minutes\n[ Info: Simulation is stopping after running for 4.957 minutes.\n[ Info: Simulation time 100 days equals or exceeds stop time 100 days.\nIteration: 48000, time: 100 days, Δt: 3 minutes, wall time: 4.957 minutes\n","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"Now we can visualise the results with some post processing to diagnose the air-sea CO₂ flux - hopefully this looks different to the example without kelp!","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"   P = FieldTimeSeries(\"$filename.jld2\", \"P\")\n NO₃ = FieldTimeSeries(\"$filename.jld2\", \"NO₃\")\n   Z = FieldTimeSeries(\"$filename.jld2\", \"Z\")\nsPOC = FieldTimeSeries(\"$filename.jld2\", \"sPOC\")\nbPOC = FieldTimeSeries(\"$filename.jld2\", \"bPOC\")\n DIC = FieldTimeSeries(\"$filename.jld2\", \"DIC\")\n Alk = FieldTimeSeries(\"$filename.jld2\", \"Alk\")\n\nx, y, z = nodes(P)\ntimes = P.times","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"101-element Vector{Float64}:\n      0.0\n  86400.0\n 172800.0\n 259200.0\n 345600.0\n 432000.0\n 518400.0\n 604800.0\n 691200.0\n 777600.0\n 864000.0\n 950400.0\n      1.0368e6\n      1.1232e6\n      1.2096e6\n      1.296e6\n      1.3824e6\n      1.4688e6\n      1.5552e6\n      1.6416e6\n      1.728e6\n      1.8144e6\n      1.9008e6\n      1.9872e6\n      2.0736e6\n      2.16e6\n      2.2464e6\n      2.3328e6\n      2.4192e6\n      2.5056e6\n      2.592e6\n      2.6784e6\n      2.7648e6\n      2.8512e6\n      2.9376e6\n      3.024e6\n      3.1104e6\n      3.1968e6\n      3.2832e6\n      3.3696e6\n      3.456e6\n      3.5424e6\n      3.6288e6\n      3.7152e6\n      3.8016e6\n      3.888e6\n      3.9744e6\n      4.0608e6\n      4.1472e6\n      4.2336e6\n      4.32e6\n      4.4064e6\n      4.4928e6\n      4.5792e6\n      4.6656e6\n      4.752e6\n      4.8384e6\n      4.9248e6\n      5.0112e6\n      5.0976e6\n      5.184e6\n      5.2704e6\n      5.3568e6\n      5.4432e6\n      5.5296e6\n      5.616e6\n      5.7024e6\n      5.7888e6\n      5.8752e6\n      5.9616e6\n      6.048e6\n      6.1344e6\n      6.2208e6\n      6.3072e6\n      6.3936e6\n      6.48e6\n      6.5664e6\n      6.6528e6\n      6.7392e6\n      6.8256e6\n      6.912e6\n      6.9984e6\n      7.0848e6\n      7.1712e6\n      7.2576e6\n      7.344e6\n      7.4304e6\n      7.5168e6\n      7.6032e6\n      7.6896e6\n      7.776e6\n      7.8624e6\n      7.9488e6\n      8.0352e6\n      8.1216e6\n      8.208e6\n      8.2944e6\n      8.3808e6\n      8.4672e6\n      8.5536e6\n      8.64e6","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"We compute the  air-sea CO₂ flux at the surface (corresponding to vertical index k = grid.Nz) and the carbon export by computing how much carbon sinks below some arbirtrary depth; here we use depth that corresponds to k = grid.Nz - 20.","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"air_sea_CO₂_flux = zeros(length(times))\ncarbon_export = zeros(length(times))\n\nfor (i, t) in enumerate(times)\n    air_sea_CO₂_flux[i] = CO₂_flux.condition.parameters(0.0, 0.0, t, DIC[1, 1, grid.Nz, i], Alk[1, 1, grid.Nz, i], temp(1, 1, 0, t), 35)\n    carbon_export[i] = sPOC[1, 1, grid.Nz-20, i] * model.biogeochemistry.sinking_velocities.sPOM.w[1, 1, grid.Nz-20] +\n                       bPOC[1, 1, grid.Nz-20, i] * model.biogeochemistry.sinking_velocities.bPOM.w[1, 1, grid.Nz-20]\nend","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"Both air_sea_CO₂_flux and carbon_export are in units mmol CO₂ / (m² s).","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"using CairoMakie\n\nfig = Figure(resolution = (1000, 1500), fontsize = 20)\n\naxis_kwargs = (xlabel = \"Time (days)\", ylabel = \"z (m)\", limits = ((0, times[end] / days), (-85meters, 0)))\n\naxP = Axis(fig[1, 1]; title = \"Phytoplankton concentration (mmol N/m³)\", axis_kwargs...)\nhmP = heatmap!(times / days, z, interior(P, 1, 1, :, :)', colormap = :batlow)\nColorbar(fig[1, 2], hmP)\n\naxNO₃ = Axis(fig[2, 1]; title = \"Nitrate concentration (mmol N/m³)\", axis_kwargs...)\nhmNO₃ = heatmap!(times / days, z, interior(NO₃, 1, 1, :, :)', colormap = :batlow)\nColorbar(fig[2, 2], hmNO₃)\n\naxZ = Axis(fig[3, 1]; title = \"Zooplankton concentration (mmol N/m³)\", axis_kwargs...)\nhmZ = heatmap!(times / days, z, interior(Z, 1, 1, :, :)', colormap = :batlow)\nColorbar(fig[3, 2], hmZ)\n\naxD = Axis(fig[4, 1]; title = \"Detritus concentration (mmol C/m³)\", axis_kwargs...)\nhmD = heatmap!(times / days, z, interior(sPOC, 1, 1, :, :)' .+ interior(bPOC, 1, 1, :, :)', colormap = :batlow)\nColorbar(fig[4, 2], hmD)\n\nCO₂_molar_mass = (12 + 2 * 16) * 1e-3 # kg / mol\n\naxfDIC = Axis(fig[5, 1], xlabel = \"Time (days)\", ylabel = \"Flux (kgCO₂/m²/year)\",\n                         title = \"Air-sea CO₂ flux and Sinking\", limits = ((0, times[end] / days), nothing))\nlines!(axfDIC, times / days, air_sea_CO₂_flux / 1e3 * CO₂_molar_mass * year, linewidth = 3, label = \"Air-sea flux\")\nlines!(axfDIC, times / days, carbon_export / 1e3    * CO₂_molar_mass * year, linewidth = 3, label = \"Sinking export\")\nLegend(fig[5, 2], axfDIC, framevisible = false)\n\nfig","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"(Image: )","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"We can also have a look at how the kelp particles evolve","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"using JLD2\n\nfile = jldopen(\"$(filename)_particles.jld2\")\n\niterations = keys(file[\"timeseries/t\"])\n\nA, N, C = ntuple(n -> zeros(5, length(iterations)), 3)\n\ntimes = zeros(length(iterations))\n\nfor (i, iter) in enumerate(iterations)\n    particles = file[\"timeseries/particles/$iter\"]\n    A[:, i] = particles.A\n    N[:, i] = particles.N\n    C[:, i] = particles.C\n\n    times[i] = file[\"timeseries/t/$iter\"]\nend\n\nfig = Figure(resolution = (1000, 800), fontsize = 20)\n\naxis_kwargs = (xlabel = \"Time (days)\", limits = ((0, times[end] / days), nothing))\n\nax1 = Axis(fig[1, 1]; ylabel = \"Frond area (dm²)\", axis_kwargs...)\n[lines!(ax1, times / day, A[n, :], linewidth = 3) for n in 1:5]\n\nax2 = Axis(fig[2, 1]; ylabel = \"Total Carbon (gC)\", axis_kwargs...)\n[lines!(ax2, times / day, (@. A * (N + particles.structural_nitrogen) * particles.structural_dry_weight_per_area)[n, :], linewidth = 3) for n in 1:5]\n\nax3 = Axis(fig[3, 1]; ylabel = \"Total Nitrogen (gN)\", axis_kwargs...)\n[lines!(ax3, times / day, (@. A * (C + particles.structural_carbon) * particles.structural_dry_weight_per_area)[n, :], linewidth = 3) for n in 1:5]\n\nfig","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"(Image: )","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"","category":"page"},{"location":"generated/kelp/","page":"Model with particles (kelp) interacting with the biogeochemistry","title":"Model with particles (kelp) interacting with the biogeochemistry","text":"This page was generated using Literate.jl.","category":"page"},{"location":"generated/SLatissima_parameters/#SLatissima-default-parameters","page":"SLatissima","title":"SLatissima default parameters","text":"","category":"section"},{"location":"generated/SLatissima_parameters/","page":"SLatissima","title":"SLatissima","text":"Name Value\ngrowth_rate_adjustement 4.5\nphotosynthetic_efficiency 0.011527777777777776\nminimum_carbon_reserve 0.01\nstructural_carbon 0.2\nexudation 0.5\nerosion 0.22\nsaturation_irradiance 7.776\nstructural_dry_weight_per_area 0.5\nstructural_dry_to_wet_weight 0.0785\ncarbon_reserve_per_carbon 2.1213\nnitrogen_reserve_per_nitrogen 2.72\nminimum_nitrogen_reserve 0.0126\nmaximum_nitrogen_reserve 0.0216\ngrowth_adjustement_2 0.046799999999999994\ngrowth_adjustement_1 0.16919999999999996\nmaximum_specific_growth_rate 0.18\nstructural_nitrogen 0.0146\nphotosynthesis_at_ref_temp_1 0.02928\nphotosynthesis_at_ref_temp_2 0.0312\nphotosynthesis_ref_temp_1 285.0\nphotosynthesis_ref_temp_2 288.0\nphotoperiod_1 0.85\nphotoperiod_2 0.3\nrespiration_at_ref_temp_1 0.006684\nrespiration_at_ref_temp_2 0.0130296\nrespiration_ref_temp_1 285.0\nrespiration_ref_temp_2 290.0\nphotosynthesis_arrhenius_temp 1737.7267805628196\nphotosynthesis_low_temp 271.0\nphotosynthesis_high_temp 296.0\nphotosynthesis_high_arrhenius_temp 1414.87\nphotosynthesis_low_arrhenius_temp 4547.89\nrespiration_arrhenius_temp 11033.8920579234\ncurrent_speed_for_0p65_uptake 0.03\nnitrate_half_saturation 4.0\nammonia_half_saturation 1.3\nmaximum_nitrate_uptake 0.00168\nmaximum_ammonia_uptake 0.002016\ncurrent_1 0.72\ncurrent_2 0.28\ncurrent_3 0.045\nrespiration_reference_A 0.002664\nrespiration_reference_B 0.0013368\nexudation_redfield_ratio Inf\npescribed_velocity 0.1\nlatitude 57.5","category":"page"},{"location":"numerical_implementation/positivity-preservation/#pos-preservation","page":"Positivity preservation","title":"Positivity Preservation","text":"","category":"section"},{"location":"numerical_implementation/positivity-preservation/","page":"Positivity preservation","title":"Positivity preservation","text":"It is common in BGC models to behave badly if any tracers go bellow zero, analytically this is fine because they (usually) can not get below zero, and it is unphysical for the concentration of something to be negative. Issues arise when the inaccuracy in numerical integration making some tracer become negative, usually leading to explosions (e.g. exp(-C) to inf), or bounds errors (e.g. log(C)). Essentially this occurs when the local error in the numerical scheme is sufficiently large that more than the available amount of tracer is consumed.","category":"page"},{"location":"numerical_implementation/positivity-preservation/","page":"Positivity preservation","title":"Positivity preservation","text":"There exists a set of numerical schemes which overcome this and guarantee positivity (provided a positivity preserving advection scheme and well-behaved diffusion scheme are used) but are complex to implement. Although we may do this in the future we have not yet done so in the meantime have provided some utilities which maintain positivity. The simplest option is to reset any negative tracers to zero, but this causes the model to gain mass. A slightly more complex version is to increase negative tracers to zero and remove the difference from other tracers with in the same conserved system.","category":"page"},{"location":"numerical_implementation/positivity-preservation/","page":"Positivity preservation","title":"Positivity preservation","text":"We have found this to be a satisfactory solution (when balanced against using much smaller time steps), as it tends to cause only a small and local transient change to the solution.","category":"page"},{"location":"numerical_implementation/positivity-preservation/","page":"Positivity preservation","title":"Positivity preservation","text":"See model components page for usage.","category":"page"},{"location":"generated/InstantRemineralisation_parameters/#InstantRemineralisation-default-parameters","page":"InstantRemineralisation","title":"InstantRemineralisation default parameters","text":"","category":"section"},{"location":"generated/InstantRemineralisation_parameters/","page":"InstantRemineralisation","title":"InstantRemineralisation","text":"Name Value\nburial_efficiency_constant1 0.013\nburial_efficiency_constant2 0.53\nburial_efficiency_half_saturaiton 7.0","category":"page"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"EditURL = \"../../../examples/box.jl\"","category":"page"},{"location":"generated/box/#box_example","page":"Box model","title":"Box model","text":"","category":"section"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"In this example we will setup a LOBSTER biogeochemical model in a single box configuration. This demonstrates:","category":"page"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"How to setup OceanBioME's biogeochemical models as a stand-alone box model","category":"page"},{"location":"generated/box/#Install-dependencies","page":"Box model","title":"Install dependencies","text":"","category":"section"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"First we will check we have the dependencies installed","category":"page"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"using Pkg\npkg\"add OceanBioME\"","category":"page"},{"location":"generated/box/#Model-setup","page":"Box model","title":"Model setup","text":"","category":"section"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"Load the packages and setup the initial and forcing conditions","category":"page"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"using OceanBioME, Oceananigans.Units\n\nconst year = years = 365day","category":"page"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"This is forced by a prescribed time-dependent photosynthetically available radiation (PAR)","category":"page"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"PAR⁰(t) = 60 * (1 - cos((t + 15days) * 2π / year)) * (1 / (1 + 0.2 * exp(-((mod(t, year) - 200days) / 50days)^2))) + 2\n\nz = -10 # specify the nominal depth of the box for the PAR profile\nPAR(t) = PAR⁰(t) * exp(0.2z) # Modify the PAR based on the nominal depth and exponential decay","category":"page"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"Set up the model. Here, first specify the biogeochemical model, followed by initial conditions and the start and end times","category":"page"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"model = BoxModel(biogeochemistry = LOBSTER(grid = BoxModelGrid()), forcing = (; PAR))\nmodel.Δt = 5minutes\nmodel.stop_time = 5years\n\nset!(model, NO₃ = 10.0, NH₄ = 0.1, P = 0.1, Z = 0.01)","category":"page"},{"location":"generated/box/#Run-the-model-(should-only-take-a-few-seconds)","page":"Box model","title":"Run the model (should only take a few seconds)","text":"","category":"section"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"@info \"Running the model...\"\nrun!(model, save_interval = 100, save = SaveBoxModel(\"box.jld2\"))","category":"page"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"[ Info: Running the model...\n[ Info: Reached 0 seconds\n[ Info: Reached 34.722 days\n[ Info: Reached 69.444 days\n[ Info: Reached 104.167 days\n[ Info: Reached 138.889 days\n[ Info: Reached 173.611 days\n[ Info: Reached 208.333 days\n[ Info: Reached 243.056 days\n[ Info: Reached 277.778 days\n[ Info: Reached 312.500 days\n[ Info: Reached 347.222 days\n[ Info: Reached 381.944 days\n[ Info: Reached 416.667 days\n[ Info: Reached 451.389 days\n[ Info: Reached 486.111 days\n[ Info: Reached 520.833 days\n[ Info: Reached 555.556 days\n[ Info: Reached 590.278 days\n[ Info: Reached 625 days\n[ Info: Reached 659.722 days\n[ Info: Reached 694.444 days\n[ Info: Reached 729.167 days\n[ Info: Reached 763.889 days\n[ Info: Reached 798.611 days\n[ Info: Reached 833.333 days\n[ Info: Reached 868.056 days\n[ Info: Reached 902.778 days\n[ Info: Reached 937.500 days\n[ Info: Reached 972.222 days\n[ Info: Reached 1006.944 days\n[ Info: Reached 1041.667 days\n[ Info: Reached 1076.389 days\n[ Info: Reached 1111.111 days\n[ Info: Reached 1145.833 days\n[ Info: Reached 1180.556 days\n[ Info: Reached 1215.278 days\n[ Info: Reached 1250 days\n[ Info: Reached 1284.722 days\n[ Info: Reached 1319.444 days\n[ Info: Reached 1354.167 days\n[ Info: Reached 1388.889 days\n[ Info: Reached 1423.611 days\n[ Info: Reached 1458.333 days\n[ Info: Reached 1493.056 days\n[ Info: Reached 1527.778 days\n[ Info: Reached 1562.500 days\n[ Info: Reached 1597.222 days\n[ Info: Reached 1631.944 days\n[ Info: Reached 1666.667 days\n[ Info: Reached 1701.389 days\n[ Info: Reached 1736.111 days\n[ Info: Reached 1770.833 days\n[ Info: Reached 1805.556 days\n","category":"page"},{"location":"generated/box/#Load-the-output","page":"Box model","title":"Load the output","text":"","category":"section"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"Check the dependencies for loading and plotting the data are installed","category":"page"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"using Pkg\npkg\"add JLD2, CairoMakie\"","category":"page"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"using JLD2\n\nvars = (:NO₃, :NH₄, :P, :Z, :DOM, :sPOM, :bPOM, :PAR)\nfile = jldopen(\"box.jld2\")\ntimes = parse.(Float64, keys(file[\"values\"]))\n\ntimeseries = NamedTuple{vars}(ntuple(t -> zeros(length(times)), length(vars)))\n\nfor (idx, time) in enumerate(times)\n    values = file[\"values/$time\"]\n    for tracer in vars\n        getproperty(timeseries, tracer)[idx] = values[tracer]\n    end\nend\n\nclose(file)","category":"page"},{"location":"generated/box/#And-plot","page":"Box model","title":"And plot","text":"","category":"section"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"using CairoMakie\n\nfig = Figure(resolution = (800, 1600), fontsize = 24)\n\naxs = []\nfor (idx, tracer) in enumerate(vars)\n    push!(axs, Axis(fig[idx, 1], ylabel = \"$tracer\", xlabel = \"Year\", xticks=(0:10)))\n    lines!(axs[end], times / year, timeseries[tracer], linewidth = 3)\nend\n\nfig","category":"page"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"(Image: )","category":"page"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"","category":"page"},{"location":"generated/box/","page":"Box model","title":"Box model","text":"This page was generated using Literate.jl.","category":"page"},{"location":"model_components/biogeochemical/PISCES/#PISCES","page":"Pelagic Interactions Scheme for Carbon and Ecosystem Studies volume 2) (PISCES)","title":"Pelagic Interactions Scheme for Carbon and Ecosystem Studies volume 2) (PISCES)","text":"","category":"section"},{"location":"model_components/biogeochemical/PISCES/","page":"Pelagic Interactions Scheme for Carbon and Ecosystem Studies volume 2) (PISCES)","title":"Pelagic Interactions Scheme for Carbon and Ecosystem Studies volume 2) (PISCES)","text":"warning: PISCES is not validated\nThe PISCES implementation is very early in its development and has not yet been validated (we can't even promise that it will run properly). If you are going to run experiments with it, we strongly recommend validating it against other implementations and would be very excited if you could share the results and any suggestions you have over an issues or a discussion.","category":"page"},{"location":"model_components/biogeochemical/PISCES/","page":"Pelagic Interactions Scheme for Carbon and Ecosystem Studies volume 2) (PISCES)","title":"Pelagic Interactions Scheme for Carbon and Ecosystem Studies volume 2) (PISCES)","text":"PISCES (Aumont et al., 2015) is a more complex mixed Mondo-quota BGC model with multiple classes of phyto and zoo plankton with variable composition (C, Fe, and Chl), multiple nutrients (NO₃, NH₄, PO₄, Fe, and Si), dissolved organic matter, and the option for either a two size class or continuum size particulate model. With a total of 24 prognostic variables the complexity of PISCES is significantly higher than other models so far implemented in this package. This diagram shows the high level architecture of the PISCES model:","category":"page"},{"location":"model_components/biogeochemical/PISCES/","page":"Pelagic Interactions Scheme for Carbon and Ecosystem Studies volume 2) (PISCES)","title":"Pelagic Interactions Scheme for Carbon and Ecosystem Studies volume 2) (PISCES)","text":"(Image: Diagram of PISCES architecture)","category":"page"},{"location":"model_components/biogeochemical/PISCES/","page":"Pelagic Interactions Scheme for Carbon and Ecosystem Studies volume 2) (PISCES)","title":"Pelagic Interactions Scheme for Carbon and Ecosystem Studies volume 2) (PISCES)","text":"PISCES is considered to be a state of the art BGC model and is widely used. It is part of CMIP6 and so it often used in climate modelling but with this implementation we intended to make it easier to use it for smaller scale ecosystem modelling.","category":"page"},{"location":"#*Ocean*-*Bio*geochemical-*M*odelling-*E*nvironment-OceanBioME","page":"Home","title":"Ocean Biogeochemical Modelling Environment - OceanBioME","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"OceanBioME.jl is a fast and flexible ocean biogeochemical modelling environment. It is highly modular and is designed to make it easy to implement and use a variety of biogeochemical and physical models. OceanBioME is built to be coupled with physics models from Oceananigans.jl allowing simulations across a wide range of spatial scales ranging from a global hydrostatic free surface model to non-hydrostatic large-eddy simulations. OceanBioME was designed specifically for ocean carbon dioxide removal applications. Notably, it includes active particles which allow individual-based models to be seamlessly coupled with the flow physics, ecosystem models, and carbonate chemistry.","category":"page"},{"location":"","page":"Home","title":"Home","text":"OceanBioME.jl currently provides a core of several biogeochemical models (Nutrient–Phytoplankton–Zooplankton–Detritus (NPZD) and LOBSTER, a medium complexity model, air-sea gas exchange models to provide appropriate top boundary conditions, and sediment models to for the benthic boundary. PISCES and other higher complexity models are in our future development plans.","category":"page"},{"location":"","page":"Home","title":"Home","text":"OceanBioME.jl includes a framework for integrating the growth of biological/active Lagrangian particles which move around and can interact with the (Eulerian) tracer fields - for example, consuming nutrients and carbon dioxide while releasing dissolved organic material. A growth model for sugar kelp is currently implemented using active particles, and this model can be used in a variety of dynamical scenarios including free-floating or bottom-attached particles.","category":"page"},{"location":"#Quick-install","page":"Home","title":"Quick install","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"OceanBioME is a registered Julia package. So to install it,","category":"page"},{"location":"","page":"Home","title":"Home","text":"Download Julia.\nLaunch Julia and type","category":"page"},{"location":"","page":"Home","title":"Home","text":"julia> using Pkg\njulia> Pkg.add(\"OceanBioME\")","category":"page"},{"location":"","page":"Home","title":"Home","text":"compat: Julia 1.9\nOceanBioME.jl requires Julia version 1.9 or later.","category":"page"},{"location":"#Running-your-first-model","page":"Home","title":"Running your first model","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"As a simple example lets run a Nutrient-Phytoplankton-Zooplankton-Detritus (NPZD) model in a two-dimensional simulation of a buoyancy front. This example requires Oceananigans, so we install that first:","category":"page"},{"location":"","page":"Home","title":"Home","text":"using Pkg; Pkg.add(\"Oceananigans\")\n\nusing OceanBioME, Oceananigans\nusing Oceananigans.Units\n\ngrid = RectilinearGrid(CPU(), size = (160, 32), extent = (10000meters, 500meters), topology = (Bounded, Flat, Bounded))\n\nbiogeochemistry = NutrientPhytoplanktonZooplanktonDetritus(; grid) \n\nmodel = NonhydrostaticModel(; grid, biogeochemistry,\n                              advection = WENO(; grid),\n\t\t\t                  closure = AnisotropicMinimumDissipation(),\n\t\t\t                  buoyancy = SeawaterBuoyancy(constant_salinity = true))\n\n@inline front(x, z, μ, δ) = μ + δ * tanh((x - 7000 + 4 * z) / 500)\n\nPᵢ(x, y, z) = ifelse(z > -50, 0.03, 0.01) \nNᵢ(x, y, z) = front(x, z, 2.5, -2)\nTᵢ(x, y, z) = front(x, z, 9, 0.05)\n\nset!(model, N = Nᵢ, P = Pᵢ, Z = Pᵢ, T = Tᵢ)\n\nsimulation = Simulation(model; Δt = 50, stop_time = 4days)\n\nsimulation.output_writers[:tracers] = JLD2OutputWriter(model, model.tracers,\n                                                       filename = \"buoyancy_front.jld2\",\n                                                       schedule = TimeInterval(24minute),\n                                                       overwrite_existing = true)\n\nrun!(simulation)","category":"page"},{"location":"","page":"Home","title":"Home","text":"We can then load the saved output and visualize it:","category":"page"},{"location":"","page":"Home","title":"Home","text":"T = FieldTimeSeries(\"buoyancy_front.jld2\", \"T\")\nN = FieldTimeSeries(\"buoyancy_front.jld2\", \"N\")\nP = FieldTimeSeries(\"buoyancy_front.jld2\", \"P\")\n\nxc, yc, zc = nodes(T)\n\ntimes = T.times\n\nusing CairoMakie\n\nn = Observable(1)\n\nT_lims = (8.94, 9.06)\nN_lims = (0, 4.5)\nP_lims = (0.007, 0.02)\n\nTₙ = @lift interior(T[$n], :, 1, :)\nNₙ = @lift interior(N[$n], :, 1, :)\nPₙ = @lift interior(P[$n], :, 1, :)\n\nfig = Figure(resolution = (1000, 520), fontsize = 20)\n\ntitle = @lift \"t = $(prettytime(times[$n]))\"\nLabel(fig[0, :], title)\n\naxis_kwargs = (xlabel = \"x (m)\", ylabel = \"z (m)\", width = 770, yticks = [-400, -200, 0])\nax1 = Axis(fig[1, 1]; title = \"Temperature (°C)\", axis_kwargs...)\nax2 = Axis(fig[2, 1]; title = \"Nutrients concentration (mmol N / m³)\",axis_kwargs...)\nax3 = Axis(fig[3, 1]; title = \"Phytoplankton concentration (mmol N / m³)\", axis_kwargs...)\n\nhm1 = heatmap!(ax1, xc, zc, Tₙ, colorrange = T_lims, colormap = Reverse(:lajolla), interpolate = true)\nhm2 = heatmap!(ax2, xc, zc, Nₙ, colorrange = N_lims, colormap = Reverse(:bamako), interpolate = true)\nhm3 = heatmap!(ax3, xc, zc, Pₙ, colorrange = P_lims, colormap = Reverse(:bamako), interpolate = true)\n\nColorbar(fig[1, 2], hm1, ticks = [8.95, 9.0, 9.05])\nColorbar(fig[2, 2], hm2, ticks = [0, 2, 4])\nColorbar(fig[3, 2], hm3, ticks = [0.01, 0.02, 0.03])\n\nrowgap!(fig.layout, 0)\n\nrecord(fig, \"buoyancy_front.mp4\", 1:length(times)) do i\n    n[] = i\nend\n\nnothing #hide","category":"page"},{"location":"","page":"Home","title":"Home","text":"(Image: buoyancy_front)","category":"page"},{"location":"","page":"Home","title":"Home","text":"In the example above, OceanBioME.jl provides the biogeochemistry and everything else is taken care of by Oceananigans.jl. For comprehensive documentation of the physics modelling see Oceananigans' Documentation; for biogeochemistry and other features we provide read below.","category":"page"},{"location":"#Places-to-find-OceanBioME-information","page":"Home","title":"Places to find OceanBioME information","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"This documentation, which provides\ndocumented examples (browse them starting, e.g., from the single-column model),\nexplanations of model implementation methods,\ndetails of currently implemented models, and\na library documenting all user-facing objects and functions.\nDiscussions on the OceanBioME github\nIf you've got a question or something to talk about, don't hesitate to start a new discussion!\nIssues and pull requests also contain lots of information about problems we've found, solutions we're trying to implement, and ideas for the future.","category":"page"},{"location":"#Getting-in-touch","page":"Home","title":"Getting in touch","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"Whether you need help getting started with OceanBioME, found a bug, want OceanBioME to be more expanded, or just want to chat about our project, you can:","category":"page"},{"location":"","page":"Home","title":"Home","text":"Start a discussion. \nOpen an issue. Issues are best if you think the OceanBioME source code needs attention: a bug, a sign error, an important missing feature, or a typo in the documentation.","category":"page"},{"location":"#Citing","page":"Home","title":"Citing","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"If you use OceanBioME as part of your research, teaching, or other activities, we would be grateful if you could cite our work and mention OceanBioME by name, as well as citing and acknowledging Oceananigans as without them this package would not be possible.","category":"page"},{"location":"","page":"Home","title":"Home","text":"We do not currently have a citation for OceanBioME so please reach out if you wish to cite it, and we will expedite the process of making it citable.","category":"page"},{"location":"#Funding","page":"Home","title":"Funding","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"OceanBioME.jl is supported through grants from the Center for Climate Repair at Cambridge and the Gordon and Betty Moore Foundation.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"EditURL = \"../../../examples/eady.jl\"","category":"page"},{"location":"generated/eady/#Biogeochemistry-in-submesoscale-eddies-in-the-Eady-model","page":"Baroclinic instability","title":"Biogeochemistry in submesoscale eddies in the Eady model","text":"","category":"section"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"In this example we setup a 3D model with a constant background buoyancy gradient with associated thermal wind (the Eady model) with the LOBSTER biogeochemical model. This demonstrates how to use biogeochemistry in a more complicated physical model. The parameters in this example correspond roughly to those used by Taylor (2016) and lead to the generation of a single submesoscale eddy.","category":"page"},{"location":"generated/eady/#Install-dependencies","page":"Baroclinic instability","title":"Install dependencies","text":"","category":"section"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"First we ensure we have the required dependencies installed","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"using Pkg\npkg \"add OceanBioME, Oceananigans, CairoMakie\"","category":"page"},{"location":"generated/eady/#Model-setup","page":"Baroclinic instability","title":"Model setup","text":"","category":"section"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"We load the required packages. Although not required, we also set the random seed to ensure reproducibility of the results.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"using OceanBioME, Oceananigans, Printf\nusing Oceananigans.Units\nusing Random\n\nRandom.seed!(11)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Random.TaskLocalRNG()","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Construct a grid with uniform grid spacing.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"grid = RectilinearGrid(size = (32, 32, 8), extent = (1kilometer, 1kilometer, 100meters))","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"32×32×8 RectilinearGrid{Float64, Oceananigans.Grids.Periodic, Oceananigans.Grids.Periodic, Oceananigans.Grids.Bounded} on Oceananigans.Architectures.CPU with 3×3×3 halo\n├── Periodic x ∈ [0.0, 1000.0) regularly spaced with Δx=31.25\n├── Periodic y ∈ [0.0, 1000.0) regularly spaced with Δy=31.25\n└── Bounded  z ∈ [-100.0, 0.0] regularly spaced with Δz=12.5","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Set the Coriolis parameter.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"coriolis = FPlane(f = 1e-4) # [s⁻¹]","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"FPlane{Float64}(f=0.0001)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Specify parameters that are used to construct the background state.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"background_state_parameters = ( M = 1e-4,       # s⁻¹, geostrophic shear\n                                f = coriolis.f, # s⁻¹, Coriolis parameter\n                                N = 1e-4,       # s⁻¹, buoyancy frequency\n                                H = grid.Lz )","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"(M = 0.0001, f = 0.0001, N = 0.0001, H = 100.0)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"We assume a background buoyancy B with a constant stratification and also a constant lateral gradient (in the zonal direction). The background velocity components U and V are prescribed so that the thermal wind relationship is satisfied, that is, f partial_z U = - partial_y B and f partial_z V = partial_x B.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"B(x, y, z, t, p) = p.M^2 * x + p.N^2 * (z + p.H)\nV(x, y, z, t, p) = p.M^2 / p.f * (z + p.H)\n\nV_field = BackgroundField(V, parameters = background_state_parameters)\nB_field = BackgroundField(B, parameters = background_state_parameters)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"BackgroundField{typeof(Main.var\"##296\".B), NamedTuple{(:M, :f, :N, :H), NTuple{4, Float64}}}\n├── func: B (generic function with 1 method)\n└── parameters: (M = 0.0001, f = 0.0001, N = 0.0001, H = 100.0)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Specify some horizontal and vertical viscosity and diffusivity.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"νᵥ = κᵥ = 1e-4 # [m² s⁻¹]\nvertical_diffusivity = VerticalScalarDiffusivity(ν = νᵥ, κ = κᵥ)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"VerticalScalarDiffusivity{ExplicitTimeDiscretization}(ν=0.0001, κ=0.0001)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Setup the biogeochemical model with optional carbonate chemistry turned on.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"biogeochemistry = LOBSTER(; grid,\n                            carbonates = true,\n                            open_bottom = true)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Lodyc-DAMTP Ocean Biogeochemical Simulation Tools for Ecosystem and Resources (LOBSTER) model (Float64) \n Light Attenuation Model: \n    └── Two-band light attenuation model (Float64)\n Optional components:\n    ├── Carbonates ✅ \n    ├── Oxygen ❌ \n    └── Variable Redfield Ratio ❌\n Sinking Velocities:\n    ├── sPOM: 0.0 to -3.47e-5 m/s \n    └── bPOM: 0.0 to -0.0023148148148148147 m/s","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"To-do: change to a buoyancy parameterisation so we don't have to fake the temperature and salinity.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"DIC_bcs = FieldBoundaryConditions(top = GasExchange(; gas = :CO₂, temperature = (args...) -> 12, salinity = (args...) -> 35))","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Oceananigans.FieldBoundaryConditions, with boundary conditions\n├── west: DefaultBoundaryCondition (FluxBoundaryCondition: Nothing)\n├── east: DefaultBoundaryCondition (FluxBoundaryCondition: Nothing)\n├── south: DefaultBoundaryCondition (FluxBoundaryCondition: Nothing)\n├── north: DefaultBoundaryCondition (FluxBoundaryCondition: Nothing)\n├── bottom: DefaultBoundaryCondition (FluxBoundaryCondition: Nothing)\n├── top: FluxBoundaryCondition: ContinuousBoundaryFunction gasexchange_function at (Nothing, Nothing, Nothing)\n└── immersed: DefaultBoundaryCondition (FluxBoundaryCondition: Nothing)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Model instantiation","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"model = NonhydrostaticModel(; grid,\n                              biogeochemistry,\n                              boundary_conditions = (DIC = DIC_bcs, ),\n                              advection = WENO(grid),\n                              timestepper = :RungeKutta3,\n                              coriolis,\n                              tracers = :b,\n                              buoyancy = BuoyancyTracer(),\n                              background_fields = (b = B_field, v = V_field),\n                              closure = vertical_diffusivity)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"NonhydrostaticModel{CPU, RectilinearGrid}(time = 0 seconds, iteration = 0)\n├── grid: 32×32×8 RectilinearGrid{Float64, Oceananigans.Grids.Periodic, Oceananigans.Grids.Periodic, Oceananigans.Grids.Bounded} on Oceananigans.Architectures.CPU with 3×3×3 halo\n├── timestepper: RungeKutta3TimeStepper\n├── tracers: (b, NO₃, NH₄, P, Z, sPOM, bPOM, DOM, DIC, Alk)\n├── closure: VerticalScalarDiffusivity{ExplicitTimeDiscretization}(ν=0.0001, κ=(b=0.0001, NO₃=0.0001, NH₄=0.0001, P=0.0001, Z=0.0001, sPOM=0.0001, bPOM=0.0001, DOM=0.0001, DIC=0.0001, Alk=0.0001))\n├── buoyancy: Oceananigans.BuoyancyModels.BuoyancyTracer with ĝ = NegativeZDirection()\n└── coriolis: FPlane{Float64}(f=0.0001)","category":"page"},{"location":"generated/eady/#Initial-conditions","page":"Baroclinic instability","title":"Initial conditions","text":"","category":"section"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Start with a bit of random noise added to the background thermal wind and an arbitary biogeochemical state.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Ξ(z) = randn() * z / grid.Lz * (z / grid.Lz + 1)\n\nŨ = 1e-3\nuᵢ(x, y, z) = Ũ * Ξ(z)\nvᵢ(x, y, z) = Ũ * Ξ(z)\n\nset!(model, u=uᵢ, v=vᵢ, P = 0.03, Z = 0.03, NO₃ = 4.0, NH₄ = 0.05, DIC = 2200.0, Alk = 2409.0)\n\nsimulation = Simulation(model, Δt = 15minutes, stop_time = 10days)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Simulation of NonhydrostaticModel{CPU, RectilinearGrid}(time = 0 seconds, iteration = 0)\n├── Next time step: 15 minutes\n├── Elapsed wall time: 0 seconds\n├── Wall time per iteration: NaN days\n├── Stop time: 10 days\n├── Stop iteration : Inf\n├── Wall time limit: Inf\n├── Callbacks: OrderedDict with 4 entries:\n│   ├── stop_time_exceeded => Callback of stop_time_exceeded on IterationInterval(1)\n│   ├── stop_iteration_exceeded => Callback of stop_iteration_exceeded on IterationInterval(1)\n│   ├── wall_time_limit_exceeded => Callback of wall_time_limit_exceeded on IterationInterval(1)\n│   └── nan_checker => Callback of NaNChecker for u on IterationInterval(100)\n├── Output writers: OrderedDict with no entries\n└── Diagnostics: OrderedDict with no entries","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Adapt the time step while keeping the CFL number fixed.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"wizard = TimeStepWizard(cfl = 0.75, diffusive_cfl = 0.75, max_Δt = 30minutes)\nsimulation.callbacks[:wizard] = Callback(wizard, IterationInterval(5))","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Create a progress message.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"progress(sim) = @printf(\"i: % 6d, sim time: % 10s, wall time: % 10s, Δt: % 10s, CFL: %.2e\\n\",\n                        sim.model.clock.iteration,\n                        prettytime(sim.model.clock.time),\n                        prettytime(sim.run_wall_time),\n                        prettytime(sim.Δt),\n                        AdvectiveCFL(sim.Δt)(sim.model))\n\nsimulation.callbacks[:progress] = Callback(progress, IterationInterval(20))","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Callback of progress on IterationInterval(20)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Here, we add some diagnostics to calculate and output.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"u, v, w = model.velocities # unpack velocity `Field`s","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"NamedTuple with 3 Fields on 32×32×8 RectilinearGrid{Float64, Oceananigans.Grids.Periodic, Oceananigans.Grids.Periodic, Oceananigans.Grids.Bounded} on Oceananigans.Architectures.CPU with 3×3×3 halo:\n├── u: 32×32×8 Field{Oceananigans.Grids.Face, Oceananigans.Grids.Center, Oceananigans.Grids.Center} on Oceananigans.Grids.RectilinearGrid on Oceananigans.Architectures.CPU\n├── v: 32×32×8 Field{Oceananigans.Grids.Center, Oceananigans.Grids.Face, Oceananigans.Grids.Center} on Oceananigans.Grids.RectilinearGrid on Oceananigans.Architectures.CPU\n└── w: 32×32×9 Field{Oceananigans.Grids.Center, Oceananigans.Grids.Center, Oceananigans.Grids.Face} on Oceananigans.Grids.RectilinearGrid on Oceananigans.Architectures.CPU","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"and also calculate the vertical vorticity.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"ζ = Field(∂x(v) - ∂y(u))","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"32×32×8 Field{Oceananigans.Grids.Face, Oceananigans.Grids.Face, Oceananigans.Grids.Center} on Oceananigans.Grids.RectilinearGrid on Oceananigans.Architectures.CPU\n├── grid: 32×32×8 RectilinearGrid{Float64, Oceananigans.Grids.Periodic, Oceananigans.Grids.Periodic, Oceananigans.Grids.Bounded} on Oceananigans.Architectures.CPU with 3×3×3 halo\n├── boundary conditions: FieldBoundaryConditions\n│   └── west: Periodic, east: Periodic, south: Periodic, north: Periodic, bottom: ZeroFlux, top: ZeroFlux, immersed: ZeroFlux\n├── operand: BinaryOperation at (Face, Face, Center)\n├── status: time=0.0\n└── data: 38×38×14 OffsetArray(::Array{Float64, 3}, -2:35, -2:35, -2:11) with eltype Float64 with indices -2:35×-2:35×-2:11\n    └── max=0.0, min=0.0, mean=0.0","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Periodically save the velocities and vorticity to a file.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"simulation.output_writers[:fields] = JLD2OutputWriter(model, merge(model.tracers, (; u, v, w, ζ));\n                                                      schedule = TimeInterval(2hours),\n                                                      filename = \"eady_turbulence_bgc\",\n                                                      overwrite_existing = true)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"JLD2OutputWriter scheduled on TimeInterval(2 hours):\n├── filepath: ./eady_turbulence_bgc.jld2\n├── 14 outputs: (b, NO₃, NH₄, P, Z, sPOM, bPOM, DOM, DIC, Alk, u, v, w, ζ)\n├── array type: Array{Float64}\n├── including: [:grid, :coriolis, :buoyancy, :closure]\n└── max filesize: Inf YiB","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Prevent the tracer values going negative - this is especially important in this model while no positivity preserving diffusion is implemented.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"scale_negative_tracers = ScaleNegativeTracers(; model, tracers = (:NO₃, :NH₄, :P, :Z, :sPOM, :bPOM, :DOM))\nsimulation.callbacks[:neg] = Callback(scale_negative_tracers; callsite = UpdateStateCallsite())\nsimulation.callbacks[:nan_tendencies] = Callback(remove_NaN_tendencies!; callsite = TendencyCallsite())\nsimulation.callbacks[:abort_zeros] = Callback(zero_negative_tracers!; callsite = UpdateStateCallsite())","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Run the simulation","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"run!(simulation)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"[ Info: Initializing simulation...\ni:      0, sim time:  0 seconds, wall time:  0 seconds, Δt: 16.500 minutes, CFL: 4.52e-02\n[ Info:     ... simulation initialization complete (12.509 seconds)\n[ Info: Executing initial time step...\n[ Info:     ... initial time step complete (1.340 minutes).\ni:     20, sim time: 5.830 hours, wall time: 1.632 minutes, Δt: 24.158 minutes, CFL: 3.90e-02\ni:     40, sim time:   14 hours, wall time: 1.726 minutes, Δt: 30 minutes, CFL: 5.78e-02\ni:     60, sim time:      1 day, wall time: 1.818 minutes, Δt: 30 minutes, CFL: 6.93e-02\ni:     80, sim time: 1.417 days, wall time: 1.910 minutes, Δt: 30 minutes, CFL: 1.02e-01\ni:    100, sim time: 1.833 days, wall time: 2.004 minutes, Δt: 30 minutes, CFL: 1.43e-01\ni:    120, sim time: 2.250 days, wall time: 2.098 minutes, Δt: 30 minutes, CFL: 2.17e-01\ni:    140, sim time: 2.667 days, wall time: 2.192 minutes, Δt: 30 minutes, CFL: 3.80e-01\ni:    160, sim time: 3.083 days, wall time: 2.286 minutes, Δt: 30 minutes, CFL: 5.82e-01\ni:    180, sim time: 3.455 days, wall time: 2.379 minutes, Δt: 26.422 minutes, CFL: 7.50e-01\ni:    200, sim time: 3.783 days, wall time: 2.472 minutes, Δt: 23.404 minutes, CFL: 7.50e-01\ni:    220, sim time: 4.046 days, wall time: 2.565 minutes, Δt: 20.732 minutes, CFL: 7.50e-01\ni:    240, sim time: 4.300 days, wall time: 2.659 minutes, Δt: 17.876 minutes, CFL: 7.50e-01\ni:    260, sim time: 4.539 days, wall time: 2.753 minutes, Δt: 18.450 minutes, CFL: 7.50e-01\ni:    280, sim time: 4.761 days, wall time: 2.849 minutes, Δt: 15.808 minutes, CFL: 7.50e-01\ni:    300, sim time: 4.970 days, wall time: 2.949 minutes, Δt: 16.001 minutes, CFL: 7.50e-01\ni:    320, sim time: 5.167 days, wall time: 3.043 minutes, Δt: 13.527 minutes, CFL: 7.50e-01\ni:    340, sim time: 5.353 days, wall time: 3.136 minutes, Δt: 13.905 minutes, CFL: 7.50e-01\ni:    360, sim time: 5.540 days, wall time: 3.229 minutes, Δt: 14.082 minutes, CFL: 7.50e-01\ni:    380, sim time: 5.720 days, wall time: 3.321 minutes, Δt: 12.236 minutes, CFL: 7.50e-01\ni:    400, sim time: 5.872 days, wall time: 3.411 minutes, Δt: 10.799 minutes, CFL: 7.50e-01\ni:    420, sim time: 6.015 days, wall time: 3.503 minutes, Δt: 10.437 minutes, CFL: 7.50e-01\ni:    440, sim time: 6.154 days, wall time: 3.594 minutes, Δt: 10.061 minutes, CFL: 7.50e-01\ni:    460, sim time: 6.296 days, wall time: 3.684 minutes, Δt: 11.495 minutes, CFL: 7.50e-01\ni:    480, sim time: 6.449 days, wall time: 3.775 minutes, Δt: 11.665 minutes, CFL: 7.50e-01\ni:    500, sim time: 6.601 days, wall time: 3.866 minutes, Δt: 12.989 minutes, CFL: 7.50e-01\ni:    520, sim time: 6.778 days, wall time: 3.958 minutes, Δt: 13.345 minutes, CFL: 7.50e-01\ni:    540, sim time: 6.954 days, wall time: 4.049 minutes, Δt: 13.964 minutes, CFL: 7.50e-01\ni:    560, sim time: 7.141 days, wall time: 4.141 minutes, Δt: 13.883 minutes, CFL: 7.50e-01\ni:    580, sim time: 7.322 days, wall time: 4.233 minutes, Δt: 12.687 minutes, CFL: 7.50e-01\ni:    600, sim time: 7.487 days, wall time: 4.326 minutes, Δt: 12.613 minutes, CFL: 7.50e-01\ni:    620, sim time: 7.649 days, wall time: 4.421 minutes, Δt: 11.427 minutes, CFL: 7.50e-01\ni:    640, sim time: 7.795 days, wall time: 4.514 minutes, Δt: 10.751 minutes, CFL: 7.50e-01\ni:    660, sim time: 7.932 days, wall time: 4.607 minutes, Δt: 10.772 minutes, CFL: 7.50e-01\ni:    680, sim time: 8.076 days, wall time: 4.701 minutes, Δt: 11.252 minutes, CFL: 7.50e-01\ni:    700, sim time: 8.220 days, wall time: 4.797 minutes, Δt: 11.129 minutes, CFL: 7.50e-01\ni:    720, sim time: 8.374 days, wall time: 4.889 minutes, Δt: 11.818 minutes, CFL: 7.50e-01\ni:    740, sim time: 8.526 days, wall time: 4.982 minutes, Δt: 12.761 minutes, CFL: 7.50e-01\ni:    760, sim time: 8.694 days, wall time: 5.075 minutes, Δt: 12.486 minutes, CFL: 7.50e-01\ni:    780, sim time: 8.850 days, wall time: 5.168 minutes, Δt: 11.845 minutes, CFL: 7.50e-01\ni:    800, sim time:     9 days, wall time: 5.261 minutes, Δt: 13.210 minutes, CFL: 7.50e-01\ni:    820, sim time: 9.176 days, wall time: 5.354 minutes, Δt: 13.758 minutes, CFL: 7.50e-01\ni:    840, sim time: 9.352 days, wall time: 5.447 minutes, Δt: 12.991 minutes, CFL: 7.50e-01\ni:    860, sim time: 9.519 days, wall time: 5.542 minutes, Δt: 13.226 minutes, CFL: 7.50e-01\ni:    880, sim time: 9.676 days, wall time: 5.635 minutes, Δt: 13.033 minutes, CFL: 7.50e-01\ni:    900, sim time: 9.842 days, wall time: 5.727 minutes, Δt: 12.677 minutes, CFL: 7.50e-01\n[ Info: Simulation is stopping after running for 5.815 minutes.\n[ Info: Simulation time 10 days equals or exceeds stop time 10 days.\n","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"Now load the saved output,","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"  ζ = FieldTimeSeries(\"eady_turbulence_bgc.jld2\", \"ζ\")\n  P = FieldTimeSeries(\"eady_turbulence_bgc.jld2\", \"P\")\nNO₃ = FieldTimeSeries(\"eady_turbulence_bgc.jld2\", \"NO₃\")\nNH₄ = FieldTimeSeries(\"eady_turbulence_bgc.jld2\", \"NH₄\")\nDIC = FieldTimeSeries(\"eady_turbulence_bgc.jld2\", \"DIC\")\n\ntimes = ζ.times\n\nxζ, yζ, zζ = nodes(ζ)\nxc, yc, zc = nodes(P)","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"([15.625, 46.875, 78.125, 109.375, 140.625, 171.875, 203.125, 234.375, 265.625, 296.875, 328.125, 359.375, 390.625, 421.875, 453.125, 484.375, 515.625, 546.875, 578.125, 609.375, 640.625, 671.875, 703.125, 734.375, 765.625, 796.875, 828.125, 859.375, 890.625, 921.875, 953.125, 984.375], [15.625, 46.875, 78.125, 109.375, 140.625, 171.875, 203.125, 234.375, 265.625, 296.875, 328.125, 359.375, 390.625, 421.875, 453.125, 484.375, 515.625, 546.875, 578.125, 609.375, 640.625, 671.875, 703.125, 734.375, 765.625, 796.875, 828.125, 859.375, 890.625, 921.875, 953.125, 984.375], [-93.75, -81.25, -68.75, -56.25, -43.75, -31.25, -18.75, -6.25])","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"and plot.","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"using CairoMakie\n\nn = Observable(1)\n\n  ζₙ = @lift interior(  ζ[$n], :, :, grid.Nz)\n  Nₙ = @lift interior(NO₃[$n], :, :, grid.Nz) .+ interior(NH₄[$n], :, :, grid.Nz)\n  Pₙ = @lift interior(  P[$n], :, :, grid.Nz)\nDICₙ = @lift interior(DIC[$n], :, :, grid.Nz)\n\nfig = Figure(resolution = (1600, 1600), fontsize = 20)\n\nlims = [(minimum(T), maximum(T)) for T in (  ζ[:, :, grid.Nz, :],\n                                           NO₃[:, :, grid.Nz, :] .+ NH₄[:, :, grid.Nz, :],\n                                             P[:, :, grid.Nz, :],\n                                           DIC[:, :, grid.Nz, :])]\n\naxis_kwargs = (xlabel = \"x (m)\", ylabel = \"y (m)\", aspect = DataAspect())\n\nax1 = Axis(fig[1, 1]; title = \"Vertical vorticity (1 / s)\", axis_kwargs...)\nhm1 = heatmap!(ax1, xζ, yζ, ζₙ, colormap = :balance, colorrange = lims[1])\nColorbar(fig[1, 2], hm1)\n\nax2 = Axis(fig[1, 3]; title = \"Nutrient (NO₃ + NH₄) concentration (mmol N / m³)\", axis_kwargs...)\nhm2 = heatmap!(ax2, xc, yc, Nₙ, colormap = Reverse(:bamako), colorrange = lims[2])\nColorbar(fig[1, 4], hm2)\n\nax3 = Axis(fig[2, 1]; title = \"Phytoplankton concentration (mmol N / m³)\", axis_kwargs...)\nhm3 = heatmap!(ax3, xc, yc, Pₙ, colormap = Reverse(:batlow), colorrange = lims[3])\nColorbar(fig[2, 2], hm3)\n\nax4 = Axis(fig[2, 3]; title = \"Dissolved inorganic carbon (mmol C / m³)\", axis_kwargs...)\nhm4 = heatmap!(ax4, xc, yc, DICₙ, colormap = Reverse(:devon), colorrange = lims[4])\nColorbar(fig[2, 4], hm4)\n\ntitle = @lift \"t = $(prettytime(times[$n]))\"\nLabel(fig[0, :], title, fontsize = 30)\n\nrecord(fig, \"eady.mp4\", 1:length(times), framerate = 12) do i\n    n[] = i\nend","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"(Image: )","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"","category":"page"},{"location":"generated/eady/","page":"Baroclinic instability","title":"Baroclinic instability","text":"This page was generated using Literate.jl.","category":"page"}]
}
